<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Laundromat Investment Calculator</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js" defer></script>

<style>
:root{
  --bg:#0a1022; --panel:#0e1834; --ink:#e9f0ff; --muted:#a7b8d6; --line:#22345a;
  --good:#22c55e; --warn:#f59e0b; --bad:#ef4444; --accent:#60a5fa
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; background:linear-gradient(180deg,#0a1022,#091226 60%);
  color:var(--ink); font-family:ui-sans-serif,system-ui,Inter,Segoe UI,Roboto,Arial
}
header{padding:18px 14px 10px; text-align:center}
header h1{margin:0; font-size:clamp(20px,3.3vw,30px)}
header p{margin:8px auto 0; max-width:1100px; color:var(--muted); font-size:13.5px}
.wrap{max-width:1440px; margin:0 auto; padding:14px 14px 38px}
.grid{display:grid; gap:12px}
@media(min-width:1240px){ .grid{grid-template-columns:1.05fr .95fr} }

.card{
  background:linear-gradient(180deg,#101b39,#0c152e);
  border:1px solid var(--line); border-radius:18px; padding:14px;
  box-shadow:0 10px 28px rgba(0,0,0,.25)
}
.card h2,.card h3{margin:0 0 8px; font-size:18px}
.sub{font-size:12px; color:var(--muted); margin:2px 0 10px}
.row{display:grid; grid-template-columns:1fr 170px; gap:8px; align-items:center; margin:8px 0}
.row label{font-size:12px; color:var(--muted)}
input[type="number"], select{
  width:100%; padding:8px; border-radius:10px; border:1px solid #2a3f6e;
  background:#0c1730; color:var(--ink)
}
.switch{display:flex; gap:8px; align-items:center; flex-wrap:wrap}
.btns{display:flex; gap:8px; flex-wrap:wrap}
button{
  border:1px solid #2b3f6a; background:#0e1a36; color:var(--ink);
  padding:8px 12px; border-radius:10px; cursor:pointer
}
button:hover{filter:brightness(1.08)}
.accent{border-color:#3b82f6; background:#0a1a33}
.ghost{background:transparent}
.group{border-top:1px dashed #26406d; margin-top:12px; padding-top:12px}

.kpis{display:grid; grid-template-columns:repeat(3,1fr); gap:8px}
@media(max-width:900px){ .kpis{grid-template-columns:repeat(2,1fr)} }
.kpi{
  border:1px solid var(--line); border-radius:14px; padding:12px;
  background:linear-gradient(180deg,#0e1a37,#0c152d)
}
.kpi h4{margin:0; color:var(--muted); font-size:12px}
.kpi .v{margin-top:6px; font-size:19px}
.good .v{color:var(--good)} .warn .v{color:var(--warn)} .bad .v{color:var(--bad)}

table{width:100%; border-collapse:collapse; font-size:13px; margin-top:8px}
th,td{border-bottom:1px solid #223353; padding:7px; text-align:right}
th:first-child,td:first-child{text-align:left}
.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace}
.hint{color:var(--muted); font-size:12px}
.pill{display:inline-block; border:1px solid #2b3f6a; border-radius:999px; padding:3px 8px; font-size:11px; color:#bcd0ea}
.stick{position:sticky; top:8px}

canvas{background:#0a1530; border:1px solid #1a2a4a; border-radius:14px; padding:6px; width:100%; height:100%}
.warnbox{border:1px dashed #7c5200; background:#2a1f0a; color:#ffd37a; border-radius:10px; padding:8px; margin-top:6px; font-size:12px}
.insightbox{border:1px solid #22c55e; background:#0a2a1a; color:#90d690; border-radius:10px; padding:8px; margin-top:6px; font-size:12px}
details{border:1px solid #2b3f6a; border-radius:10px; padding:8px; background:#0a1530}
summary{cursor:pointer; color:#cfe0ff}
.hr{height:1px; background:#223353; margin:8px 0}
#helpPanel{display:none}

/* Utility classes */
.good{color:var(--good)} .warn{color:var(--warn)} .bad{color:var(--bad)}
.accuracy-note{background:#1a2a4a; border-radius:8px; padding:6px; margin-top:8px; font-size:11px; color:#a7b8d6}
</style>
</head>
<body>
<header>
  <h1>Laundromat Investment Calculator</h1>
  <p>Corrected calculations with 60√ó NOI valuation, realistic equipment costs, proper vending revenue handling, and accurate debt service. Now includes accuracy estimates and National City CA market data.</p>
</header>

<div class="wrap">
  <div class="grid">
    <!-- LEFT: INPUTS -->
    <section class="card">
      <div class="switch">
        <span class="pill">Mode</span>
        <select id="mode" onchange="applyMode()">
          <option value="market" selected>Market Mode (editable)</option>
          <option value="book">Book Mode (Industry standards)</option>
        </select>

        <span class="pill">Authority</span>
        <select id="authority" onchange="compute()">
          <option value="machines" selected>Lock Machines ‚Üí Size Footprint</option>
          <option value="footprint">Lock Footprint ‚Üí Suggest Machines</option>
        </select>

        <button class="ghost" onclick="toggleHelp()">Help / User Manual</button>
      </div>

      <div id="helpPanel" class="group">
        <details open><summary>Industry Methodology - Corrected Calculator</summary>
  <div class="sub"><strong>Key Fixes Applied:</strong> Fixed vending double-counting, proper down payment debt reduction, realistic energy consumption, maintenance on base revenue, expanded optimum down search.</div>
  <div class="hr"></div>
  <div class="sub"><strong>Industry Standards:</strong> 60√ó monthly NOI valuation (~20% yield), 20%+ Cash-on-Cash targets, retool lifts 25-35%, branding lifts 15-50%, washer life 12-14y, maintenance rises after 9y.</div>
  <div class="hr"></div>
  <div class="sub"><strong>Expected Accuracy:</strong> With real seller data: ¬±10-15% on Year-1 EBITDA, ¬±5-10% on DSCR/ROI. With book averages only: ¬±20-25%. Always verify with seller P&L, utility bills, and equipment inspection.</div>
</details>

<details><summary>Inputs Guide ‚Äî what to enter (and what it means)</summary>
  <div class="sub"><strong>Market & Timeline</strong></div>
  <ul class="hint" style="margin:6px 0 10px 18px; line-height:1.4">
    <li><span class="mono">Market Preset</span>: sets starting utility/rent/wage assumptions. Switch to <span class="mono">Custom</span> if you have real bills/quotes.</li>
    <li><span class="mono">Ownership Horizon</span>: used for multi-year projections and exit analysis.</li>
    <li><span class="mono">Days Open / Month</span>: usually 30; use 28‚Äì31 if seasonal/limited hours.</li>
  </ul>

  <div class="sub"><strong>Equipment Mix & Performance</strong></div>
  <ul class="hint" style="margin:6px 0 10px 18px; line-height:1.4">
    <li><span class="mono">Count</span>, <span class="mono">Vend $</span>, <span class="mono">Turns/Day</span>: these are the biggest revenue drivers. Prefer seller meter pulls / card system exports.</li>
    <li><span class="mono">kWh / Therms / Gallons</span>: per-cycle utilities. If unknown, keep defaults; override with equipment specs or utility audits.</li>
    <li><span class="mono">Age</span>: drives downtime risk, replacement reserves, lender caution, and exit value (older banks compress valuation).</li>
  </ul>

  <div class="sub"><strong>Utilities & Services</strong></div>
  <ul class="hint" style="margin:6px 0 10px 18px; line-height:1.4">
    <li><span class="mono">Electric $/kWh, Gas $/therm, Water+Sewer $/gal</span>: use effective rates from the last 12 months of bills (total cost √∑ total units).</li>
    <li><span class="mono">Wash & Fold $/lb</span> and <span class="mono">lbs/day</span>: enter only if you actually run W&amp;F; this is added revenue and labor/utility load implicitly.</li>
    <li><span class="mono">Vending Revenue (GROSS)</span> + <span class="mono">Vending COGS %</span>: revenue is gross; COGS becomes an expense (no double counting).</li>
    <li><span class="mono">Hot water</span> (share, ŒîT, efficiency): estimates gas to heat washer water. You‚Äôll see a ‚ÄúHot water ‚Ä¶ $/mo‚Äù readout below the inputs.</li>
  </ul>

  <div class="sub"><strong>Operating Expenses</strong></div>
  <ul class="hint" style="margin:6px 0 10px 18px; line-height:1.4">
    <li><span class="mono">Rent + CAM</span>: include CAM if it‚Äôs predictable; if CAM is variable, reflect that in risk (HERO/ZERO ‚Üí Lease Risk).</li>
    <li><span class="mono">Labor hours/day</span> √ó <span class="mono">wage</span>: includes owner coverage if the owner is working the store.</li>
    <li><span class="mono">Maintenance %</span>: applies to base revenue; <span class="mono">Age penalty</span> kicks in for machines ‚â•9 years.</li>
    <li><span class="mono">Retool/Brand budgets</span>: if <span class="mono">Apply lifts</span>=1, revenue can lift and utilities can improve by the efficiency % inputs.</li>
  </ul>

  <div class="sub"><strong>Project Cost Builder & Financing</strong></div>
  <ul class="hint" style="margin:6px 0 10px 18px; line-height:1.4">
    <li><span class="mono">Project Cost</span> auto-calculates equipment + install + buildout + soft costs + working capital (optionally includes retool/branding).</li>
    <li><span class="mono">Cash Down Payment</span>: reduces debt (corrected). Use <span class="mono">Find Optimum Down</span> to hit a DSCR target.</li>
    <li><span class="mono">Tranche A/B</span>: sets max leverage and loan terms used for debt service and DSCR.</li>
  </ul>

  <div class="sub"><strong>HERO / ZERO Underwriting</strong></div>
  <ul class="hint" style="margin:6px 0 2px 18px; line-height:1.4">
    <li>These inputs reflect real buyer/lender deal-killers: lease runway, location durability, competition density, revenue quality, and owner dependency.</li>
  </ul>
</details>

<details><summary>Outputs Guide ‚Äî what the model returns (how to read it)</summary>
  <ul class="hint" style="margin:6px 0 10px 18px; line-height:1.4">
    <li><strong>Revenue Breakdown (Monthly)</strong>: washer + dryer + W&amp;F + vending gross (with COGS shown as expense).</li>
    <li><strong>P&amp;L Summary (Year 1)</strong>: gross revenue, operating expenses, EBITDA/NOI, and key ratios.</li>
    <li><strong>DSCR</strong>: lender safety metric = NOI (or EBITDA proxy) √∑ annual debt service. Higher is safer; banks often want ‚â•1.25.</li>
    <li><strong>Cash-on-Cash</strong>: annual pre-tax cash flow √∑ cash invested. Screening target often ‚â•20% for laundromats.</li>
    <li><strong>Valuation</strong>: uses an industry multiple (default ~60√ó monthly NOI) and compresses with equipment age risk.</li>
    <li><strong>HERO / ZERO Banner</strong>: shows deal status + ‚Äúdeal killers‚Äù (lease/exit/operational traps) and what to fix.</li>
    <li><strong>Stress Test</strong>: shows DSCR sensitivity to revenue/rent/utilities shocks.</li>
    <li><strong>Monte Carlo</strong>: probability distribution of outcomes given volatility assumptions; complements (does not replace) lease/exit constraints.</li>
    <li><strong>Market Intelligence</strong>: Market Position grade, Competitive Score, and <strong>Risk Assessment</strong> (kept consistent with the Committee / Mr. Accountant logic).</li>
  </ul>

  <div class="warnbox" style="margin-top:10px">
    <strong>Best practice:</strong> Replace ‚Äúbook‚Äù assumptions with (1) trailing 12-month P&amp;L, (2) utility bills, (3) lease abstract, and (4) equipment inspection.
  </div>
</details>
      </div>

      <!-- Locale & Horizon -->
      <div class="group">
        <h3>Market & Timeline</h3>
<div class="group" style="margin-top:10px; padding-top:10px; border-top:1px dashed rgba(148,163,184,0.25);">
          <h3 style="margin:0 0 6px 0;">Auto Market (US) ‚Äî City + ZIP</h3>
          <div class="sub">Optional. Enter City/State/ZIP and click Auto-fill to update renter concentration, trade-area renters, pricing power proxy, and competition proxy from public U.S. Census datasets. Canada: manual for now.</div>
          <div class="row"><label>City</label><input id="autoCity" type="text" placeholder="e.g., National City" value=""></div>
          <div class="row"><label>State (2-letter)</label><input id="autoState" type="text" placeholder="CA" maxlength="2" value=""></div>
          <div class="row"><label>ZIP Code</label><input id="autoZip" type="text" placeholder="91950" maxlength="10" value=""></div>
          <div class="row"><label></label><button class="btn" id="autoFillBtn" type="button" style="cursor:pointer" onclick="(function(){var s=document.getElementById('autoMarketStatus'); if(s){s.textContent='Clicked‚Ä¶';}var st=document.getElementById('autoMarketStep'); if(st){st.textContent='Clicked';}var b=document.getElementById('autoMarketBar'); if(b){b.style.width='3%';}})(); try {   if (typeof window.autoFillUSMarket === 'function') {     window.autoFillUSMarket();   } else if (typeof autoFillUSMarket === 'function') {     autoFillUSMarket();   } else {     var s=document.getElementById('autoMarketStatus'); if(s){s.textContent='Error: autoFillUSMarket not defined (script not loaded)';}     var st=document.getElementById('autoMarketStep'); if(st){st.textContent='Failed';}     var b=document.getElementById('autoMarketBar'); if(b){b.style.width='0%';}   } } catch(e) {   var s=document.getElementById('autoMarketStatus'); if(s){s.textContent='Error running Auto-fill: ' + (e && (e.message||e.toString()));}   var st=document.getElementById('autoMarketStep'); if(st){st.textContent='Failed';}   var b=document.getElementById('autoMarketBar'); if(b){b.style.width='0%';} }">Auto-fill from Census</button></div>
          <div class="hint" id="autoMarketStatus">Not run yet.</div>
          <div style="margin-top:6px">
            <div style="height:8px; width:100%; background:rgba(148,163,184,0.18); border-radius:999px; overflow:hidden;">
              <div id="autoMarketBar" style="height:8px; width:0%; background:rgba(147,197,253,0.85); transition:width 180ms ease;"></div>
            </div>
            <div class="hint" id="autoMarketStep" style="margin-top:4px; font-size:11px;">Idle.</div>
          </div>
        </div>

        <div class="row"><label>Ownership Horizon (years)</label><input id="horizon" type="number" value="10" min="1" onchange="deferredCompute()"></div>
        <div class="row"><label>Days Open / Month</label><input id="days" type="number" value="30" min="1" onchange="deferredCompute()"></div>
      </div>

      <!-- Equipment -->
      <div class="group">
        <h3>Equipment Mix & Performance</h3>
        <div class="sub">Counts, vend pricing, turns/day, utilities per cycle (corrected to realistic levels), and age for maintenance.</div>
        <table id="washTbl">
          <thead><tr><th>Washer Type</th><th>Count</th><th>Vend $</th><th>Turns/Day</th><th>Cycle Min</th><th>kWh</th><th>Therms</th><th>Gallons</th><th>Age</th></tr></thead>
          <tbody></tbody>
        </table>
        <table id="dryTbl" style="margin-top:8px">
          <thead><tr><th>Dryer Type</th><th>Count</th><th>$/Min</th><th>Avg Min</th><th>Cycles/Day</th><th>kWh</th><th>Therms</th><th>Age</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="btns" style="margin-top:8px">
          <button onclick="sizeFootprintFromUnits()">Size Footprint</button>
          <button onclick="suggestUnits()">Suggest Machines</button>
          <button class="ghost" onclick="optimizeMix()">Optimize Mix</button>
          <button class="ghost" onclick="resetEquipmentDefaults()">Restore defaults</button>
        </div>
      </div>

      <!-- Space Constraints -->
      <div class="group">
        <h3>Space & Parking Constraints</h3>
        <div class="row"><label>Total Floor Space (sq ft)</label><input id="totalSqft" type="number" value="2500" onchange="deferredCompute()"></div>
        <div class="row"><label>Sq ft per Washer</label><input id="sqftWasher" type="number" value="28" onchange="deferredCompute()"></div>
        <div class="row"><label>Sq ft per Dryer</label><input id="sqftDryer" type="number" value="22" onchange="deferredCompute()"></div>
        <div class="row"><label>Parking Stalls</label><input id="stalls" type="number" value="16" onchange="deferredCompute()"></div>
        <div class="row"><label>Max Machines per Stall</label><input id="machinesPerStall" type="number" value="3" onchange="deferredCompute()"></div>
        <div id="constraintNote" class="warnbox"></div>
      </div>

      <!-- Utility Rates -->
      <div class="group">
        <h3>Utility Rates & Services</h3>
        <div class="row"><label>Electricity $/kWh</label><input id="rateElec" type="number" value="0.32" step="0.01" onchange="deferredCompute()"></div>
        <div class="row"><label>Natural Gas $/therm</label><input id="rateGas" type="number" value="1.80" step="0.01" onchange="deferredCompute()"></div>
        <div class="row"><label>Water+Sewer $/gallon</label><input id="rateWater" type="number" value="0.018" step="0.001" onchange="deferredCompute()"></div>
        <div class="row"><label>Wash & Fold $/lb</label><input id="wfoldPrice" type="number" value="1.90" step="0.05" onchange="deferredCompute()"></div>
        <div class="row"><label>Wash & Fold lbs/day</label><input id="wfoldLbs" type="number" value="180" onchange="deferredCompute()"></div>
        <div class="row"><label>Vending Revenue/month (GROSS)</label><input id="vendRev" type="number" value="1200" onchange="deferredCompute()"></div>
        <div class="row"><label>Vending COGS %</label><input id="vendCogsPct" type="number" value="40" onchange="deferredCompute()"></div>
        
        <div class="sub" style="margin-top:10px">Hot Water Heating (for washers)</div>
        <div class="row"><label>Hot water share of washer gallons (%)</label><input id="hotSharePct" type="number" value="60" onchange="deferredCompute()"></div>
        <div class="row"><label>Hot water ŒîT (¬∞F)</label><input id="deltaT" type="number" value="65" onchange="deferredCompute()"></div>
        <div class="row"><label>Water heater efficiency (%)</label><input id="heaterEffPct" type="number" value="80" onchange="deferredCompute()"></div>
        <div id="hotWaterCostDisplay" style="font-size:11px; color:#60a5fa; margin-top:4px;"></div>
      </div>

      <!-- Operating Expenses -->
      <div class="group">
        <h3>Operating Expenses & Efficiency</h3>
        <div class="row"><label>Monthly Rent + CAM</label><input id="rent" type="number" value="9500" onchange="deferredCompute()"></div>
        <div class="row"><label>Labor hours/day</label><input id="laborHrsDay" type="number" value="12" onchange="deferredCompute()"></div>
        <div class="row"><label>Hourly wage + burden</label><input id="wage" type="number" value="22" onchange="deferredCompute()"></div>
        <div class="row"><label>Maintenance base % of base revenue</label><input id="maintBasePct" type="number" value="8" onchange="deferredCompute()"></div>
        <div class="row"><label>Age penalty % (‚â•9 years)</label><input id="maintAgeUpliftPct" type="number" value="3" onchange="deferredCompute()"></div>
        <div class="row"><label>Retool Budget ($)</label><input id="retoolBudget" type="number" value="65000" onchange="deferredCompute()"></div>
        <div class="row"><label>Branding Budget ($)</label><input id="brandBudget" type="number" value="35000" onchange="deferredCompute()"></div>
        <div class="row"><label>Apply revenue lifts (0/1)</label><input id="applyLifts" type="number" value="1" min="0" max="1" onchange="deferredCompute()"></div>
        <div class="row"><label>Washer useful life (years)</label><input id="lifeWasher" type="number" value="13" onchange="deferredCompute()"></div>
        <div class="row"><label>Dryer useful life (years)</label><input id="lifeDryer" type="number" value="17" onchange="deferredCompute()"></div>
        <div class="row"><label>Retool efficiency ‚Äî Elec %‚Üì</label><input id="effElecPct" type="number" value="8" onchange="deferredCompute()"></div>
        <div class="row"><label>Retool efficiency ‚Äî Gas %‚Üì</label><input id="effGasPct" type="number" value="12" onchange="deferredCompute()"></div>
        <div class="row"><label>Retool efficiency ‚Äî Water %‚Üì</label><input id="effWaterPct" type="number" value="15" onchange="deferredCompute()"></div>
        
        <div class="sub" style="margin-top:10px">Escalation Rates</div>
        <div class="row"><label>Revenue growth %/yr</label><input id="revGrowPct" type="number" value="2.5" step="0.1" onchange="deferredCompute()"></div>
        <div class="row"><label>OpEx inflation %/yr</label><input id="opexInflPct" type="number" value="3.0" step="0.1" onchange="deferredCompute()"></div>
      </div>

      <!-- Project Cost Builder -->
      <div class="group">
        <h3>Project Cost Builder</h3>
        <div class="sub">Updated to 2024 equipment prices and realistic build-out costs.</div>
        <table id="equipCostTbl">
          <thead><tr><th>Equipment Type</th><th>Per-Unit Cost ($)</th></tr></thead>
          <tbody></tbody>
        </table>
        <div class="row"><label>Install & Hookup % of equip</label><input id="installPct" type="number" value="25" onchange="deferredCompute()"></div>
        <div class="row"><label>Build-out $/sq ft</label><input id="buildoutPerSqft" type="number" value="110" onchange="deferredCompute()"></div>
        <div class="row"><label>Permits & Fees (lump)</label><input id="permitFees" type="number" value="8500" onchange="deferredCompute()"></div>
        <div class="row"><label>Sewer connection per washer</label><input id="sewerPerWasher" type="number" value="1200" onchange="deferredCompute()"></div>
        <div class="row"><label>Soft costs % of hard costs</label><input id="softPct" type="number" value="15" onchange="deferredCompute()"></div>
        <div class="row"><label>Working capital ($)</label><input id="workingCap" type="number" value="25000" onchange="deferredCompute()"></div>
        <div class="row"><label>Include retool+branding in project</label><input id="includeLiftsInProject" type="number" value="1" min="0" max="1" onchange="deferredCompute()"></div>
        <div id="projectCostBreak" class="sub mono"></div>
      </div>

      <!-- Financing -->
      <div class="group">
        <h3>Financing (Fixed: Down Payment Reduces Debt)</h3>
        <div class="row"><label>Total Project Cost ($)</label><input id="projCost" type="number" value="0" readonly></div>
        <div class="row"><label>Cash Down Payment ($)</label><input id="cashInv" type="number" value="0" onchange="deferredCompute()"></div>
        
        <div class="sub" style="margin-top:8px">Senior Loan ‚Äî Tranche A</div>
        <div class="row"><label>A Max % of Project</label><input id="aPct" type="number" value="65" onchange="deferredCompute()"></div>
        <div class="row"><label>A Rate (APR %)</label><input id="aRate" type="number" value="7.25" onchange="deferredCompute()"></div>
        <div class="row"><label>A Term (yrs)</label><input id="aTerm" type="number" value="20" onchange="deferredCompute()"></div>
        
        <div class="sub" style="margin-top:8px">Mezzanine ‚Äî Tranche B</div>
        <div class="row"><label>B Max % of Project</label><input id="bPct" type="number" value="15" onchange="deferredCompute()"></div>
        <div class="row"><label>B Rate (APR %)</label><input id="bRate" type="number" value="9.50" onchange="deferredCompute()"></div>
        <div class="row"><label>B Term (yrs)</label><input id="bTerm" type="number" value="15" onchange="deferredCompute()"></div>
        
        <div class="row"><label>Target DSCR for optimization</label><input id="targetDSCR" type="number" value="1.25" step="0.01" onchange="deferredCompute()"></div>
        <div class="btns" style="margin-top:8px">
          <button class="ghost" onclick="applyZeroDown()">Zero-Down SBA preset</button>
          <button class="accent" onclick="findOptimumDown()">Find Optimum Down</button>
        </div>
        <div id="optDownNote" class="hint"></div>
      </div>

      
      <!-- Tax Settings -->
      <div class="group">
        <h3>Tax Settings</h3>
        <div class="sub">Federal and state tax calculations for after-tax returns</div>
        <div class="row"><label>Federal Tax Rate (%)</label><input id="fedTaxRate" type="number" value="21" step="0.1" onchange="deferredCompute()"></div>
        <div class="row"><label>State Tax Rate (%)</label><input id="stateTaxRate" type="number" value="8.84" step="0.1" onchange="deferredCompute()"></div>
        <div class="row"><label>Depreciation Method</label>
          <select id="depreciationMethod" onchange="deferredCompute()">
            <option value="macrs" selected>MACRS (Modified Accelerated)</option>
            <option value="straight_line">Straight Line</option>
          </select>
        </div>
        <div class="row"><label>Equipment Life (Tax, years)</label><input id="taxEquipLife" type="number" value="7" onchange="deferredCompute()"></div>
        <div class="row"><label>Building Life (Tax, years)</label><input id="taxBuildingLife" type="number" value="39" onchange="deferredCompute()"></div>
        <div class="row"><label>Entity Type</label>
          <select id="entityType" onchange="deferredCompute()">
            <option value="llc" selected>LLC (Pass-through)</option>
            <option value="corp">Corporation</option>
            <option value="scorp">S-Corporation</option>
          </select>
        </div>
      </div>

      <!-- HERO / ZERO UNDERWRITING INPUTS -->
      <div class="group">
        <h3>Hero / Zero Underwriting Inputs</h3>
        <div class="sub">These are the real-world deal drivers most pro buyers underwrite in addition to cash flow.</div>

        <details open>
          <summary>Lease Risk</summary>
          <div class="row"><label>Lease years remaining</label><input id="leaseYears" type="number" value="20" min="0" onchange="deferredCompute()"></div>
          <div class="row"><label>Renewal option(s) in lease (0/1)</label><input id="leaseRenewal" type="number" value="1" min="0" max="1" onchange="deferredCompute()"></div>
          <div class="row"><label>Annual rent escalation %</label><input id="rentEscPct" type="number" value="3.0" step="0.1" onchange="deferredCompute()"></div>
          <div class="row"><label>CAM controlled/limited (0/1)</label><input id="camControl" type="number" value="0" min="0" max="1" onchange="deferredCompute()"></div>
        </details>

        <details style="margin-top:8px" open>
<summary>Location Elasticity</summary>
          <div class="row"><label>Location elasticity score (0‚Äì10)</label><input id="locElastic" type="number" value="6" min="0" max="10" step="1" onchange="deferredCompute()"></div>
          <div class="row"><label>Renter concentration score (0‚Äì10)</label><input id="renterScore" type="number" value="7" min="0" max="10" step="1" onchange="deferredCompute()"></div>
          <div class="row"><label>Pricing power score (0‚Äì10)</label><input id="pricingPower" type="number" value="6" min="0" max="10" step="1" onchange="deferredCompute()"></div>
        </details>

        <details style="margin-top:8px" open>
          <summary>Competition</summary>
          <div class="row"><label># of competing laundromats in trade area</label><input id="competitors" type="number" value="3" min="0" onchange="deferredCompute()"></div>
          <div class="row"><label>Renter households in trade area</label><input id="renterHH" type="number" value="6000" min="0" onchange="deferredCompute()"></div>
        </details>

        <details style="margin-top:8px" open>
          <summary>Revenue Quality</summary>
          <div class="sub">Enter shares as percentages (they don't have to sum perfectly; the model will normalize).</div>
          <div class="row"><label>Coin / anonymous share %</label><input id="revCoinPct" type="number" value="60" min="0" max="100" onchange="deferredCompute()"></div>
          <div class="row"><label>Card/App share %</label><input id="revAppPct" type="number" value="10" min="0" max="100" onchange="deferredCompute()"></div>
          <div class="row"><label>Wash & Fold share %</label><input id="revWfPct" type="number" value="25" min="0" max="100" onchange="deferredCompute()"></div>
          <div class="row"><label>Commercial/Subscription share %</label><input id="revCommPct" type="number" value="5" min="0" max="100" onchange="deferredCompute()"></div>
        </details>

        <details style="margin-top:8px" open>
          <summary>Owner Dependency</summary>
          <div class="row"><label>Owner dependency score (0‚Äì10, higher = worse)</label><input id="ownerDep" type="number" value="4" min="0" max="10" step="1" onchange="deferredCompute()"></div>
        </details>
      </div>

<!-- Controls -->
      <div class="group">
        <div class="btns">
          <button class="accent" onclick="compute()">Compute All</button>
          <button class="ghost" onclick="exportJSON()">Export JSON</button>
          <button class="ghost" onclick="importJSON()">Import JSON</button>
          <button onclick="generatePrintReport()" style="background:#059669;color:white;margin-left:8px">üñ®Ô∏è Print Report</button>
        </div>
      </div>
    </section>

    <!-- RIGHT: RESULTS -->
    <section class="card stick">
      <div class="switch">
        <h2 style="margin-right:auto">Investment Analysis</h2>
        <span class="pill" id="modeBadge">Market</span>
      </div>

      <!-- KPIs -->
      <div id="kpis" class="kpis"></div>

      <!-- HERO / ZERO Banner -->
      <div id="heroZeroBanner" class="warnbox" style="margin-top:12px; border-style:solid; border-width:1px; display:block">
        <div style="display:flex; align-items:center; gap:10px; flex-wrap:wrap">
          <span class="pill">HERO / ZERO</span>
          <strong id="hzLabel">‚Äî</strong>
          <span class="pill">Score</span>
          <span class="mono" id="hzScore">‚Äî</span>
          <span class="pill">Deal Status</span>
          <span id="hzStatus">‚Äî</span>
        </div>
        <div class="hr"></div>
        <div id="hzDealKillers" style="font-size:12px"></div>
        <div id="hzWhy" style="font-size:12px; margin-top:8px"></div>
        <details style="margin-top:10px">
          <summary>Exit Buyer Fit</summary>
          <div id="hzExitFit" style="font-size:12px; margin-top:8px"></div>
        </details>
      </div>


      <!-- Investment Insight -->
      <div id="chuckPostInsight" class="insightbox">
        <strong>üí° Investment Insight:</strong> 
        <span id="insightText">Complete inputs to see investment analysis</span>
      </div>

      <!-- Accuracy Disclaimer -->
      <div class="accuracy-note">
        <strong>Expected Accuracy:</strong> Year-1 NOI/EBITDA: ¬±10-15% with seller P&L + 12 months utility bills. 
        DSCR/Cash-on-Cash: ¬±5-10%. 5-10 year projections: ¬±20-25%. Always verify with actual seller documents.
      </div>

      <!-- 5-Minute Checklist -->
      <div class="checklist-note" style="background:#f8f9fa;border-left:4px solid #007bff;padding:12px;margin:12px 0;font-size:0.9em">
        <strong>5-Minute Checklist Before Making Offer:</strong><br>
        ‚úì Replace utility rates with last 12 months' actual effective rates<br>
        ‚úì Set turns/day from meter pulls or revenue logs, not book averages<br>  
        ‚úì Update build-out $/sq ft with contractor ROM + 10-15% contingency<br>
        ‚úì Verify equipment quotes (especially 60-80lb washers and stacks)<br>
        ‚úì Run "Find Optimum Down" to hit DSCR ‚â•1.25 and check price ‚âà 60√ó monthly NOI
      </div>

      <!-- Revenue Breakdown -->
      <div class="group">
        <h3>Revenue Breakdown (Monthly)</h3>
        <table id="revTbl"></table>
      </div>

      <!-- P&L Summary -->
      <div class="group">
        <h3>P&L Summary (Year 1)</h3>
        <table id="plTbl"></table>
      </div>

      <!-- Multi-year Projections -->
      <div class="group">
        <h3>Multi-Year Projections</h3>
        <div class="sub"><span id="projectionYearsText">10</span>-year P&L, cash flow, and equipment lifecycle analysis.</div>
        <table id="plYears"></table>
        <div class="hr"></div>
        <table id="cfYears"></table>
        <div class="hr"></div>
        <table id="bsYears"></table>
        <div class="sub" style="margin-top:8px">
          <strong>Note:</strong> Balance sheet values are <em>approximate</em> using industry rules of thumb: 
          7%/yr depreciation, ~70% of debt service as principal. For high-level screening only‚Äînot for accounting.
        </div>
      </div>

      <!-- Charts -->
      <div class="group">
        <h3>Investment Analysis Charts</h3>
        <div style="height:200px;margin:12px 0; background:#0a1530; border-radius:8px; padding:8px">
          <canvas id="roiChart" style="width:100%; height:100%"></canvas>
        </div>
        <div style="height:240px;margin:12px 0; background:#0a1530; border-radius:8px; padding:8px">
          <canvas id="cashFlowChart" style="width:100%; height:100%"></canvas>
        </div>
        <div style="height:200px;margin:12px 0; background:#0a1530; border-radius:8px; padding:8px">
          <canvas id="dscrChart" style="width:100%; height:100%"></canvas>
        </div>
        <div style="height:200px;margin:12px 0; background:#0a1530; border-radius:8px; padding:8px">
          <canvas id="utilitiesChart" style="width:100%; height:100%"></canvas>
        </div>
        <div class="hint" id="chartHint"></div>
      </div>

      <!-- Stress Test Analysis -->
      <div class="group">
        <h3>üîß Stress Test Analysis</h3>
        <div class="sub">Test business resilience by adjusting key variables and observe DSCR impact</div>
        
        <div class="row">
          <label>Revenue stress (% change)</label>
          <input id="revenueStress" type="number" value="0" min="-50" max="50" step="5" onchange="runStressTest()">
        </div>
        <div class="row">
          <label>Rent stress (% increase)</label>
          <input id="rentStress" type="number" value="0" min="0" max="100" step="5" onchange="runStressTest()">
        </div>
        <div class="row">
          <label>Utility stress (% increase)</label>
          <input id="utilityStress" type="number" value="0" min="0" max="100" step="5" onchange="runStressTest()">
        </div>
        
        <div class="btns" style="margin-top:8px">
          <button onclick="runCommonStressTests()">Common Tests</button>
          <button onclick="resetStressTest()">Reset</button>
        </div>
        
        <div id="stressResults" class="group"></div>
      </div>

      <!-- Market Intelligence & Benchmarking -->
      <div class="group">
        <h3>üìä Market Intelligence & Benchmarking</h3>
        <div class="sub">Compare your investment against industry benchmarks and market standards</div>
        
        <div class="kpis">
          <div class="kpi" id="marketBenchmark">
            <h4>Market Position</h4>
            <div class="v" id="marketRating">-</div>
            <div class="hint" id="marketHint">Loading...</div>
          </div>
          <div class="kpi" id="competitiveBenchmark">
            <h4>Competitive Score</h4>
            <div class="v" id="compScore">-</div>
            <div class="hint" id="compHint">vs. market avg</div>
          </div>
          <div class="kpi" id="riskBenchmark">
            <h4>Risk Assessment</h4>
            <div class="v" id="riskScore">-</div>
            <div class="hint" id="riskHint">composite risk</div>
          </div>
        </div>
        
        <div id="benchmarkDetails" class="group"></div>
      </div>

      <!-- Deal Structure Optimization -->
      <div class="group">
        <h3>üîß Deal Structure Optimization</h3>
        <div class="sub">Optimize financing structure and identify negotiation opportunities</div>
        
        <div class="btns">
          <button onclick="optimizeDownPayment()">Optimize Down Payment</button>
          <button onclick="analyzeNegotiationPoints()">Find Negotiation Points</button>
          <button onclick="compareFinancingOptions()">Compare Financing</button>
        </div>
        
        <div id="optimizationResults" class="group"></div>
      </div>

      <!-- Exit Strategy Analysis -->
      <div class="group">
        <h3>üö™ Exit Strategy Analysis</h3>
        <div class="sub">Analyze potential exit scenarios and long-term value creation</div>
        
        <div class="row">
          <label>Target exit year</label>
          <input id="exitYear" type="number" value="7" min="1" max="15" onchange="analyzeExitScenarios()">
        </div>
        <div class="row">
          <label>Expected cap rate at exit (%)</label>
          <input id="exitCapRate" type="number" value="7.5" step="0.1" min="5" max="12" onchange="analyzeExitScenarios()">
        </div>
        
        <div id="exitAnalysis" class="group"></div>
      </div>

      <!-- Monte Carlo Risk Analysis -->
      <div class="group">
        <h3>üé≤ Monte Carlo Risk Analysis</h3>
        <div class="sub">Advanced probabilistic modeling to quantify investment uncertainty and risk scenarios</div>
        
        <div class="row">
          <label>Revenue volatility (%)</label>
          <input id="revenueVolatility" type="number" value="15" min="5" max="40" step="1">
        </div>
        <div class="row">
          <label>Expense volatility (%)</label>
          <input id="expenseVolatility" type="number" value="10" min="5" max="30" step="1">
        </div>
        <div class="row">
          <label>Simulation iterations</label>
          <input id="monteCarloIterations" type="number" value="1000" min="500" max="5000" step="500">
        </div>
        
        <div class="btns">
          <button onclick="runMonteCarloSim(); setTimeout(() => { try { updateRiskAfterMonteCarlo(); } catch(e) { console.error('Risk update error:', e); } }, 500);">Run Monte Carlo Analysis</button>
          <button onclick="exportMonteCarloResults()">Export Risk Report</button>
        </div>
        
        <div id="monteCarloResults" class="group"></div>
        <div style="display:flex; gap:10px; margin-top:10px">
          <div style="flex:1; height:200px; background:#0a1530; border-radius:8px; padding:8px">
            <canvas id="roiDistributionChart" style="width:100%; height:100%"></canvas>
          </div>
          <div style="flex:1; height:200px; background:#0a1530; border-radius:8px; padding:8px">
            <canvas id="riskScenarioChart" style="width:100%; height:100%"></canvas>
          </div>
        </div>
      </div>

      <!-- Mr. Accountant Financial Analysis -->
      <div class="group">
        <h3>üíº Mr. Accountant Says...</h3>
        <div id="accountantAnalysis" class="insightbox" style="background:#0f1a2e; border:1px solid #4a90e2; color:#a8c5e9">
          <div id="accountantText">Complete your inputs to see my detailed financial analysis...</div>
        </div>
        
        <details open style="margin-top:8px">
          <summary style="color:#4a90e2; cursor:pointer">üìä Detailed Financial Health Metrics</summary>
          <div id="healthMetrics" style="margin-top:8px; font-size:12px; color:#a8c5e9"></div>
        </details>

        <details open style="margin-top:10px">
          <summary style="color:#4a90e2; cursor:pointer">üßë‚Äç‚öñÔ∏è Committee Verdict (Mr. Accountant + Advisors)</summary>
          <div class="group" style="margin-top:8px">
            <div class="row" style="align-items:flex-start">
              <div style="flex:1">
                <div style="display:flex; align-items:center; gap:8px">
                  <strong>üé© Mr. Accountant (Final Authority)</strong>
                  <span class="help-icon" data-help="accountant-final">?</span>
                </div>
                <div id="acctFinal" class="mono" style="margin-top:6px; white-space:pre-wrap"></div>
              </div>
              <div style="flex:1">
                <div style="display:flex; align-items:center; gap:8px">
                  <strong>üè¶ Mr. Lender (Financeability)</strong>
                  <span class="help-icon" data-help="lender-opinion">?</span>
                </div>
                <div id="lenderOpinion" class="mono" style="margin-top:6px; white-space:pre-wrap"></div>
              </div>
            </div>
            <div class="row" style="align-items:flex-start; margin-top:10px">
              <div style="flex:1">
                <div style="display:flex; align-items:center; gap:8px">
                  <strong>üèõÔ∏è Mr. Institutional Buyer (Exit & Capital Risk)</strong>
                  <span class="help-icon" data-help="institutional-opinion">?</span>
                </div>
                <div id="instOpinion" class="mono" style="margin-top:6px; white-space:pre-wrap"></div>
              </div>
              <div style="flex:1">
                <div style="display:flex; align-items:center; gap:8px">
                  <strong>üîé Why / What to Fix</strong>
                  <span class="help-icon" data-help="why-what-to-fix">?</span>
                </div>
                <div id="whyFix" class="mono" style="margin-top:6px; white-space:pre-wrap"></div>
              </div>
            </div>
          </div>
        </details>
      </div>
    </section>
  </div>
</div>

<script>

/* ====================================
   RUNTIME SHIMS (no-jQuery)
   - Provides $() selector helper
   - Provides element.val getter/setter (jQuery-like)
   - Provides deferredCompute() debounce
   ==================================== */
(function(){
  // Minimal $ helper:
  //  - $(fn) => DOMContentLoaded
  //  - $("css") => first matching element
  //  - $(el) => element passthrough
  window.$ = function(arg){
    if (typeof arg === "function") {
      if (document.readyState === "loading") document.addEventListener("DOMContentLoaded", arg);
      else arg();
      return;
    }
    if (arg === document) {
      return { ready: (fn)=> window.$(fn) };
    }
    if (typeof arg === "string") return document.querySelector(arg);
    return arg; // element passthrough
  };
  window.$$ = function(sel){ return Array.from(document.querySelectorAll(sel)); };

  // jQuery-like .val property (your code reads $("#id").val)
  if (!Object.getOwnPropertyDescriptor(Element.prototype, "val")) {
    Object.defineProperty(Element.prototype, "val", {
      get: function(){
        // For inputs/selects/textareas use .value; else fallback to textContent
        if ("value" in this) return this.value;
        return (this.textContent ?? "").trim();
      },
      set: function(v){
        if ("value" in this) this.value = v;
        else this.textContent = v;
      }
    });
  }

  // Debounced compute for onchange handlers
  let _dcTimer = null;
  window.deferredCompute = function(){
    clearTimeout(_dcTimer);
    _dcTimer = setTimeout(function(){
      try { if (typeof compute === "function") compute(); } catch(e){ console.error(e); }
    }, 50);
  };
})();
/* ====================================
   LAUNDROMAT INVESTMENT CALCULATOR
   ==================================== */

// Equipment definitions - FIXED: Set washer therms=0 to avoid double-counting with hot-water heating
let washerDefs = [
  { name:"20lb Top-Load", count:8, vend:3.25, turns:2.2, mins:28, kwh:0.4, therms:0, gals:20, age:5 },
  { name:"27lb Top-Load", count:6, vend:4.25, turns:2.3, mins:32, kwh:0.5, therms:0, gals:25, age:4 },
  { name:"40lb Front-Load", count:4, vend:6.00, turns:2.0, mins:35, kwh:0.3, therms:0, gals:35, age:3 },
  { name:"60lb Front-Load", count:2, vend:8.50, turns:1.8, mins:40, kwh:0.4, therms:0, gals:50, age:2 },
  { name:"80lb Front-Load", count:2, vend:11.00, turns:1.6, mins:45, kwh:0.6, therms:0, gals:70, age:1 }
];

let dryerDefs = [
  { name:"Stack Dryer", count:12, pricePerMin:0.25, avgMins:35, cycles:3.8, kwh:0.3, therms:0.35, age:3 },
  { name:"Single Dryer", count:6, pricePerMin:0.25, avgMins:45, cycles:3.4, kwh:0.4, therms:0.25, age:4 }
];

// UPDATED equipment costs to 2024 realistic pricing - Conservative estimates (MAJOR FIX)
let equipCosts = {
  "20lb Top-Load": 4500,
  "27lb Top-Load": 5200,
  "40lb Front-Load": 12000,
  "60lb Front-Load": 20000,
  "80lb Front-Load": 28000,
  "Stack Dryer": 9000,
  "Single Dryer": 12000
};

// Keep a deep copy of factory defaults so we can restore them later
window._initialWasherDefs = JSON.parse(JSON.stringify(washerDefs));
window._initialDryerDefs = JSON.parse(JSON.stringify(dryerDefs));
window._initialEquipCosts = JSON.parse(JSON.stringify(equipCosts));

// Regional market presets with National City CA as default
const localePresets = {
  national_city: { elec:0.32, gas:1.80, water:0.018, wage:22, rent:9500, laborHrs:12, vendRev:1200, wfoldPrice:1.90, wfoldLbs:180 },
  los_angeles_ca: { elec:0.28, gas:1.65, water:0.012, wage:25, rent:12800, laborHrs:10, vendRev:1400, wfoldPrice:2.20, wfoldLbs:320 },
  phoenix_az: { elec:0.14, gas:1.20, water:0.006, wage:19, rent:7200, laborHrs:7, vendRev:950, wfoldPrice:1.70, wfoldLbs:180 },
  houston_tx: { elec:0.12, gas:0.95, water:0.007, wage:20, rent:6800, laborHrs:8, vendRev:1050, wfoldPrice:1.60, wfoldLbs:220 },
  miami_fl: { elec:0.18, gas:1.45, water:0.009, wage:21, rent:8900, laborHrs:8, vendRev:1150, wfoldPrice:1.85, wfoldLbs:280 },
  nyc_ny: { elec:0.22, gas:1.95, water:0.014, wage:28, rent:18500, laborHrs:12, vendRev:1800, wfoldPrice:2.50, wfoldLbs:420 }
};

// Utility functions
// DOM helpers: accept either CSS selectors (e.g., '#id', '.class') or bare element ids (e.g., 'id')
const $ = (sel, root=document) => {
  if (typeof sel !== 'string') return null;
  const s = sel.trim();
  if (!s) return null;
  const looksCss = s.startsWith('#') || s.startsWith('.') || s.startsWith('[') || s.includes(' ') || s.includes('>') || s.includes(':');
  if (looksCss) return root.querySelector(s);
  const elById = document.getElementById(s);
  if (elById) return elById;
  const esc = (window.CSS && CSS.escape) ? CSS.escape(s) : s.replace(/[^a-zA-Z0-9_-]/g, '\$&');
  return root.querySelector('#' + esc);
};
const $$ = (sel, root=document) => {
  if (typeof sel !== 'string') return [];
  const s = sel.trim();
  if (!s) return [];
  const looksCss = s.startsWith('#') || s.startsWith('.') || s.startsWith('[') || s.includes(' ') || s.includes('>') || s.includes(':');
  if (looksCss) return Array.from(root.querySelectorAll(s));
  const elById = document.getElementById(s);
  return elById ? [elById] : [];
};
// ===== Tax & Depreciation Helpers (Injected) =====

// MACRS depreciation schedule (7-year property)
const macrsSchedule7Year = [0.1429, 0.2449, 0.1749, 0.1249, 0.0893, 0.0892, 0.0893, 0.0446];

function calculateDepreciation(costBasis, method, life, year) {
  if (method === 'macrs' && life === 7) {
    return (year >= 1 && year <= macrsSchedule7Year.length) ? costBasis * macrsSchedule7Year[year - 1] : 0;
  }
  // Straight line fallback
  return year <= life ? costBasis / life : 0;
}

function calculateTaxes(ebitdaAnnual, depreciationAnnual, interestAnnual, fedRatePct, stateRatePct, entityType) {
  const taxableIncome = ebitdaAnnual - depreciationAnnual - interestAnnual;
  if (taxableIncome <= 0) {
    return { fedTax: 0, stateTax: 0, totalTax: 0, afterTaxIncome: ebitdaAnnual - interestAnnual, taxableIncome };
  }
  const fedTax = taxableIncome * (fedRatePct / 100);
  const stateTax = taxableIncome * (stateRatePct / 100);
  const totalTax = fedTax + stateTax;
  const afterTaxIncome = ebitdaAnnual - interestAnnual - totalTax;
  return { fedTax, stateTax, totalTax, afterTaxIncome, taxableIncome };
}
// ================================================
const money = n => isNaN(n) ? "-" : n.toLocaleString(undefined,{style:"currency",currency:"USD",maximumFractionDigits:0});

// PMT calculation for loans
function pmt(rate, nper, pv) {
  if (rate === 0) return -(pv / nper);
  return -(pv * rate) / (1 - Math.pow(1 + rate, -nper));
}

// Investment Calculation Engine
class LaundryCalculator {
  static calculateEquipmentRevenue(washers, dryers, daysPerMonth) {
    let washRev = 0;
    washers.forEach(w => {
      washRev += w.count * w.vend * w.turns * daysPerMonth;
    });
    
    let dryRev = 0;
    dryers.forEach(d => {
      dryRev += d.count * d.pricePerMin * d.avgMins * d.cycles * daysPerMonth;
    });
    
    return { washRev, dryRev, total: washRev + dryRev };
  }
  
  static calculateUtilityCosts(washers, dryers, rates, daysPerMonth, effFactors = {}) {
    const effE = 1 - (effFactors.elec || 0);
    const effG = 1 - (effFactors.gas || 0);
    const effW = 1 - (effFactors.water || 0);
    
    let elec = 0, gas = 0, water = 0;
    
    washers.forEach(w => {
      const cycles = w.count * w.turns * daysPerMonth;
      elec += cycles * w.kwh * rates.elec * effE;
      gas += cycles * w.therms * rates.gas * effG;
      water += cycles * w.gals * rates.water * effW;
    });
    
    dryers.forEach(d => {
      const cycles = d.count * d.cycles * daysPerMonth;
      elec += cycles * d.kwh * rates.elec * effE;
      gas += cycles * d.therms * rates.gas * effG;
    });
    
    return { elec, gas, water, total: elec + gas + water };
  }
  
  // FIXED: Maintenance based on base revenue with proportional age uplift
  static calculateMaintenanceCosts(baseRevenue, basePct, ageUpliftPct, washers, dryers) {
    const baseMaint = baseRevenue * basePct / 100;
    let totalUnits = 0, oldUnits = 0;
    
    washers.forEach(w => { totalUnits += w.count; if (w.age >= 9) oldUnits += w.count; });
    dryers.forEach(d => { totalUnits += d.count; if (d.age >= 9) oldUnits += d.count; });

    const ageShare = totalUnits ? oldUnits / totalUnits : 0;
    const ageAdj = baseRevenue * (ageUpliftPct / 100) * ageShare; // proportional
    return baseMaint + ageAdj;
  }
  
  static calculateIndustryLifts(baseRevenue, retoolBudget, brandBudget) {
    // More conservative lift calculations - industry methodology
    const retoolLiftPct = Math.min(retoolBudget / 1000 * 0.25, 20); // Max 20% lift from retool (reduced)
    const brandLiftPct = Math.min(brandBudget / 1000 * 0.5, 12);    // Max 12% lift from branding (reduced)
    
    // Cap total lift at 30% to prevent runaway scenarios (reduced from 40%)
    const totalLiftPct = Math.min(retoolLiftPct + brandLiftPct, 30);
    const actualRetoolPct = totalLiftPct > 30 ? retoolLiftPct * (30 / (retoolLiftPct + brandLiftPct)) : retoolLiftPct;
    const actualBrandPct = totalLiftPct > 30 ? brandLiftPct * (30 / (retoolLiftPct + brandLiftPct)) : brandLiftPct;
    
    const retoolLift = baseRevenue * actualRetoolPct / 100;
    const brandLift = baseRevenue * actualBrandPct / 100;
    const totalLift = retoolLift + brandLift;
    
    return { retoolLift, brandLift, totalLift, retoolLiftPct: actualRetoolPct, brandLiftPct: actualBrandPct };
  }
}

// ---------------------------
// Age-based Risk Adjustments
// ---------------------------
// Auto-adjusts revenue, utilities, reserves, stress DSCR, and valuation multiple based on weighted average equipment age.
/* ---------- AGE RISK MODEL (nonlinear, uncapped tail) ----------
   Purpose: make equipment ages > ~12 years increasingly punitive,
   so extreme inputs (e.g., 20+ years) correctly show distressed risk.
*/
function calcAgeRisk(washers, dryers) {
  let totalUnits = 0;
  let ageSum = 0;
  let oldest = 0;

  const add = (count, age) => {
    const c = +count || 0;
    const a = +age || 0;
    totalUnits += c;
    ageSum += c * a;
    if (c > 0) oldest = Math.max(oldest, a);
  };

  washers.forEach(w => add(w.count, w.age));
  dryers.forEach(d => add(d.count, d.age));

  const avgAge = totalUnits ? (ageSum / totalUnits) : 0;

  // Severity curve: mild up to ~6, steeper 10-15, then nonlinear tail.
  const baseSeverity = (() => {
    if (avgAge <= 6) return 0;
    if (avgAge <= 10) return (avgAge - 6) * 0.08;                 // 0 .. 0.32
    if (avgAge <= 15) return 0.32 + (avgAge - 10) * 0.15;         // 0.32 .. 1.07
    return 1.07 + Math.pow((avgAge - 15), 1.35);                  // nonlinear tail
  })();

  // Oldest-unit kicker: one very old bank often causes outsized downtime.
  const oldestKicker = Math.max(0, (oldest - 13)) * 0.12;

  const severity = baseSeverity + oldestKicker;

  // Map severity to economic impacts (fractions), then convert to % where needed.
  const revPenalty = Math.min(0.60, severity * 0.18);             // up to 60% revenue haircut
  const utilDrift  = Math.min(0.80, severity * 0.22);             // up to 80% utilities drift
  const reservePct = Math.min(0.25, severity * 0.08);             // up to 25% of gross as capex reserve
  const stressPct  = Math.min(0.50, severity * 0.15);             // up to 50% EBITDA stress for DSCR
  let multiple      = 60 - severity * 12;                         // multiple compresses with age
  multiple = Math.max(25, Math.min(60, multiple));                // floor at 25√ó, ceiling at 60√ó

  const label = (() => {
    if (avgAge < 7) return "LOW";
    if (avgAge < 10) return "MODERATE";
    if (avgAge < 13) return "HIGH";
    if (avgAge < 17) return "SEVERE";
    return "DISTRESSED";
  })();

  return {
    avgAge,
    oldest,
    severity,
    label,
    revPenaltyPct: revPenalty * 100,
    utilDriftPct: utilDrift * 100,
    reservePct: reservePct * 100,
    stressPct: stressPct * 100,
    multiple
  };
}

// Initialize on load
document.addEventListener('DOMContentLoaded', function() {
  populateEquipmentTables();
  populateEquipmentCostTable();
  // applyLocale disabled (Auto Market is primary)
  updateProjectCost(); // Calculate project cost and set down payment
  compute();
  // Auto Market: press Enter in ZIP field to run
  const _az = document.getElementById('autoZip');
  if (_az) {
    _az.addEventListener('keydown', (ev) => { if (ev.key === 'Enter') autoFillUSMarket(); });
  }

  // Auto Market: wire button defensively
  const _ab = document.getElementById('autoFillBtn');
  if (_ab) _ab.addEventListener('click', () => autoFillUSMarket());

  // Global click debug for Auto Market
  document.addEventListener('click', (e) => {
    const t = e.target;
    if (t && t.id === 'autoFillBtn') {
      const s = document.getElementById('autoMarketStatus');
      if (s && s.textContent === 'Not run yet.') s.textContent = 'Click detected (debug)‚Ä¶';
    }
  }, true);

});

function populateEquipmentTables() {
  const washTbody = $("#washTbl tbody");
  const dryTbody = $("#dryTbl tbody");
  
  washTbody.innerHTML = washerDefs.map((w,i) => `
    <tr>
      <td>${w.name}</td>
      <td><input type="number" value="${w.count}" onchange="washerDefs[${i}].count=+this.value; deferredCompute()" style="width:60px"></td>
      <td><input type="number" value="${w.vend}" step="0.25" onchange="washerDefs[${i}].vend=+this.value; deferredCompute()" style="width:60px"></td>
      <td><input type="number" value="${w.turns}" step="0.1" onchange="washerDefs[${i}].turns=+this.value; deferredCompute()" style="width:60px"></td>
      <td><input type="number" value="${w.mins}" onchange="washerDefs[${i}].mins=+this.value; deferredCompute()" style="width:50px"></td>
      <td><input type="number" value="${w.kwh}" step="0.1" onchange="washerDefs[${i}].kwh=+this.value; deferredCompute()" style="width:50px"></td>
      <td><input type="number" value="${w.therms}" step="0.05" onchange="washerDefs[${i}].therms=+this.value; deferredCompute()" style="width:50px"></td>
      <td><input type="number" value="${w.gals}" onchange="washerDefs[${i}].gals=+this.value; deferredCompute()" style="width:50px"></td>
      <td><input type="number" value="${w.age}" onchange="washerDefs[${i}].age=+this.value; deferredCompute()" style="width:50px"></td>
    </tr>
  `).join('');
  
  dryTbody.innerHTML = dryerDefs.map((d,i) => `
    <tr>
      <td>${d.name}</td>
      <td><input type="number" value="${d.count}" onchange="dryerDefs[${i}].count=+this.value; deferredCompute()" style="width:60px"></td>
      <td><input type="number" value="${d.pricePerMin}" step="0.01" onchange="dryerDefs[${i}].pricePerMin=+this.value; deferredCompute()" style="width:60px"></td>
      <td><input type="number" value="${d.avgMins}" onchange="dryerDefs[${i}].avgMins=+this.value; deferredCompute()" style="width:60px"></td>
      <td><input type="number" value="${d.cycles}" step="0.1" onchange="dryerDefs[${i}].cycles=+this.value; deferredCompute()" style="width:60px"></td>
      <td><input type="number" value="${d.kwh}" step="0.1" onchange="dryerDefs[${i}].kwh=+this.value; deferredCompute()" style="width:50px"></td>
      <td><input type="number" value="${d.therms}" step="0.05" onchange="dryerDefs[${i}].therms=+this.value; deferredCompute()" style="width:50px"></td>
      <td><input type="number" value="${d.age}" onchange="dryerDefs[${i}].age=+this.value; deferredCompute()" style="width:50px"></td>
    </tr>
  `).join('');
}

function populateEquipmentCostTable() {
  const tbody = $("#equipCostTbl tbody");
  tbody.innerHTML = Object.keys(equipCosts).map(name => `
    <tr>
      <td>${name}</td>
      <td><input type="number" value="${equipCosts[name]}" onchange="equipCosts['${name}']=+this.value; updateProjectCost(); deferredCompute()" style="width:100px"></td>
    </tr>
  `).join('');
}

function applyLocale() {
  const localeEl = $("#locale");
  if (!localeEl) return;
  const locale = localeEl.value;
  if (locale === 'custom') return;
  
  const preset = localePresets[locale];
  document.getElementById("rateElec").value = preset.elec;
  $("#rateGas").value = preset.gas;
  $("#rateWater").value = preset.water;
  $("#wage").value = preset.wage;
  $("#rent").value = preset.rent;
  $("#laborHrsDay").value = preset.laborHrs;
  $("#vendRev").value = preset.vendRev;
  $("#wfoldPrice").value = preset.wfoldPrice;
  $("#wfoldLbs").value = preset.wfoldLbs;
  
  deferredCompute();
}

function applyMode() {
  const mode = $("#mode").value;
  $("#modeBadge").textContent = mode === 'book' ? 'Book' : 'Market';
  
  if (mode === 'book') {
    // Book mode - lock in methodology defaults
    $("#maintBasePct").value = 6;
    $("#maintAgeUpliftPct").value = 2;
    $("#lifeWasher").value = 13;
    $("#lifeDryer").value = 17;
    $("#retoolBudget").value = 85000;
    $("#brandBudget").value = 45000;
    $("#applyLifts").value = 1;
  }
  
  deferredCompute();
}

function toggleHelp() {
  const panel = $("#helpPanel");
  panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
}

function updateProjectCost() {
  // Calculate equipment costs
  let equipCost = 0;
  washerDefs.forEach(w => equipCost += w.count * (equipCosts[w.name] || 0));
  dryerDefs.forEach(d => equipCost += d.count * (equipCosts[d.name] || 0));
  
  // Installation, buildout, etc.
  const installPct = +$("#installPct").value;
  const buildoutPerSqft = +$("#buildoutPerSqft").value;
  const permitFees = +$("#permitFees").value;
  const sewerPerWasher = +$("#sewerPerWasher").value;
  const softPct = +$("#softPct").value;
  const workingCap = +$("#workingCap").value;
  const includeLifts = +$("#includeLiftsInProject").value;
  const totalSqft = +$("#totalSqft").value;
  
  const installation = equipCost * installPct / 100;
  const buildout = totalSqft * buildoutPerSqft;
  const totalWashers = washerDefs.reduce((sum, w) => sum + w.count, 0);
  const sewer = totalWashers * sewerPerWasher;
  
  const hardCosts = equipCost + installation + buildout + permitFees + sewer;
  const softCosts = hardCosts * softPct / 100;
  
  let totalProjectCost = hardCosts + softCosts + workingCap;
  
  if (includeLifts) {
    const retoolBudget = +$("#retoolBudget").value;
    const brandBudget = +$("#brandBudget").value;
    totalProjectCost += retoolBudget + brandBudget;
  }
  
  $("#projCost").value = Math.round(totalProjectCost);
  
  // Set reasonable default down payment if not set
  const currentDown = +$("#cashInv").value;
  if (currentDown === 0 && totalProjectCost > 0) {
    const reasonableDown = Math.round(totalProjectCost * 0.25); // 25% default
    $("#cashInv").value = reasonableDown;
  }
  
  // Show breakdown
  $("#projectCostBreak").innerHTML = `
    Equipment: ${money(equipCost)} | Install: ${money(installation)} | Buildout: ${money(buildout)}<br>
    Sewer: ${money(sewer)} | Permits: ${money(permitFees)} | Soft: ${money(softCosts)} | Working: ${money(workingCap)}<br>
    ${includeLifts ? `Retool+Brand: ${money((+$("#retoolBudget").value) + (+$("#brandBudget").value))}<br>` : ''}
    <strong>Total: ${money(totalProjectCost)}</strong>
  `;
}

// CORRECTED findOptimumDown with expanded search range (MAJOR FIX)
function findOptimumDown() {
  const projCost = +$("#projCost").value;
  const targetDSCR = +$("#targetDSCR").value;
  
  let lowDown = 0;
  let highDown = projCost; // FIXED: Allow up to all-cash (was projCost * 0.6)
  let optimumDown = projCost * 0.3; // Start guess
  
  for (let iter = 0; iter < 50; iter++) {
    const testDown = (lowDown + highDown) / 2;
    $("#cashInv").value = testDown;
    
    const snapshot = calculateSnapshot();
    const actualDSCR = snapshot.dscr;
    
    if (Math.abs(actualDSCR - targetDSCR) < 0.01) {
      optimumDown = testDown;
      break;
    }
    
    if (actualDSCR < targetDSCR) {
      lowDown = testDown;
    } else {
      highDown = testDown;
    }
    optimumDown = testDown;
  }
  
  $("#cashInv").value = Math.round(optimumDown);
  $("#optDownNote").textContent = `Optimum down for DSCR ${targetDSCR}: ${money(optimumDown)} (${((optimumDown/projCost)*100).toFixed(1)}%)`;
  
  compute();
}

function applyZeroDown() {
  $("#cashInv").value = 0;
  $("#aPct").value = 70; // SBA
  $("#bPct").value = 30; // Seller
  $("#aRate").value = 8.5;
  $("#bRate").value = 6.0;
  $("#aTerm").value = 10;
  $("#bTerm").value = 10;
  deferredCompute();
}

// CORRECTED core financial calculation with all major fixes applied

// ===============================
// Cash Invested (CoC) - SINGLE SOURCE OF TRUTH
// We compute two variants:
// 1) cashInvestedEquityOnly: down payment only (can explode near zero-down)
// 2) cashInvestedOutOfPocket: conservative cash out-of-pocket, adding items that are commonly NOT financeable
//    - Working capital
//    - Retool/Brand only if NOT included in project financing
// The app uses cashInvestedOutOfPocket for displayed Cash-on-Cash ROI to avoid misleading 1,000%+ outputs.
// ===============================

function getCashInvestedBases() {
  const cashDown = +$("#cashInv").value || 0;
  const workingCap = +$("#workingCap").value || 0;

  const includeLiftsInProject = (+$("#includeLiftsInProject").value || 0) === 1;
  const retoolBudget = +$("#retoolBudget").value || 0;
  const brandBudget  = +$("#brandBudget").value || 0;

  const liftsCash = includeLiftsInProject ? 0 : (retoolBudget + brandBudget);

  // Conservative assumption: working capital is cash out-of-pocket (often required even when SBA finances project costs).
  const outOfPocket = Math.max(0, cashDown + workingCap + liftsCash);

  // ---- CoC Guardrail ----
  // Cash-on-Cash becomes mathematically unstable when the denominator is tiny (e.g., "zero down" or unrealistic equity).
  // To keep the displayed CoC meaningful for underwriting, we apply a floor equal to a minimum equity % of total project cost.
  // This does NOT change cash flow or DSCR; it only prevents misleading 1,000%+ CoC readouts.
  const projCost = +$("#projCost").value || 0;
  const minEquityFloorPct = 0.20; // 20% default floor (typical lender/operator equity expectation)
  const equityFloor = projCost > 0 ? projCost * minEquityFloorPct : 0;

  // Displayed denominator: max(out-of-pocket, equityFloor)
  const cashInvestedDisplayed = Math.max(outOfPocket, equityFloor);

  return {
    cashInvestedEquityOnly: Math.max(0, cashDown),
    cashInvestedOutOfPocket: outOfPocket,
    cashInvestedDisplayed,
    floor: { minEquityFloorPct, equityFloor, projCost },
    breakdown: { cashDown, workingCap, liftsCash, includeLiftsInProject }
  };
}
function calculateSnapshot() {
  const days = +$("#days").value;
  const rates = {
    elec: +document.getElementById("rateElec").value,
    gas: +$("#rateGas").value,
    water: +$("#rateWater").value
  };
  
  // Equipment revenue
  const equipRev = LaundryCalculator.calculateEquipmentRevenue(washerDefs, dryerDefs, days);
  
  // Wash & Fold revenue
  const wfoldPrice = +$("#wfoldPrice").value;
  const wfoldLbs = +$("#wfoldLbs").value;
  const wfoldRevenue = wfoldPrice * wfoldLbs * days;
  
  // FIXED: Vending revenue - use GROSS in revenue, COGS as expense (no double-counting)
  const vendRev = +$("#vendRev").value;
  const vendCogsPct = +$("#vendCogsPct").value / 100;
  const vendCogs = vendRev * vendCogsPct; // COGS will be in expenses
  
  // Base revenue before lifts
  const baseRevenue = equipRev.total + wfoldRevenue + vendRev; // Use gross vending revenue
  // Age-based risk adjustments (auto)
  const ageRisk = calcAgeRisk(washerDefs, dryerDefs);
  
  // Apply industry lifts to base revenue
  let grossRevenue = baseRevenue;
  let totalLift = 0;
  const applyLifts = +$("#applyLifts").value;
  
  if (applyLifts) {
    const retoolBudget = +$("#retoolBudget").value;
    const brandBudget = +$("#brandBudget").value;
    const lifts = LaundryCalculator.calculateIndustryLifts(baseRevenue, retoolBudget, brandBudget);
    totalLift = lifts.totalLift;
    grossRevenue += totalLift;
  }
  
  // Apply age-based revenue haircut (downtime, customer churn)
  const grossRevenuePreRisk = grossRevenue;
  if (ageRisk.revPenaltyPct > 0) {
    grossRevenue = grossRevenue * (1 - ageRisk.revPenaltyPct / 100);
  }

  // Replacement reserve (capex reserve) taken below EBITDA (cash flow adjustment)
// Baseline: fund future replacements based on equipment PP&E and useful lives
const washerLifeYears = (+$("#washerLife")?.value || 13);
const dryerLifeYears  = (+$("#dryerLife")?.value || 17);
let washPPe = 0, dryPPe = 0;
washerDefs.forEach(w => { washPPe += (+w.count||0) * (equipCosts[w.name] || 0); });
dryerDefs.forEach(d => { dryPPe  += (+d.count||0) * (equipCosts[d.name] || 0); });
const baseReserve = ((washPPe / Math.max(1, washerLifeYears)) + (dryPPe / Math.max(1, dryerLifeYears))) / 12;
// Extra reserve penalty tied to age risk (optional)
const ageReserve = grossRevenue * (ageRisk.reservePct / 100);
const replacementReserve = baseReserve + ageReserve;

  
  // Operating expenses
  const rent = +$("#rent").value;
  const laborHours = +$("#laborHrsDay").value;
  const wage = +$("#wage").value;
  const laborCost = laborHours * wage * days;
  
  // Efficiency factors for utilities
  const effElec = applyLifts ? +$("#effElecPct").value / 100 : 0;
  const effGas = applyLifts ? +$("#effGasPct").value / 100 : 0;
  const effWater = applyLifts ? +$("#effWaterPct").value / 100 : 0;
  
  const utilities = LaundryCalculator.calculateUtilityCosts(
    washerDefs, dryerDefs, rates, days, 
    { elec: effElec, gas: effGas, water: effWater }
  );
  
  // Hot-water heating gas for washers (therms)
  // Q (BTU) = gallons_hot * 8.34 * ŒîT; 1 therm = 100,000 BTU
  const hotShare = (+$("#hotSharePct").value || 60) / 100;
  const dT = +$("#deltaT").value || 65;
  const eff = (+$("#heaterEffPct").value || 80) / 100;

  let washerGallonsMo = 0;
  washerDefs.forEach(w => { washerGallonsMo += w.count * w.turns * days * w.gals; });
  const hotGallonsMo = washerGallonsMo * hotShare;
  const thermsForHot = (hotGallonsMo * 8.34 * dT) / (100000 * eff);
  const hotGas$ = thermsForHot * rates.gas * (1 - effGas); // Apply efficiency if retooling
  
  // Debug calculation to verify hot water heating is working
  if (hotGallonsMo > 0) {
    console.log(`üî• Hot Water Debug: ${hotGallonsMo.toFixed(0)} gal/mo √ó ${hotShare*100}% hot √ó ${dT}¬∞F rise`);
    console.log(`üî• Boiler: ${(eff*100).toFixed(0)}% efficient ‚Üí ${thermsForHot.toFixed(2)} therms needed`);
    console.log(`üî• Gas cost: ${thermsForHot.toFixed(2)} therms √ó $${rates.gas}/therm √ó ${((1-effGas)*100).toFixed(0)}% efficiency = $${hotGas$.toFixed(2)}/mo`);
    console.log(`üî• Total gas bill includes: Equipment ${(utilities.gas - hotGas$).toFixed(2)} + Hot water ${hotGas$.toFixed(2)} = $${utilities.gas.toFixed(2)}/mo`);
  }

  // Add to utilities
  utilities.gas += hotGas$;
  utilities.total += hotGas$;
  
  // Display hot water heating cost for verification
  const hotWaterDisplay = document.getElementById("hotWaterCostDisplay");
  if (hotWaterDisplay) {
    const effDisplay = effGas > 0 ? ` (${((1-effGas)*100).toFixed(0)}% w/retool)` : '';
    hotWaterDisplay.textContent = `Hot water: ${hotGallonsMo.toFixed(0)} gal √ó ${(eff*100).toFixed(0)}% eff = ${thermsForHot.toFixed(2)} therms = $${hotGas$.toFixed(2)}/mo${effDisplay}`;
    hotWaterDisplay.style.display = 'block';
  }

  // Apply age-based utility drift (older machines tend to leak/lose efficiency)
  if (ageRisk.utilDriftPct > 0) {
    const drift = 1 + ageRisk.utilDriftPct / 100;
    utilities.elec *= drift;
    utilities.gas *= drift;
    utilities.water *= drift;
    utilities.total *= drift;
  }

  // FIXED: Maintenance based on BASE revenue, not post-lift revenue
  const maintBasePct = +$("#maintBasePct").value;
  const maintAgeUpliftPct = +$("#maintAgeUpliftPct").value;
  const maintenance = LaundryCalculator.calculateMaintenanceCosts(
    baseRevenue, maintBasePct, maintAgeUpliftPct, washerDefs, dryerDefs
  );
  
  const totalOpex = rent + laborCost + utilities.total + maintenance + vendCogs;
  const ebitda = grossRevenue - totalOpex;
  
  // FIXED: Financing with down payment properly reducing debt
  const projCost = +$("#projCost").value;
  const cashInv = +$("#cashInv").value;
  const aPct = +$("#aPct").value / 100;
  const bPct = +$("#bPct").value / 100;
  const aRate = +$("#aRate").value / 100;
  const bRate = +$("#bRate").value / 100;
  const aTerm = +$("#aTerm").value;
  const bTerm = +$("#bTerm").value;
  
  // FIXED: Calculate actual loan amounts after down payment with proper tranche caps
  const totalLoan = Math.max(0, projCost - cashInv);
  const maxA = projCost * aPct;
  const maxB = projCost * bPct;
  const loanA = Math.min(totalLoan, maxA);
  const loanB = Math.min(Math.max(0, totalLoan - loanA), maxB);
  const totalDebt = loanA + loanB; // cap B too
  
  const pmtA = loanA > 0 ? Math.abs(pmt(aRate / 12, aTerm * 12, loanA)) : 0;
  const pmtB = loanB > 0 ? Math.abs(pmt(bRate / 12, bTerm * 12, loanB)) : 0;
  const totalDebtService = pmtA + pmtB;
  
  const cashFlow = ebitda - totalDebtService - replacementReserve;
  const dscr = totalDebtService > 0 ? ebitda * 12 / (totalDebtService * 12) : 999;
  const stressedDSCR = totalDebtService > 0 ? (ebitda * (1 - ageRisk.stressPct/100)) / totalDebtService : 999;
  const cashBases = getCashInvestedBases();
  const cashOnCashEquityOnly = cashBases.cashInvestedEquityOnly > 0 ? (cashFlow * 12 / cashBases.cashInvestedEquityOnly) * 100 : 0;
  const cashOnCash = cashBases.cashInvestedDisplayed > 0 ? (cashFlow * 12 / cashBases.cashInvestedDisplayed) * 100 : 0;

  
  // Debug unrealistic ROI
  if (cashOnCash > 100) {
    console.log('DEBUG - High ROI detected:');
    console.log(`EBITDA: $${ebitda.toFixed(0)}/mo`);
    console.log(`Debt Service: $${totalDebtService.toFixed(0)}/mo`);
    console.log(`Cash Flow: $${cashFlow.toFixed(0)}/mo = $${(cashFlow * 12).toFixed(0)}/yr`);
    console.log(`Cash Invested (Equity Only): $${cashBases.cashInvestedEquityOnly.toFixed(0)}`);
    console.log(`Cash Invested (Out-of-Pocket): $${cashBases.cashInvestedOutOfPocket.toFixed(0)} (Down $${cashBases.breakdown.cashDown.toFixed(0)} + WC $${cashBases.breakdown.workingCap.toFixed(0)} + Extra Lifts $${cashBases.breakdown.liftsCash.toFixed(0)})`);
    console.log(`Cash Invested (Displayed Floor): $${cashBases.cashInvestedDisplayed.toFixed(0)} (Floor ${Math.round(cashBases.floor.minEquityFloorPct*100)}% of $${cashBases.floor.projCost.toFixed(0)} = $${cashBases.floor.equityFloor.toFixed(0)})`);
    console.log(`ROI: ${cashOnCash.toFixed(1)}%`);
    console.log(`Project Cost: $${projCost.toFixed(0)}`);
    console.log(`Loan A: $${loanA.toFixed(0)} @ ${(aRate*100).toFixed(2)}%`);
    console.log(`Loan B: $${loanB.toFixed(0)} @ ${(bRate*100).toFixed(2)}%`);
    console.log(`Base Revenue: $${baseRevenue.toFixed(0)}/mo`);
    console.log(`Total Lift: $${totalLift.toFixed(0)}/mo`);
    console.log(`Gross Revenue: $${grossRevenue.toFixed(0)}/mo`);
  }
  
  // Industry valuation (NOI multiple auto-adjusted for equipment age risk)
  const valuationMultiple = ageRisk.multiple;
  const industryValuation = ebitda * valuationMultiple;
  
  return {
    baseRevenue,
    equipRev,
    wfoldRevenue,
    vendRevGross: vendRev,
    totalLift,
    grossRevenue,
    grossRevenuePreRisk,
    replacementReserve,
    ageRisk,
    stressedDSCR,
    valuationMultiple,
    rent,
    laborCost,
    utilities,
    maintenance,
    vendCogs,
    totalOpex,
    ebitda,
    projCost,
    cashInv,
    cashInvestedEquityOnly: cashBases.cashInvestedEquityOnly,
    cashInvestedOutOfPocket: cashBases.cashInvestedOutOfPocket,
    cashInvestedDisplayed: cashBases.cashInvestedDisplayed,
    loanA,
    loanB,
    pmtA,
    pmtB,
    totalDebtService,
    cashFlow,
    dscr,
    cashOnCash,
    industryValuation
  };
}

// Multi-year simulation

function simulateYears() {
  const horizon = +$("#horizon").value;
  const snapshot = calculateSnapshot();

  const years = [];
  const revenues = [];
  const ebitdas = [];
  const cashFlows = [];
  const afterTaxIncomes = [];
  const taxes = [];
  const cumulativeCash = [- (snapshot.cashInvestedDisplayed ?? snapshot.cashInvestedOutOfPocket ?? snapshot.cashInv)];
  const dscrs = [];

  const revGrowRate = (+$("#revGrowPct").value || 2.5) / 100;
  const opexInflRate = (+$("#opexInflPct").value || 3.0) / 100;

  // Depreciation & tax inputs
  const depMethod = ($("#depreciationMethod")?.value) || "macrs";
  const equipLife = parseInt($("#taxEquipLife")?.value || "7", 10);
  const bldgLife = parseInt($("#taxBuildingLife")?.value || "39", 10);
  const fedRate = parseFloat($("#fedTaxRate")?.value || "21");
  const stateRate = parseFloat($("#stateTaxRate")?.value || "8.84");
  const entityType = ($("#entityType")?.value) || "llc";

  // Approximate tax bases: split project cost into equipment/building if exact breakdown not available
  const equipBasis = snapshot.projCost * 0.6; // assumption: ~60% equipment
  const bldgBasis  = snapshot.projCost * 0.4; // assumption: ~40% build-out/leaseholds

  for (let year = 1; year <= horizon; year++) {
    const annualRevenue = snapshot.grossRevenue * 12 * Math.pow(1 + revGrowRate, year - 1);
    const annualOpex = snapshot.totalOpex * 12 * Math.pow(1 + opexInflRate, year - 1);
    const annualEbitda = annualRevenue - annualOpex;

    // Depreciation
    const equipDep = calculateDepreciation(equipBasis, depMethod, equipLife, year);
    const bldgDep  = calculateDepreciation(bldgBasis, "straight_line", bldgLife, year);
    const depreciation = equipDep + bldgDep;

    // Interest proxy (annual): Use debt service interest portion, not full principal balance
    const interestAnnual = (snapshot.totalDebtService * 12) * 0.7; // ~70% of debt service is typically interest
    
    // Taxes and after-tax income  
    const taxCalc = calculateTaxes(annualEbitda, depreciation, interestAnnual, fedRate, stateRate, entityType);
    const annualAfterTaxIncome = taxCalc.afterTaxIncome;

    // Cash flow = After-tax income - principal payments (interest already deducted in tax calc)
    const principalPayments = (snapshot.totalDebtService * 12) * 0.3; // ~30% of debt service is principal
    const annualCashFlow = annualAfterTaxIncome - principalPayments;
    const annualDscr = snapshot.totalDebtService > 0 ? annualEbitda / (snapshot.totalDebtService * 12) : 999;

    years.push(year);
    revenues.push(annualRevenue);
    ebitdas.push(annualEbitda);
    cashFlows.push(annualCashFlow);
    afterTaxIncomes.push(annualAfterTaxIncome);
    taxes.push(taxCalc.totalTax);
    dscrs.push(annualDscr);

    const prevCumulative = cumulativeCash[cumulativeCash.length - 1];
    cumulativeCash.push(prevCumulative + annualCashFlow);
  }

  // Calculate payback years
  let paybackYears = 0;
  for (let i = 0; i < cumulativeCash.length; i++) {
    if (cumulativeCash[i] >= 0) {
      paybackYears = i;
      break;
    }
  }
  if (paybackYears === 0 && cumulativeCash[cumulativeCash.length - 1] < 0) {
    paybackYears = -1; // Never pays back
  }

  // Calculate NPV at 6% discount rate
  const discountRate = 0.06;
  let npv = -snapshot.cashInv;
  for (let i = 0; i < cashFlows.length; i++) {
    npv += cashFlows[i] / Math.pow(1 + discountRate, i + 1);
  }

  return {
    years, revenues, ebitdas, cashFlows, cumulativeCash, dscrs, taxes, afterTaxIncomes, paybackYears, npv
  };
}

// Render functions
function renderKPIs(snapshot) {
  const kpiClass = (value, good, warn) => {
    if (value >= good) return 'good';
    if (value >= warn) return 'warn';
    return 'bad';
  };
  
  // Add warning for unrealistic ROI
  const roiDisplay = snapshot.cashOnCash > 150 ? 
    `${snapshot.cashOnCash.toFixed(1)}% ‚ö†Ô∏è` : 
    `${snapshot.cashOnCash.toFixed(1)}%`;
  
  $("#kpis").innerHTML = `
    <div class="kpi ${kpiClass(snapshot.cashOnCash, 25, 20)} ${snapshot.cashOnCash > 150 ? 'warn' : ''}">
      <h4>Cash-on-Cash ROI</h4>
      <div class="hint">Conservative (Down + Working Cap + unfinanced lifts)</div>
      <div class="v">${roiDisplay}</div>
    </div>
    <div class="kpi">
      <h4>Industry Valuation (${snapshot.valuationMultiple}√ó NOI)</h4>
      <div class="v">${money(snapshot.industryValuation)}</div>
    </div>
    <div class="kpi ${kpiClass(snapshot.dscr, 1.5, 1.25)}">
      <h4>DSCR</h4>
      <div class="v">${snapshot.dscr.toFixed(2)}</div>
    </div>

    <div class="kpi ${kpiClass(snapshot.stressedDSCR, 1.35, 1.20)}">
      <h4>Stressed DSCR (Age Risk)</h4>
      <div class="v">${snapshot.stressedDSCR.toFixed(2)}</div>
    </div>
    <div class="kpi">
      <h4>Avg Equipment Age</h4>
      <div class="v">${snapshot.ageRisk.avgAge.toFixed(1)} yrs (oldest ${snapshot.ageRisk.oldest.toFixed(0)})</div>
    </div>

    <div class="kpi">
      <h4>Monthly EBITDA</h4>
      <div class="v">${money(snapshot.ebitda)}</div>
    </div>
    <div class="kpi ${kpiClass(snapshot.cashFlow, 8000, 5000)}">
      <h4>Monthly Cash Flow</h4>
      <div class="v">${money(snapshot.cashFlow)}</div>
    </div>
    <div class="kpi">
      <h4>Total Debt Service</h4>
      <div class="v">${money(snapshot.totalDebtService * 12)}/yr</div>
    </div>
  `;
  
  // Investment insight with corrected thresholds and warning for unrealistic numbers
  let insight = '';
  if (snapshot.cashOnCash > 150) {
    insight = '‚ö†Ô∏è ROI appears unrealistic (>150%). Check: very low down payment, overstated revenue, or understated expenses.';
  } else if (snapshot.cashOnCash > 50) {
    insight = 'Exceptionally high ROI - verify all inputs carefully. This may indicate data entry errors or unique market conditions.';
  } else if (snapshot.cashOnCash < 15) {
    insight = 'Below industry standards. Consider reducing price or finding value-add opportunities.';
  } else if (snapshot.cashOnCash < 20) {
    insight = 'Marginal deal by industry standards. Look for operational improvements to reach 20%+ CoC.';
  } else if (snapshot.cashOnCash < 25) {
    insight = 'Solid investment! Meets 20% CoC baseline with room for growth.';
  } else {
    insight = 'Exceptional opportunity! Well above standards with strong cash flow.';
  }
  
  $("#insightText").textContent = insight;
}

function renderTables(snapshot, simulation) {
  // Revenue breakdown table
  $("#revTbl").innerHTML = `
    <tr><th>Revenue Source</th><th>Monthly</th><th>Annual</th></tr>
    <tr><td>Equipment (Washers)</td><td>${money(snapshot.equipRev.washRev)}</td><td>${money(snapshot.equipRev.washRev * 12)}</td></tr>
    <tr><td>Equipment (Dryers)</td><td>${money(snapshot.equipRev.dryRev)}</td><td>${money(snapshot.equipRev.dryRev * 12)}</td></tr>
    <tr><td>Wash & Fold</td><td>${money(snapshot.wfoldRevenue)}</td><td>${money(snapshot.wfoldRevenue * 12)}</td></tr>
    <tr><td>Vending (gross)</td><td>${money(snapshot.vendRevGross)}</td><td>${money(snapshot.vendRevGross * 12)}</td></tr>
    <tr><td>Revenue Lifts</td><td>${money(snapshot.totalLift)}</td><td>${money(snapshot.totalLift * 12)}</td></tr>
    <tr><td><strong>Total Revenue</strong></td><td><strong>${money(snapshot.grossRevenue)}</strong></td><td><strong>${money(snapshot.grossRevenue * 12)}</strong></td></tr>
  `;
  
  // P&L table
  $("#plTbl").innerHTML = `
    <tr><th>P&L Line Item</th><th>Monthly</th><th>Annual</th></tr>
    <tr><td><strong>Gross Revenue</strong></td><td><strong>${money(snapshot.grossRevenue)}</strong></td><td><strong>${money(snapshot.grossRevenue * 12)}</strong></td></tr>
    <tr><td>Rent + CAM</td><td>${money(snapshot.rent)}</td><td>${money(snapshot.rent * 12)}</td></tr>
    <tr><td>Labor</td><td>${money(snapshot.laborCost)}</td><td>${money(snapshot.laborCost * 12)}</td></tr>
    <tr><td>Electric</td><td>${money(snapshot.utilities.elec)}</td><td>${money(snapshot.utilities.elec * 12)}</td></tr>
    <tr><td>Gas</td><td>${money(snapshot.utilities.gas)}</td><td>${money(snapshot.utilities.gas * 12)}</td></tr>
    <tr><td>Water/Sewer</td><td>${money(snapshot.utilities.water)}</td><td>${money(snapshot.utilities.water * 12)}</td></tr>
    <tr><td>Maintenance</td><td>${money(snapshot.maintenance)}</td><td>${money(snapshot.maintenance * 12)}</td></tr>
    <tr><td>Vending COGS</td><td>${money(snapshot.vendCogs)}</td><td>${money(snapshot.vendCogs * 12)}</td></tr>
    <tr><td><strong>EBITDA</strong></td><td><strong>${money(snapshot.ebitda)}</strong></td><td><strong>${money(snapshot.ebitda * 12)}</strong></td></tr>
    <tr><td>Income Taxes (est.)</td><td>${money(simulation.taxes ? (simulation.taxes[0]/12) : 0)}</td><td>${money(simulation.taxes ? simulation.taxes[0] : 0)}</td></tr>
    <tr><td><strong>After-Tax Income</strong></td><td><strong>${money(simulation.afterTaxIncomes ? (simulation.afterTaxIncomes[0]/12) : snapshot.ebitda - (snapshot.totalDebtService*0))}</strong></td><td><strong>${money(simulation.afterTaxIncomes ? simulation.afterTaxIncomes[0] : (snapshot.ebitda*12))}</strong></td></tr>

    <tr><td>Debt Service</td><td>${money(snapshot.totalDebtService)}</td><td>${money(snapshot.totalDebtService * 12)}</td></tr>
    <tr><td>Replacement Reserve (CAPEX)</td><td>${money(snapshot.replacementReserve)}</td><td>${money(snapshot.replacementReserve * 12)}</td></tr>
    <tr><td><strong>Cash Flow</strong></td><td><strong>${money(snapshot.cashFlow)}</strong></td><td><strong>${money(snapshot.cashFlow * 12)}</strong></td></tr>
  `;
  
  // Multi-year tables
  let plYears = '<tr><th>Year</th><th>Revenue</th><th>EBITDA</th><th>Cash Flow</th><th>DSCR</th></tr>';
  simulation.years.forEach((year, i) => {
    plYears += `<tr><td>${year}</td><td>${money(simulation.revenues[i])}</td><td>${money(simulation.ebitdas[i])}</td><td>${money(simulation.cashFlows[i])}</td><td>${simulation.dscrs[i].toFixed(2)}</td></tr>`;
  });
  $("#plYears").innerHTML = plYears;
  
  let cfYears = '<tr><th>Year</th><th>Annual Cash</th><th>Cumulative</th><th>ROI Status</th></tr>';
  simulation.years.forEach((year, i) => {
    const paybackStatus = simulation.cumulativeCash[i + 1] >= 0 ? '‚úì Recovered' : 'Pending';
    cfYears += `<tr><td>${year}</td><td>${money(simulation.cashFlows[i])}</td><td>${money(simulation.cumulativeCash[i + 1])}</td><td>${paybackStatus}</td></tr>`;
  });
  $("#cfYears").innerHTML = cfYears;
  
  // Simple balance sheet
  let bsYears = '<tr><th>Year</th><th>Cash</th><th>Equipment PP&E</th><th>Debt</th><th>Equity</th></tr>';
  simulation.years.forEach((year, i) => {
    const cash = Math.max(0, simulation.cumulativeCash[i + 1]);
    const ppe = snapshot.projCost - (snapshot.projCost * 0.07 * year); // 7% depreciation
    const debt = snapshot.loanA + snapshot.loanB - (snapshot.totalDebtService * 12 * 0.7 * year); // Rough principal
    const equity = cash + Math.max(0, ppe) - Math.max(0, debt);
    
    bsYears += `<tr><td>${year}</td><td>${money(cash)}</td><td>${money(Math.max(0, ppe))}</td><td>${money(Math.max(0, debt))}</td><td>${money(equity)}</td></tr>`;
  });
  $("#bsYears").innerHTML = bsYears;
}

// Chart rendering with Chart.js
let chartInstances = {};

function renderCharts(snapshot, simulation) {
  try {
    if (!window.Chart) return;

  const ctx1 = $("#roiChart").getContext('2d');
  const ctx2 = $("#cashFlowChart").getContext('2d');
  const ctx3 = $("#dscrChart").getContext('2d');
  const ctx4 = $("#utilitiesChart").getContext('2d');
  
  // Get current time horizon for dynamic chart titles
  const horizon = +$("#horizon").value || 10;
  
  // Destroy existing charts
  Object.values(chartInstances).forEach(chart => chart?.destroy?.());
  chartInstances = {};
  
  // ROI Chart
  chartInstances.roi = new Chart(ctx1, {
    type: 'bar',
    data: {
      labels: ['Current CoC', 'Industry Target', 'Excellent'],
      datasets: [{
        label: 'ROI %',
        data: [snapshot.cashOnCash, 20, 25],
        backgroundColor: [
          snapshot.cashOnCash >= 25 ? '#22c55e' : snapshot.cashOnCash >= 20 ? '#f59e0b' : '#ef4444',
          '#60a5fa', '#22c55e'
        ]
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        title: { 
          display: true, 
          text: 'Cash-on-Cash ROI Analysis',
          color: '#cfe0ff'
        },
        legend: { 
          display: false,
          labels: { color: '#cfe0ff' }
        }
      },
      scales: {
        x: {
          ticks: { color: '#a8c5e9' },
          grid: { color: '#1a2a4a' }
        },
        y: { 
          beginAtZero: true, 
          max: Math.max(35, Math.min(250, (snapshot.cashOnCash || 0) * 1.25)),
          ticks: { color: '#a8c5e9' },
          grid: { color: '#1a2a4a' }
        }
      }
    }
  });
  
  // Cash Flow Chart
  chartInstances.cashFlow = new Chart(ctx2, {
    type: 'line',
    data: {
      labels: simulation.years,
      datasets: [
        {
          label: 'Annual Cash Flow',
          data: simulation.cashFlows,
          borderColor: '#60a5fa',
          backgroundColor: 'rgba(96, 165, 250, 0.1)'
        },
        {
          label: 'Cumulative Cash',
          data: simulation.cumulativeCash.slice(1),
          borderColor: '#22c55e',
          backgroundColor: 'rgba(34, 197, 94, 0.1)'
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        title: { 
          display: true, 
          text: `${horizon}-Year Cash Flow Projection`,
          color: '#cfe0ff'
        },
        legend: { 
          labels: { color: '#cfe0ff' }
        }
      },
      scales: {
        x: {
          ticks: { color: '#a8c5e9' },
          grid: { color: '#1a2a4a' }
        },
        y: {
          ticks: { color: '#a8c5e9' },
          grid: { color: '#1a2a4a' }
        }
      }
    }
  });
  
  // DSCR Chart
  chartInstances.dscr = new Chart(ctx3, {
    type: 'line',
    data: {
      labels: simulation.years,
      datasets: [{
        label: 'DSCR',
        data: simulation.dscrs,
        borderColor: '#f59e0b',
        backgroundColor: 'rgba(245, 158, 11, 0.1)'
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      scales: {
        x: {
          ticks: { color: '#a8c5e9' },
          grid: { color: '#1a2a4a' }
        },
        y: { 
          beginAtZero: false, 
          min: 1.0,
          max: Math.max(2.5, Math.ceil(Math.max(...simulation.dscrs)*10)/10),
          ticks: {
            callback: function(value) { return value.toFixed(2); },
            color: '#a8c5e9'
          },
          grid: { color: '#1a2a4a' }
        } 
      },
      plugins: { 
        title: { 
          display: true, 
          text: 'Debt Service Coverage Ratio (Min 1.25 Target)',
          color: '#cfe0ff'
        },
        legend: { 
          labels: { color: '#cfe0ff' }
        }
      }
    }
  });
  
  // Utilities Breakdown
  chartInstances.utilities = new Chart(ctx4, {
    type: 'doughnut',
    data: {
      labels: ['Electric', 'Gas', 'Water/Sewer'],
      datasets: [{
        data: [snapshot.utilities.elec, snapshot.utilities.gas, snapshot.utilities.water],
        backgroundColor: ['#f59e0b', '#ef4444', '#60a5fa']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        title: { 
          display: true, 
          text: 'Monthly Utility Costs Breakdown',
          color: '#cfe0ff'
        },
        legend: { 
          labels: { color: '#cfe0ff' }
        }
      }
    }
  });
  
  $("#chartHint").textContent = "Charts updated with corrected financial calculations.";

  } catch (e) {
    console.error('renderCharts non-fatal error:', e);
  }
}


function sizeFootprintFromUnits() {
  const totalWashers = washerDefs.reduce((sum, w) => sum + w.count, 0);
  const totalDryers = dryerDefs.reduce((sum, d) => sum + d.count, 0);
  
  const sqftWasher = +$("#sqftWasher").value;
  const sqftDryer = +$("#sqftDryer").value;
  
  const requiredSqft = (totalWashers * sqftWasher) + (totalDryers * sqftDryer);
  const bufferedSqft = Math.round(requiredSqft * 1.15); // 15% buffer
  // Minimum operational footprint guardrail: circulation, folding, ADA paths, backroom, etc.
  const minOperationalSqft = Math.max(900, Math.round((totalWashers + totalDryers) * 20));
  const finalSqft = Math.max(bufferedSqft, minOperationalSqft);
  
  $("#totalSqft").value = finalSqft;
  
  const machinesPerStall = +$("#machinesPerStall").value;
  const suggestedStalls = Math.ceil((totalWashers + totalDryers) / machinesPerStall);
  $("#stalls").value = suggestedStalls;
  
  document.getElementById("constraintNote").innerHTML = `Footprint sized for ${totalWashers + totalDryers} machines: ${finalSqft.toLocaleString()} sq ft + ${suggestedStalls} stalls (15% efficiency buffer included)`;
  
  deferredCompute();
}



function resetEquipmentDefaults() {
  if (!confirm('Restore equipment to initial defaults? This will overwrite current equipment and counts. Proceed?')) return;
  washerDefs = JSON.parse(JSON.stringify(window._initialWasherDefs || []));
  dryerDefs = JSON.parse(JSON.stringify(window._initialDryerDefs || []));
  equipCosts = JSON.parse(JSON.stringify(window._initialEquipCosts || {}));
  populateEquipmentTables();
  populateEquipmentCostTable();
  compute();
  alert('Equipment defaults restored.');
}

function suggestUnits() {
  const totalSqft = +$("#totalSqft").value;
  const stalls = +$("#stalls").value;
  const machinesPerStall = +$("#machinesPerStall").value;
  const sqftWasher = +$("#sqftWasher").value;
  const sqftDryer = +$("#sqftDryer").value;
  

  function allocateByWeights(total, weights) {
    const raw = weights.map(w => total * w);
    const base = raw.map(x => Math.floor(x));
    let used = base.reduce((a,b)=>a+b,0);
    let rem = Math.max(0, total - used);

    // distribute remainder to largest fractional parts
    const fracIdx = raw.map((x,i)=>({i, frac: x - base[i]}))
                      .sort((a,b)=> b.frac - a.frac);
    for (let k=0; k<rem; k++) {
      base[fracIdx[k % fracIdx.length].i] += 1;
    }
    return base;
  }

  const maxMachinesByParking = stalls * machinesPerStall;
  const avgSqftPerMachine = (sqftWasher + sqftDryer) / 2;
  const maxMachinesBySqft = Math.floor(totalSqft / avgSqftPerMachine);
  
  const maxMachines = Math.min(maxMachinesByParking, maxMachinesBySqft);
  
  // Suggest 60% washers, 40% dryers
  const suggestedWashers = Math.floor(maxMachines * 0.6);
  const suggestedDryers = Math.floor(maxMachines * 0.4);
  
  // Distribute among machine types (stable totals; no shrink-on-repeat)
  if (suggestedWashers > 0) {
    const wCounts = allocateByWeights(suggestedWashers, [0.40, 0.30, 0.20, 0.10, 0.00]);
    washerDefs[0].count = wCounts[0];
    washerDefs[1].count = wCounts[1];
    washerDefs[2].count = wCounts[2];
    washerDefs[3].count = wCounts[3];
    washerDefs[4].count = wCounts[4];
  } else {
    washerDefs.forEach(w => w.count = 0);
  }

  if (suggestedDryers > 0) {
        const dCounts = allocateByWeights(suggestedDryers, [0.70, 0.30]);
    dryerDefs[0].count = dCounts[0];
    dryerDefs[1].count = dCounts[1];
  }
  
  populateEquipmentTables();
  updateProjectCost();
  
  document.getElementById("constraintNote").innerHTML = `Suggested mix: ${suggestedWashers} washers + ${suggestedDryers} dryers = ${maxMachines} total machines (max capacity: ${maxMachinesByParking} by parking, ${maxMachinesBySqft} by space)`;
  
  deferredCompute();
}

function optimizeMix() {
  // Simple optimization: maximize EBITDA within constraints
  // This is a placeholder - real optimization would use more sophisticated algorithms
  suggestUnits();
  document.getElementById("constraintNote").innerHTML += " ‚Üí Optimized for maximum EBITDA within space constraints.";
}

// Check constraints and show warnings automatically
function checkConstraints() {
  const totalWashers = washerDefs.reduce((sum, w) => sum + w.count, 0);
  const totalDryers = dryerDefs.reduce((sum, d) => sum + d.count, 0);
  const totalMachines = totalWashers + totalDryers;
  
  const totalSqft = +$("#totalSqft").value;
  const stalls = +$("#stalls").value;
  const machinesPerStall = +$("#machinesPerStall").value;
  const sqftWasher = +$("#sqftWasher").value;
  const sqftDryer = +$("#sqftDryer").value;
  
  const requiredSqft = totalWashers * sqftWasher + totalDryers * sqftDryer;
  const maxMachinesByParking = stalls * machinesPerStall;
  
  let warnings = [];
  if (requiredSqft > totalSqft) {
    warnings.push(`‚ö†Ô∏è Space shortage: Need ${requiredSqft} sq ft, have ${totalSqft}`);
  }
  if (totalMachines > maxMachinesByParking) {
    warnings.push(`‚ö†Ô∏è Parking shortage: ${totalMachines} machines exceed ${maxMachinesByParking} stall limit`);
  }
  
  const constraintEl = document.getElementById("constraintNote");
  if (warnings.length > 0) {
    constraintEl.innerHTML = warnings.join('<br>');
    constraintEl.style.display = 'block';
    constraintEl.style.color = '#dc2626';
    constraintEl.style.fontWeight = 'bold';
  } else {
    constraintEl.style.display = 'none';
  }
}

/* ---------- GLOBAL ENHANCED CONSTRAINT CHECK ---------- */
function checkConstraintsEnhanced() {
  const totalWashers = washerDefs.reduce((sum, w) => sum + w.count, 0);
  const totalDryers = dryerDefs.reduce((sum, d) => sum + d.count, 0);
  const totalMachines = totalWashers + totalDryers;
  
  const totalSqft = +$("#totalSqft").value;
  const stalls = +$("#stalls").value;
  const machinesPerStall = +$("#machinesPerStall").value;
  const sqftWasher = +$("#sqftWasher").value;
  const sqftDryer = +$("#sqftDryer").value;
  
  const requiredSqft = totalWashers * sqftWasher + totalDryers * sqftDryer;
  const maxMachinesByParking = stalls * machinesPerStall;
  const spaceSurplus = totalSqft - requiredSqft;
  const parkingSurplus = maxMachinesByParking - totalMachines;
  
  let warnings = [];
  let suggestions = [];
  
  // Space Analysis
  if (requiredSqft > totalSqft) {
    const shortage = requiredSqft - totalSqft;
    const pctShortage = (shortage / totalSqft * 100).toFixed(1);
    warnings.push(`üö® CRITICAL: Space shortage of ${shortage} sq ft (${pctShortage}% over capacity)`);
    
    const avgSqftPerMachine = (totalWashers * sqftWasher + totalDryers * sqftDryer) / totalMachines;
    const machinesReduction = Math.ceil(shortage / avgSqftPerMachine);
    suggestions.push(`üí° Reduce by ${machinesReduction} machines OR increase space to ${requiredSqft.toLocaleString()} sq ft`);
    
    const maxMachinesForSpace = Math.floor(totalSqft / avgSqftPerMachine);
    suggestions.push(`üí° Maximum machines for ${totalSqft.toLocaleString()} sq ft: ${maxMachinesForSpace} units`);
  } else if (spaceSurplus > 0) {
    const utilizationPct = (requiredSqft / totalSqft * 100).toFixed(1);
    const potentialMachines = Math.floor(spaceSurplus / 25);
    
    if (utilizationPct < 85) {
      suggestions.push(`üí° Space underutilized: ${utilizationPct}% used, could add ${potentialMachines} more machines`);
    } else {
      suggestions.push(`‚úÖ Good space utilization: ${utilizationPct}% (15% buffer for aisles/folding)`);
    }
  }
  
  // Parking Analysis
  if (totalMachines > maxMachinesByParking) {
    const shortage = totalMachines - maxMachinesByParking;
    const pctOverParking = (shortage / maxMachinesByParking * 100).toFixed(1);
    warnings.push(`üö® CRITICAL: Parking shortage for ${shortage} machines (${pctOverParking}% over capacity)`);
    
    suggestions.push(`üí° Solutions: Add ${Math.ceil(shortage / machinesPerStall)} parking stalls OR reduce to ${maxMachinesByParking} machines`);
    suggestions.push(`üí° Alternative: Increase machines per stall to ${Math.ceil(totalMachines / stalls)} (requires larger stalls)`);
  } else if (parkingSurplus > 0) {
    const utilizationPct = (totalMachines / maxMachinesByParking * 100).toFixed(1);
    
    if (utilizationPct < 75) {
      const potentialMachines = Math.floor(parkingSurplus * 0.8);
      suggestions.push(`üí° Parking underutilized: ${utilizationPct}% used, could support ${potentialMachines} more machines`);
    } else {
      suggestions.push(`‚úÖ Good parking utilization: ${utilizationPct}% (adequate customer convenience)`);
    }
  }
  
  // Density Analysis
  const machinesPerStall_actual = totalMachines / stalls;
  const sqftPerMachine = totalSqft / totalMachines;
  
  if (machinesPerStall_actual > 3.5) {
    warnings.push(`‚ö†Ô∏è High machine density: ${machinesPerStall_actual.toFixed(1)} machines per stall may create congestion`);
  }
  
  if (sqftPerMachine < 22) {
    warnings.push(`‚ö†Ô∏è Cramped layout: ${sqftPerMachine.toFixed(1)} sq ft per machine (industry minimum: 25 sq ft)`);
  } else if (sqftPerMachine > 35) {
    suggestions.push(`üí° Spacious layout: ${sqftPerMachine.toFixed(1)} sq ft per machine allows for premium positioning`);
  }
  
  // Equipment Mix Analysis
  const washerToDryerRatio = totalWashers / totalDryers;
  if (washerToDryerRatio < 0.8) {
    suggestions.push(`üí° Consider more washers: Current ratio ${washerToDryerRatio.toFixed(2)}:1 (optimal: 1:1 to 1.2:1)`);
  } else if (washerToDryerRatio > 1.3) {
    suggestions.push(`üí° Consider more dryers: Current ratio ${washerToDryerRatio.toFixed(2)}:1 (optimal: 1:1 to 1.2:1)`);
  } else {
    suggestions.push(`‚úÖ Good washer-dryer balance: ${washerToDryerRatio.toFixed(2)}:1 ratio`);
  }
  
  // Display results
  const constraintEl = document.getElementById("constraintNote");
  
  if (warnings.length > 0 || suggestions.length > 0) {
    let content = "";
    
    if (warnings.length > 0) {
      content += `<div style="color:#dc2626; font-weight:bold; margin-bottom:8px">${warnings.join("<br>")}</div>`;
    }
    
    if (suggestions.length > 0) {
      content += `<div style="color:#059669; font-size:11px">${suggestions.join("<br>")}</div>`;
    }
    
    constraintEl.innerHTML = content;
    constraintEl.style.display = "block";
    constraintEl.style.background = warnings.length > 0 ? "#2a1f0a" : "#0a2a1a";
    constraintEl.style.border = warnings.length > 0 ? "1px dashed #dc2626" : "1px solid #059669";
    constraintEl.style.borderRadius = "8px";
    constraintEl.style.padding = "8px";
    constraintEl.style.marginTop = "8px";
  } else {
    constraintEl.style.display = "none";
  }
}



// Mr. Accountant Financial Analysis
function renderAccountantAnalysis(snapshot, simulation) {
  const roi = snapshot.cashOnCash;
// Enhanced constraint checking with detailed warnings and suggestions
function checkConstraintsEnhanced() {
  const totalWashers = washerDefs.reduce((sum, w) => sum + w.count, 0);
  const totalDryers = dryerDefs.reduce((sum, d) => sum + d.count, 0);
  const totalMachines = totalWashers + totalDryers;
  
  const totalSqft = +$("#totalSqft").value;
  const stalls = +$("#stalls").value;
  const machinesPerStall = +$("#machinesPerStall").value;
  const sqftWasher = +$("#sqftWasher").value;
  const sqftDryer = +$("#sqftDryer").value;
  
  const requiredSqft = totalWashers * sqftWasher + totalDryers * sqftDryer;
  const maxMachinesByParking = stalls * machinesPerStall;
  const spaceSurplus = totalSqft - requiredSqft;
  const parkingSurplus = maxMachinesByParking - totalMachines;
  
  let warnings = [];
  let suggestions = [];
  
  // Space Analysis
  if (requiredSqft > totalSqft) {
    const shortage = requiredSqft - totalSqft;
    const pctShortage = (shortage / totalSqft * 100).toFixed(1);
    warnings.push(`üö® CRITICAL: Space shortage of ${shortage} sq ft (${pctShortage}% over capacity)`);
    
    const avgSqftPerMachine = (totalWashers * sqftWasher + totalDryers * sqftDryer) / totalMachines;
    const machinesReduction = Math.ceil(shortage / avgSqftPerMachine);
    suggestions.push(`üí° Reduce by ${machinesReduction} machines OR increase space to ${requiredSqft.toLocaleString()} sq ft`);
    
    const maxMachinesForSpace = Math.floor(totalSqft / avgSqftPerMachine);
    suggestions.push(`üí° Maximum machines for ${totalSqft.toLocaleString()} sq ft: ${maxMachinesForSpace} units`);
  } else if (spaceSurplus > 0) {
    const utilizationPct = (requiredSqft / totalSqft * 100).toFixed(1);
    const potentialMachines = Math.floor(spaceSurplus / 25);
    
    if (utilizationPct < 85) {
      suggestions.push(`üí° Space underutilized: ${utilizationPct}% used, could add ${potentialMachines} more machines`);
    } else {
      suggestions.push(`‚úÖ Good space utilization: ${utilizationPct}% (15% buffer for aisles/folding)`);
    }
  }
  
  // Parking Analysis
  if (totalMachines > maxMachinesByParking) {
    const shortage = totalMachines - maxMachinesByParking;
    const pctOverParking = (shortage / maxMachinesByParking * 100).toFixed(1);
    warnings.push(`üö® CRITICAL: Parking shortage for ${shortage} machines (${pctOverParking}% over capacity)`);
    
    suggestions.push(`üí° Solutions: Add ${Math.ceil(shortage / machinesPerStall)} parking stalls OR reduce to ${maxMachinesByParking} machines`);
    suggestions.push(`üí° Alternative: Increase machines per stall to ${Math.ceil(totalMachines / stalls)} (requires larger stalls)`);
  } else if (parkingSurplus > 0) {
    const utilizationPct = (totalMachines / maxMachinesByParking * 100).toFixed(1);
    
    if (utilizationPct < 75) {
      const potentialMachines = Math.floor(parkingSurplus * 0.8);
      suggestions.push(`üí° Parking underutilized: ${utilizationPct}% used, could support ${potentialMachines} more machines`);
    } else {
      suggestions.push(`‚úÖ Good parking utilization: ${utilizationPct}% (adequate customer convenience)`);
    }
  }
  
  // Density Analysis
  const machinesPerStall_actual = totalMachines / stalls;
  const sqftPerMachine = totalSqft / totalMachines;
  
  if (machinesPerStall_actual > 3.5) {
    warnings.push(`‚ö†Ô∏è High machine density: ${machinesPerStall_actual.toFixed(1)} machines per stall may create congestion`);
  }
  
  if (sqftPerMachine < 22) {
    warnings.push(`‚ö†Ô∏è Cramped layout: ${sqftPerMachine.toFixed(1)} sq ft per machine (industry minimum: 25 sq ft)`);
  } else if (sqftPerMachine > 35) {
    suggestions.push(`üí° Spacious layout: ${sqftPerMachine.toFixed(1)} sq ft per machine allows for premium positioning`);
  }
  
  // Equipment Mix Analysis
  const washerToDryerRatio = totalWashers / totalDryers;
  if (washerToDryerRatio < 0.8) {
    suggestions.push(`üí° Consider more washers: Current ratio ${washerToDryerRatio.toFixed(2)}:1 (optimal: 1:1 to 1.2:1)`);
  } else if (washerToDryerRatio > 1.3) {
    suggestions.push(`üí° Consider more dryers: Current ratio ${washerToDryerRatio.toFixed(2)}:1 (optimal: 1:1 to 1.2:1)`);
  } else {
    suggestions.push(`‚úÖ Good washer-dryer balance: ${washerToDryerRatio.toFixed(2)}:1 ratio`);
  }
  
  // Display results
  const constraintEl = document.getElementById("constraintNote");
  
  if (warnings.length > 0 || suggestions.length > 0) {
    let content = "";
    
    if (warnings.length > 0) {
      content += `<div style="color:#dc2626; font-weight:bold; margin-bottom:8px">${warnings.join("<br>")}</div>`;
    }
    
    if (suggestions.length > 0) {
      content += `<div style="color:#059669; font-size:11px">${suggestions.join("<br>")}</div>`;
    }
    
    constraintEl.innerHTML = content;
    constraintEl.style.display = "block";
    constraintEl.style.background = warnings.length > 0 ? "#2a1f0a" : "#0a2a1a";
    constraintEl.style.border = warnings.length > 0 ? "1px dashed #dc2626" : "1px solid #059669";
    constraintEl.style.borderRadius = "8px";
    constraintEl.style.padding = "8px";
    constraintEl.style.marginTop = "8px";
  } else {
    constraintEl.style.display = "none";
  }
}
  const dscr = snapshot.dscr;
  const ebitdaMargin = (snapshot.ebitda / snapshot.grossRevenue) * 100;
  const debtToEquity = snapshot.totalDebt / snapshot.cashInv;
  const paybackYears = simulation.paybackYears;
  
  // Calculate additional detailed metrics
  const revenuePerMachine = snapshot.grossRevenue / (washerDefs.reduce((s,w) => s + w.count, 0) + dryerDefs.reduce((s,d) => s + d.count, 0));
  const revenuePerSqft = snapshot.grossRevenue / (+$("#totalSqft").value);
  const operatingRatio = ((snapshot.grossRevenue - snapshot.ebitda) / snapshot.grossRevenue) * 100;
  const debtServiceCoverage = snapshot.ebitda / (snapshot.debtService || 1);
  const workingCapitalRatio = (+$("#workingCap").value) / (snapshot.grossRevenue * 12) * 100;
  const rentToRevenueRatio = (snapshot.rent / snapshot.grossRevenue) * 100;
  const laborEfficiency = snapshot.laborCost / snapshot.grossRevenue * 100;
  const utilityEfficiency = snapshot.utilities.total / snapshot.grossRevenue * 100;
  const maintenanceRatio = snapshot.maintenance / snapshot.grossRevenue * 100;
  
  // ENHANCED FINANCIAL ANALYSIS - Based on Advanced Accounting & Finance Principles
  
  // 1. LIQUIDITY ANALYSIS (Current Assets vs Current Liabilities)
  const workingCapital = +$("#workingCap").value;
  const monthlyOperatingExpenses = Math.max((snapshot.grossRevenue - snapshot.ebitda), 1000); // Ensure minimum value
  const currentRatio = workingCapital / monthlyOperatingExpenses; // Months of expenses covered
  const quickRatio = workingCapital * 0.8 / monthlyOperatingExpenses; // Conservative liquid assets
  
  // 2. LEVERAGE ANALYSIS (Financial Risk Assessment)
  const totalAssets = snapshot.projCost + workingCapital;
  const totalEquity = Math.max(snapshot.cashInv, snapshot.projCost * 0.1); // Minimum 10% equity assumption
  const debtToAssetRatio = (snapshot.totalDebt || 0) / totalAssets;
  const equityMultiplier = totalAssets / totalEquity;
  const interestCoverageRatio = (snapshot.debtService && snapshot.debtService > 0) ? (snapshot.ebitda * 12) / (snapshot.debtService * 12 * 0.7) : Infinity;
  
  // 3. PROFITABILITY ANALYSIS (DuPont Analysis Framework)
  const netProfitMargin = ebitdaMargin; // Using EBITDA as proxy for net income
  const assetTurnover = (snapshot.grossRevenue * 12) / totalAssets;
  const returnOnAssets = (netProfitMargin / 100) * assetTurnover * 100;
  const returnOnEquity = Math.min(returnOnAssets * equityMultiplier, 999); // Cap at 999% for display
  
  // 4. OPERATING EFFICIENCY ANALYSIS
  const totalMachines = washerDefs.reduce((s,w) => s + w.count, 0) + dryerDefs.reduce((s,d) => s + d.count, 0);
  const assetUtilization = (snapshot.grossRevenue * 12) / (snapshot.projCost * 0.7); // Equipment represents ~70% of total assets
  const inventoryTurnover = 52; // Weekly cash collection typical for laundromats
  const receivablesDays = 0; // Cash business
  const payablesDays = 30; // Typical vendor payment terms
  
  // 5. CASH CONVERSION CYCLE
  const cashConversionCycle = receivablesDays + 7 - payablesDays; // 7 days for cash on hand
  
  // 6. ECONOMIC VALUE ADDED (EVA) ANALYSIS
  const weightedAverageCostOfCapital = 0.08; // Estimated WACC for laundromat business
  const nopat = snapshot.ebitda * 0.75; // Net Operating Profit After Tax (estimated)
  const economicValueAdded = (nopat * 12) - (totalAssets * weightedAverageCostOfCapital);
  
  // 7. BUSINESS SUSTAINABILITY METRICS
  const capitalExpenditure = snapshot.projCost * 0.05; // Estimated annual CapEx for maintenance
  const freeCashFlow = (snapshot.ebitda * 12) - capitalExpenditure;
  const cashFlowToDebtRatio = (snapshot.totalDebt && snapshot.totalDebt > 0) ? freeCashFlow / snapshot.totalDebt : 1; // If no debt, ratio is 1 (100%)
  
  // 8. MARKET POSITIONING ANALYSIS
  const industryAvgROA = 0.12; // Industry benchmark
  const industryAvgDSCR = 1.35;
  const industryAvgMargin = 32;
  const competitiveAdvantage = {
    roa: returnOnAssets > industryAvgROA * 100,
    dscr: dscr > industryAvgDSCR,
    margin: ebitdaMargin > industryAvgMargin
  };
  
  // 9. COMPREHENSIVE RESILIENCY STRESS TESTING  
  // Define hasDebt early for use in stress testing
  const hasDebt = snapshot.totalDebt && snapshot.totalDebt > 0;
  
  const stressTests = {
    // Revenue stress scenarios
    revenueDown10: {
      revenue: snapshot.grossRevenue * 0.9,
      ebitda: snapshot.ebitda - (snapshot.grossRevenue * 0.1),
      description: "10% Revenue Drop"
    },
    revenueDown20: {
      revenue: snapshot.grossRevenue * 0.8,
      ebitda: snapshot.ebitda - (snapshot.grossRevenue * 0.2),
      description: "20% Revenue Drop (Recession)"
    },
    revenueDown30: {
      revenue: snapshot.grossRevenue * 0.7,
      ebitda: snapshot.ebitda - (snapshot.grossRevenue * 0.3),
      description: "30% Revenue Drop (Severe Crisis)"
    },
    
    // Expense stress scenarios
    rentUp25: {
      revenue: snapshot.grossRevenue,
      ebitda: snapshot.ebitda - (snapshot.rent * 0.25),
      description: "25% Rent Increase"
    },
    utilityUp50: {
      revenue: snapshot.grossRevenue,
      ebitda: snapshot.ebitda - (snapshot.utilities.total * 0.5),
      description: "50% Utility Cost Increase"
    },
    laborUp30: {
      revenue: snapshot.grossRevenue,
      ebitda: snapshot.ebitda - (snapshot.laborCost * 0.3),
      description: "30% Labor Cost Increase"
    },
    
    // Combined worst-case scenario
    worstCase: {
      revenue: snapshot.grossRevenue * 0.75,
      ebitda: Math.max(0, snapshot.ebitda - (snapshot.grossRevenue * 0.25) - (snapshot.rent * 0.2) - (snapshot.utilities.total * 0.3)),
      description: "Combined Crisis (25% revenue drop + 20% rent + 30% utilities)"
    }
  };
  
  // Calculate stress test results
  let stressResults = {};
  let worstCaseDSCR = Infinity;
  let criticalFailures = 0;
  
  Object.keys(stressTests).forEach(testName => {
    const test = stressTests[testName];
    // FIXED: Correct ROI calculation for stress scenarios  
    // Calculate stress ROI with NaN protection
    let stressedROI = -100; // Default to failure
    if (hasDebt && snapshot.debtService && snapshot.cashInv > 0) {
      stressedROI = ((test.ebitda - snapshot.debtService) * 12 / snapshot.cashInv) * 100;
    } else if (!hasDebt && snapshot.projCost > 0) {
      stressedROI = (test.ebitda * 12 / snapshot.projCost) * 100;
    }
    
    // Final NaN check - this was causing the display issues
    const finalStressedROI = (isNaN(stressedROI) || !isFinite(stressedROI)) ? -100 : stressedROI; 
    const stressedDSCR = hasDebt ? test.ebitda / (snapshot.debtService || 1) : Infinity;
    const stressedMargin = (test.ebitda / test.revenue) * 100;
    
    stressResults[testName] = {
      roi: finalStressedROI,
      dscr: stressedDSCR,
      margin: stressedMargin,
      survivable: finalStressedROI > 5 && (stressedDSCR > 1.1 || !hasDebt),
      description: test.description
    };
    
    if (stressedDSCR < worstCaseDSCR && hasDebt) worstCaseDSCR = stressedDSCR;
    if (!stressResults[testName].survivable) criticalFailures++;
  });
  
  // Business Resiliency Score (0-100)
  // FIXED: Resiliency Score calculation for all-cash vs debt scenarios
  let resiliencyScore;
  if (hasDebt) {
    // With debt: penalize for DSCR failures and critical test failures
    resiliencyScore = Math.max(0, 100 - (criticalFailures * 15) - (worstCaseDSCR < 1.0 ? 30 : 0));
  } else {
    // All-cash: only penalize for critical ROI failures
    const survivableTests = Object.values(stressResults).filter(r => r.survivable).length;
    const totalTests = Object.keys(stressTests).length;
    resiliencyScore = Math.max(0, (survivableTests / totalTests) * 100);
  }
  
  let resiliencyGrade = 'F';
  if (resiliencyScore >= 85) resiliencyGrade = 'A+';
  else if (resiliencyScore >= 75) resiliencyGrade = 'A';
  else if (resiliencyScore >= 65) resiliencyGrade = 'B+';
  else if (resiliencyScore >= 55) resiliencyGrade = 'B';
  else if (resiliencyScore >= 45) resiliencyGrade = 'C+';
  else if (resiliencyScore >= 35) resiliencyGrade = 'C';
  else if (resiliencyScore >= 25) resiliencyGrade = 'D';
  
  // 10. FINANCIAL HEALTH SCORE (0-100 scale) - Enhanced with resiliency
  let healthScore = 0;
  
  // Ensure all values are valid numbers before calculation
  const safeROI = isNaN(roi) || !isFinite(roi) ? 0 : roi;
  const safeDSCR = isNaN(dscr) || !isFinite(dscr) ? 0 : dscr;
  const safeEBITDAMargin = isNaN(ebitdaMargin) || !isFinite(ebitdaMargin) ? 0 : ebitdaMargin;
  const safeCurrentRatio = isNaN(currentRatio) || !isFinite(currentRatio) ? 0 : currentRatio;
  const safeDebtToAssetRatio = isNaN(debtToAssetRatio) || !isFinite(debtToAssetRatio) ? 0 : debtToAssetRatio;
  
  healthScore += Math.min(Math.max(safeROI / 20 * 20, 0), 20); // ROI component (max 20 points)
  healthScore += Math.min(Math.max(safeDSCR / 1.25 * 15, 0), 15); // DSCR component (max 15 points)
  healthScore += Math.min(Math.max(safeEBITDAMargin / 35 * 15, 0), 15); // Margin component (max 15 points)
  healthScore += Math.min(Math.max(safeCurrentRatio / 3 * 10, 0), 10); // Liquidity component (max 10 points)
  healthScore += Math.min(Math.max((1 - safeDebtToAssetRatio) * 15, 0), 15); // Leverage component (max 15 points)
  healthScore += Math.min(Math.max(resiliencyScore / 100 * 25, 0), 25); // Resiliency component (max 25 points)
  
  let analysis = "";
  let healthMetrics = "";
  
  // Overall Assessment with detailed reasoning incorporating advanced financial analysis
  let overallGrade = 'F';
  if (healthScore >= 85) overallGrade = 'A+';
  else if (healthScore >= 75) overallGrade = 'A';
  else if (healthScore >= 65) overallGrade = 'B+';
  else if (healthScore >= 55) overallGrade = 'B';
  else if (healthScore >= 45) overallGrade = 'C+';
  else if (healthScore >= 35) overallGrade = 'C';
  else if (healthScore >= 25) overallGrade = 'D';
  
  // Enhanced assessment logic - Align grades with recommendations using combined scoring
  const dscr_effective = hasDebt ? dscr : 99; // If no debt, DSCR is effectively infinite (very good)
  
  // Determine final grade based on BOTH health score AND ROI performance (not just health score alone)
  let finalGrade = overallGrade;
  let recommendation = "";
  
  if (roi >= 25 && (dscr_effective >= 1.5 || !hasDebt) && healthScore >= 75) {
    finalGrade = 'A+';
    recommendation = 'üéØ EXCELLENT INVESTMENT!';
    analysis = `<strong>${recommendation} (Grade: ${finalGrade})</strong><br>
    <strong>Financial Health Score: ${healthScore.toFixed(0)}/100 | Resiliency Score: ${resiliencyScore.toFixed(0)}/100 (${resiliencyGrade})</strong><br>
    This laundromat demonstrates superior financial performance with ${roi.toFixed(1)}% cash-on-cash return ${hasDebt ? `and ${dscr.toFixed(2)} DSCR` : '(all-cash purchase)'}. Your ROA of ${returnOnAssets.toFixed(1)}% exceeds industry standards, while the ${economicValueAdded > 0 ? 'positive' : 'negative'} Economic Value Added of ${money(economicValueAdded)} indicates ${economicValueAdded > 0 ? 'value creation' : 'value destruction'}.`;
  } else if (roi >= 20 && (dscr_effective >= 1.25 || !hasDebt) && healthScore >= 60) {
    finalGrade = healthScore >= 75 ? 'A' : 'B+';
    recommendation = '‚úÖ STRONG BUY';
    analysis = `<strong>${recommendation} (Grade: ${finalGrade})</strong><br>
    <strong>Financial Health Score: ${healthScore.toFixed(0)}/100 | Resiliency Score: ${resiliencyScore.toFixed(0)}/100 (${resiliencyGrade})</strong><br>
    This investment meets industry standards with strong fundamentals. The ${currentRatio.toFixed(1)} months of operating expense coverage provides adequate liquidity${hasDebt ? `, and debt-to-asset ratio of ${(debtToAssetRatio * 100).toFixed(1)}% indicates prudent leverage management` : ' with debt-free ownership providing maximum financial flexibility'}.`;
  } else if (roi >= 15 && (dscr_effective >= 1.1 || !hasDebt) && healthScore >= 40) {
    // For this range, grade should reflect the mixed performance (good health but low ROI)
    finalGrade = healthScore >= 75 ? 'B+' : healthScore >= 65 ? 'B' : 'C+';
    recommendation = '‚ö†Ô∏è PROCEED WITH CAUTION';
    analysis = `<strong>${recommendation} (Grade: ${finalGrade})</strong><br>
    <strong>Financial Health Score: ${healthScore.toFixed(0)}/100 | Resiliency Score: ${resiliencyScore.toFixed(0)}/100 (${resiliencyGrade})</strong><br>
    Returns of ${roi.toFixed(1)}% fall short of benchmarks. Current ratio of ${currentRatio.toFixed(1)} months suggests ${currentRatio < 2 ? 'tight' : 'adequate'} liquidity. ${hasDebt ? `Interest coverage ratio of ${interestCoverageRatio.toFixed(1)}√ó indicates ${interestCoverageRatio < 2 ? 'stressed' : 'manageable'} debt service capacity.` : 'All-cash purchase eliminates debt service risk but returns remain below target.'}`;
  } else {
    finalGrade = healthScore >= 50 ? 'D' : 'F';
    recommendation = '‚ùå PASS ON THIS DEAL';
    analysis = `<strong>${recommendation} (Grade: ${finalGrade})</strong><br>
    <strong>Financial Health Score: ${healthScore.toFixed(0)}/100 | Resiliency Score: ${resiliencyScore.toFixed(0)}/100 (${resiliencyGrade})</strong><br>
    This investment fails fundamental financial tests with ${roi.toFixed(1)}% returns below acceptable thresholds. ${hasDebt ? `Free cash flow of ${money(freeCashFlow)} provides insufficient coverage for debt obligations.` : `Even with all-cash purchase eliminating debt risk, the ${roi.toFixed(1)}% return is inadequate.`} Focus on operational improvements or walk away.`;
  }
  
  // ADVANCED FINANCIAL ANALYSIS SECTION
  analysis += `<br><br><strong>üìä Advanced Financial Analysis (Based on MBA-Level Finance Principles):</strong><br>`;
  
  // DuPont Analysis
  analysis += `<strong>DuPont ROA Decomposition:</strong><br>`;
  analysis += `‚Ä¢ Asset Turnover: ${assetTurnover.toFixed(2)}√ó (Revenue/Assets) - ${assetTurnover > 0.5 ? 'Excellent' : assetTurnover > 0.3 ? 'Good' : 'Poor'} asset utilization<br>`;
  analysis += `‚Ä¢ Net Profit Margin: ${netProfitMargin.toFixed(1)}% - ${netProfitMargin > 30 ? 'Superior' : netProfitMargin > 25 ? 'Good' : 'Below Average'} operational efficiency<br>`;
  analysis += `‚Ä¢ Return on Assets: ${returnOnAssets.toFixed(1)}% vs Industry ${industryAvgROA * 100}% ${competitiveAdvantage.roa ? '(Above Average ‚úì)' : '(Below Average ‚ö†Ô∏è)'}<br>`;
  analysis += `‚Ä¢ Return on Equity: ${returnOnEquity.toFixed(1)}% - Leveraged return to investors<br><br>`;
  
  // Liquidity & Working Capital Analysis
  analysis += `<strong>Liquidity & Working Capital Management:</strong><br>`;
  analysis += `‚Ä¢ Current Ratio: ${currentRatio.toFixed(1)} months of operating expenses covered ${currentRatio >= 3 ? '(Strong ‚úì)' : currentRatio >= 2 ? '(Adequate)' : '(Weak ‚ö†Ô∏è)'}<br>`;
  analysis += `‚Ä¢ Quick Ratio: ${quickRatio.toFixed(1)} months (Conservative liquidity measure)<br>`;
  analysis += `‚Ä¢ Cash Conversion Cycle: ${cashConversionCycle} days - ${cashConversionCycle < 0 ? 'Negative (cash generated before paying suppliers)' : 'Positive cash requirement'}<br>`;
  analysis += `‚Ä¢ Working Capital Management: ${workingCapitalRatio.toFixed(1)}% of annual revenue<br><br>`;
  
  // Leverage & Risk Analysis
  analysis += `<strong>Leverage & Financial Risk Assessment:</strong><br>`;
  analysis += `‚Ä¢ Debt-to-Asset Ratio: ${(debtToAssetRatio * 100).toFixed(1)}% - ${debtToAssetRatio < 0.6 ? 'Conservative' : debtToAssetRatio < 0.75 ? 'Moderate' : 'Aggressive'} leverage<br>`;
  analysis += `‚Ä¢ Equity Multiplier: ${equityMultiplier.toFixed(1)}√ó - Financial leverage amplification factor<br>`;
  analysis += `‚Ä¢ Interest Coverage: ${interestCoverageRatio.toFixed(1)}√ó EBITDA ${interestCoverageRatio >= 3 ? '(Strong ‚úì)' : interestCoverageRatio >= 2 ? '(Adequate)' : '(Weak ‚ö†Ô∏è)'}<br>`;
  analysis += `‚Ä¢ Cash Flow to Debt: ${(cashFlowToDebtRatio * 100).toFixed(1)}% - ${cashFlowToDebtRatio > 0.2 ? 'Strong' : cashFlowToDebtRatio > 0.1 ? 'Adequate' : 'Weak'} debt coverage<br><br>`;
  
  // Economic Value Analysis
  analysis += `<strong>Economic Value Creation Analysis:</strong><br>`;
  analysis += `‚Ä¢ Economic Value Added (EVA): ${money(economicValueAdded)} ${economicValueAdded > 0 ? '(Value Creating ‚úì)' : '(Value Destroying ‚ö†Ô∏è)'}<br>`;
  analysis += `‚Ä¢ WACC Estimate: ${(weightedAverageCostOfCapital * 100).toFixed(1)}% - Cost of capital benchmark<br>`;
  analysis += `‚Ä¢ Free Cash Flow: ${money(freeCashFlow)} available for growth/distributions<br>`;
  analysis += `‚Ä¢ Capital Efficiency: ${((snapshot.ebitda * 12) / snapshot.projCost * 100).toFixed(1)}% EBITDA yield on invested capital<br><br>`;
  
  // INTEGRATED RESILIENCY STRESS TESTING RESULTS
  analysis += `<strong>üî¨ Business Resiliency Stress Testing (Grade: ${resiliencyGrade}):</strong><br>`;
  analysis += `<strong>Overall Resiliency Score: ${resiliencyScore.toFixed(0)}/100</strong><br>`;
  
  // Show stress test results in a structured format
  const stressTestNames = Object.keys(stressResults);
  let survivableTests = 0;
  stressTestNames.forEach(testName => {
    const result = stressResults[testName];
    if (result.survivable) survivableTests++;
    const statusIcon = result.survivable ? '‚úÖ' : '‚ùå';
    const statusColor = result.survivable ? '#22c55e' : '#ef4444';
    analysis += `‚Ä¢ <span style="color:${statusColor}">${statusIcon} <strong>${result.description}:</strong> ROI ${result.roi.toFixed(1)}%${hasDebt ? `, DSCR ${result.dscr.toFixed(2)}` : ''}, Margin ${result.margin.toFixed(1)}%</span><br>`;
  });
  
  analysis += `<strong>Stress Test Summary:</strong> ${survivableTests}/${stressTestNames.length} scenarios survivable<br>`;
  
  if (resiliencyScore >= 85) {
    analysis += `<span style="color:#22c55e"><strong>Resiliency Assessment:</strong> Excellent - Business can withstand multiple adverse scenarios</span><br>`;
  } else if (resiliencyScore >= 65) {
    analysis += `<span style="color:#f59e0b"><strong>Resiliency Assessment:</strong> Good - Business shows reasonable stress tolerance</span><br>`;
  } else if (resiliencyScore >= 45) {
    analysis += `<span style="color:#f59e0b"><strong>Resiliency Assessment:</strong> Moderate - Vulnerable to significant economic stress</span><br>`;
  } else {
    analysis += `<span style="color:#ef4444"><strong>Resiliency Assessment:</strong> Poor - High risk of failure under adverse conditions</span><br>`;
  }
  
  // Critical vulnerabilities
  if (criticalFailures > 3) {
    analysis += `<span style="color:#ef4444"><strong>‚ö†Ô∏è Critical Risk:</strong> Business fails ${criticalFailures} stress scenarios - extremely vulnerable</span><br>`;
  } else if (criticalFailures > 1) {
    analysis += `<span style="color:#f59e0b"><strong>‚ö†Ô∏è Moderate Risk:</strong> Business fails ${criticalFailures} stress scenarios - consider risk mitigation</span><br>`;
  } else if (criticalFailures === 0) {
    analysis += `<span style="color:#22c55e"><strong>‚úì Strong Resilience:</strong> Business survives all stress test scenarios</span><br>`;
  }
  analysis += `<br>`;
  
  // Detailed Operational Analysis
  analysis += `<br><strong>üîç Detailed Operational Analysis:</strong><br>`;
  
  // Revenue efficiency analysis
  if (revenuePerMachine >= 1800) {
    analysis += `‚Ä¢ <span style="color:#22c55e">Revenue per machine: ${money(revenuePerMachine)} - Excellent utilization</span><br>`;
  } else if (revenuePerMachine >= 1400) {
    analysis += `‚Ä¢ <span style="color:#f59e0b">Revenue per machine: ${money(revenuePerMachine)} - Average performance, room for improvement</span><br>`;
  } else {
    analysis += `‚Ä¢ <span style="color:#ef4444">Revenue per machine: ${money(revenuePerMachine)} - Poor utilization, major concern</span><br>`;
  }
  
  // Space efficiency
  if (revenuePerSqft >= 18) {
    analysis += `‚Ä¢ <span style="color:#22c55e">Revenue density: ${money(revenuePerSqft)}/sq ft - Excellent space utilization</span><br>`;
  } else if (revenuePerSqft >= 14) {
    analysis += `‚Ä¢ <span style="color:#f59e0b">Revenue density: ${money(revenuePerSqft)}/sq ft - Adequate space usage</span><br>`;
  } else {
    analysis += `‚Ä¢ <span style="color:#ef4444">Revenue density: ${money(revenuePerSqft)}/sq ft - Underutilized space</span><br>`;
  }
  
  // Expense ratio analysis
  if (operatingRatio <= 65) {
    analysis += `‚Ä¢ <span style="color:#22c55e">Operating ratio: ${operatingRatio.toFixed(1)}% - Efficient cost structure</span><br>`;
  } else if (operatingRatio <= 75) {
    analysis += `‚Ä¢ <span style="color:#f59e0b">Operating ratio: ${operatingRatio.toFixed(1)}% - Acceptable cost control</span><br>`;
  } else {
    analysis += `‚Ä¢ <span style="color:#ef4444">Operating ratio: ${operatingRatio.toFixed(1)}% - High expenses require attention</span><br>`;
  }
  
  // Rent burden analysis
  if (rentToRevenueRatio <= 25) {
    analysis += `‚Ä¢ <span style="color:#22c55e">Rent burden: ${rentToRevenueRatio.toFixed(1)}% of revenue - Reasonable location cost</span><br>`;
  } else if (rentToRevenueRatio <= 30) {
    analysis += `‚Ä¢ <span style="color:#f59e0b">Rent burden: ${rentToRevenueRatio.toFixed(1)}% of revenue - Manageable but high</span><br>`;
  } else {
    analysis += `‚Ä¢ <span style="color:#ef4444">Rent burden: ${rentToRevenueRatio.toFixed(1)}% of revenue - Excessive rent risk</span><br>`;
  }
  
  // ENHANCED STRATEGIC RECOMMENDATIONS - Based on Advanced Financial Management
  // MONTE CARLO RISK INTEGRATION - Incorporate probabilistic analysis
  if (window.monteCarloResults && window.monteCarloResults.results) {
    const mcStats = window.monteCarloResults.results;
    const successProb = mcStats.probabilities.targetROI;
    
    analysis += `<br><strong>üé≤ Monte Carlo Risk Assessment Integration:</strong><br>`;
    
    if (successProb >= 70) {
      analysis += `‚Ä¢ <span style="color:#22c55e">HIGH CONFIDENCE: ${successProb.toFixed(1)}% probability of achieving 20%+ ROI - Monte Carlo confirms traditional analysis</span><br>`;
    } else if (successProb >= 50) {
      analysis += `‚Ä¢ <span style="color:#f59e0b">MODERATE CONFIDENCE: ${successProb.toFixed(1)}% probability of achieving 20%+ ROI - volatility adds uncertainty to traditional metrics</span><br>`;
      analysis += `‚Ä¢ <span style="color:#f59e0b">RECOMMENDATION: Consider negotiating better deal terms or implementing risk mitigation strategies</span><br>`;
    } else {
      analysis += `‚Ä¢ <span style="color:#ef4444">LOW CONFIDENCE: Only ${successProb.toFixed(1)}% probability of achieving 20%+ ROI - Monte Carlo reveals high downside risk</span><br>`;
      analysis += `‚Ä¢ <span style="color:#ef4444">STRONG RECOMMENDATION: This deal requires significant improvements or should be avoided entirely</span><br>`;
      
      // Adjust grade down if Monte Carlo shows high risk
      if (finalGrade === 'A+' || finalGrade === 'A') finalGrade = 'B+';
      else if (finalGrade === 'B+' || finalGrade === 'B') finalGrade = 'C+';
      else if (finalGrade === 'C+' || finalGrade === 'C') finalGrade = 'D';
    }
    
    // Add specific Monte Carlo insights
    const volatility = mcStats.roi ? mcStats.roi.stdDev : 0;
    if (volatility > 20) {
      analysis += `‚Ä¢ <span style="color:#f59e0b">HIGH VOLATILITY: ${volatility.toFixed(1)}% standard deviation indicates unpredictable returns - consider shorter investment horizon</span><br>`;
    }
    
    const worstCase = mcStats.roi ? mcStats.roi.p5 : 0;
    if (worstCase < 0) {
      analysis += `‚Ä¢ <span style="color:#ef4444">DOWNSIDE RISK: 5% chance of negative returns (${worstCase.toFixed(1)}%) - ensure adequate contingency reserves</span><br>`;
    }
  } else {
    analysis += `<br><strong>üé≤ Monte Carlo Analysis:</strong> <em>Run Monte Carlo simulation for probabilistic risk assessment</em><br>`;
  }

  analysis += `<br><strong>üìà Strategic Recommendations (Financial Management Best Practices):</strong><br>`;
  
  // Capital Structure Optimization
  if (debtToAssetRatio > 0.75) {
    analysis += `‚Ä¢ <span style="color:#ef4444">CAPITAL STRUCTURE: Reduce leverage from ${(debtToAssetRatio * 100).toFixed(1)}% to below 70% debt-to-assets for improved financial flexibility</span><br>`;
  } else if (debtToAssetRatio < 0.4 && roi > 15) {
    analysis += `‚Ä¢ <span style="color:#22c55e">LEVERAGE OPPORTUNITY: Current ${(debtToAssetRatio * 100).toFixed(1)}% leverage is conservative - consider modest debt increase to amplify returns</span><br>`;
  }
  
  // Working Capital Management
  if (currentRatio < 2) {
    const additionalWC = (2 - currentRatio) * monthlyOperatingExpenses;
    analysis += `‚Ä¢ <span style="color:#f59e0b">LIQUIDITY ENHANCEMENT: Increase working capital by ${money(additionalWC)} to achieve 2-month operating expense buffer</span><br>`;
  } else if (currentRatio > 6) {
    const excessWC = (currentRatio - 4) * monthlyOperatingExpenses;
    analysis += `‚Ä¢ <span style="color:#22c55e">EXCESS LIQUIDITY: ${money(excessWC)} in excess working capital could be deployed for growth investments</span><br>`;
  }
  
  // Economic Value Optimization
  if (economicValueAdded < 0) {
    const requiredROA = weightedAverageCostOfCapital * 100;
    analysis += `‚Ä¢ <span style="color:#ef4444">VALUE DESTRUCTION: Current ROA of ${returnOnAssets.toFixed(1)}% below WACC of ${requiredROA.toFixed(1)}% - focus on margin improvement or asset reduction</span><br>`;
  }
  
  // Resiliency-Based Strategic Recommendations
  if (criticalFailures > 0) {
    analysis += `‚Ä¢ <span style="color:#f59e0b">RISK MITIGATION: Failed ${criticalFailures} stress tests. Diversify revenue streams and reduce fixed costs to improve resilience</span><br>`;
  }
  
  if (resiliencyScore < 50 && hasDebt) {
    analysis += `‚Ä¢ <span style="color:#ef4444">EMERGENCY PLANNING: Low resiliency score with debt requires contingency planning for revenue shortfalls and potential debt restructuring</span><br>`;
  }
  
  if (worstCaseDSCR < 1.0 && hasDebt) {
    analysis += `‚Ä¢ <span style="color:#ef4444">DEBT RESTRUCTURING: Worst-case DSCR of ${worstCaseDSCR.toFixed(2)} indicates debt service vulnerability - consider refinancing or partial prepayment</span><br>`;
  }
  
  // Asset Utilization Enhancement
  if (assetTurnover < 0.4) {
    analysis += `‚Ä¢ <span style="color:#f59e0b">ASSET EFFICIENCY: Low asset turnover of ${assetTurnover.toFixed(2)}√ó suggests underutilized capacity - consider revenue enhancement strategies</span><br>`;
  }
  
  // ROI-Based Pricing Strategy
  if (roi < 20) {
    const targetPrice = snapshot.projCost * (roi / 20);
    const priceReduction = ((20/roi - 1) * 100).toFixed(0);
    analysis += `‚Ä¢ <span style="color:#f59e0b">PRICING NEGOTIATION: Target acquisition price of ${money(targetPrice)} (${priceReduction}% reduction) to achieve industry standard 20% ROI threshold</span><br>`;
    
    // Alternative financing structure recommendation
    const higherDownPayment = snapshot.cashInv * 1.5;
    const newDebtAmount = snapshot.projCost - higherDownPayment;
    analysis += `‚Ä¢ <span style="color:#f59e0b">FINANCING ALTERNATIVE: Increase down payment to ${money(higherDownPayment)} to reduce debt service and improve returns</span><br>`;
  }
  
  // Cash Flow Management
  if (freeCashFlow < snapshot.projCost * 0.1) {
    analysis += `‚Ä¢ <span style="color:#ef4444">CASH FLOW RISK: Free cash flow of ${money(freeCashFlow)} provides insufficient reinvestment capacity - focus on EBITDA improvement</span><br>`;
  }
  
  // Risk Management Recommendations
  if (interestCoverageRatio < 2.5) {
    analysis += `‚Ä¢ <span style="color:#ef4444">INTEREST RATE RISK: Low coverage ratio of ${interestCoverageRatio.toFixed(1)}√ó - consider fixed-rate financing to mitigate rate exposure</span><br>`;
  }
  
  // Operational Efficiency Targets
  if (laborEfficiency > 15) {
    const targetLaborCost = snapshot.grossRevenue * 0.12;
    const laborSavings = snapshot.laborCost - targetLaborCost;
    analysis += `‚Ä¢ <span style="color:#f59e0b">LABOR OPTIMIZATION: Reduce labor costs by ${money(laborSavings)}/month to achieve 12% efficiency target</span><br>`;
  }
  
  if (maintenanceRatio > 10) {
    analysis += `‚Ä¢ <span style="color:#f59e0b">MAINTENANCE STRATEGY: ${maintenanceRatio.toFixed(1)}% maintenance ratio suggests equipment replacement consideration vs. ongoing repairs</span><br>`;
  }
  
  // Positive Value Drivers
  if (roi >= 20) analysis += `‚Ä¢ <span style="color:#22c55e">VALUE CREATION: ROI of ${roi.toFixed(1)}% exceeds cost of capital - strong value-creating investment</span><br>`;
  if (economicValueAdded > 0) analysis += `‚Ä¢ <span style="color:#22c55e">ECONOMIC PROFIT: Positive EVA of ${money(economicValueAdded)} indicates superior capital efficiency</span><br>`;
  if (returnOnAssets > industryAvgROA * 100) analysis += `‚Ä¢ <span style="color:#22c55e">COMPETITIVE ADVANTAGE: ROA of ${returnOnAssets.toFixed(1)}% outperforms industry average of ${(industryAvgROA * 100).toFixed(1)}%</span><br>`;
  
  // Financial Planning Recommendations
  analysis += `<br><strong>üíº Financial Planning & Risk Management:</strong><br>`;
  analysis += `‚Ä¢ Maintain minimum ${money(monthlyOperatingExpenses * 3)} emergency fund (3-month operating expenses)<br>`;
  analysis += `‚Ä¢ Consider ${(snapshot.projCost * 0.01 / 12).toFixed(0)} monthly equipment replacement reserve (1% of asset value)<br>`;
  analysis += `‚Ä¢ Monitor debt service coverage monthly - target minimum 1.35√ó for optimal banking relationships<br>`;
  if (snapshot.projCost > 500000) {
    analysis += `‚Ä¢ Consider professional property management to optimize operational efficiency and cash flow<br>`;
  }
  
  // ENHANCED HEALTH METRICS - Advanced Financial Dashboard
  healthMetrics = `
    <div style="margin-bottom:12px; padding:10px; background:#1a1a2e; border-radius:8px">
      <div style="text-align:center; margin-bottom:8px">
        <strong style="color:#60a5fa; font-size:14px">FINANCIAL HEALTH SCORE: ${healthScore.toFixed(0)}/100</strong>
        <div style="color:${healthScore >= 75 ? '#22c55e' : healthScore >= 60 ? '#f59e0b' : '#ef4444'}; font-size:18px; font-weight:bold">GRADE: ${finalGrade}</div>
      </div>
    </div>
    
    <div style="display:grid; grid-template-columns:1fr 1fr 1fr 1fr; gap:10px; margin-top:8px; font-size:10px">
      <div>
        <strong>üìä Profitability Analysis:</strong><br>
        Cash ROI: <span style="color:${roi >= 20 ? '#22c55e' : roi >= 15 ? '#f59e0b' : '#ef4444'}">${roi.toFixed(1)}%</span><br>
        Return on Assets: <span style="color:${returnOnAssets >= 12 ? '#22c55e' : returnOnAssets >= 8 ? '#f59e0b' : '#ef4444'}">${returnOnAssets.toFixed(1)}%</span><br>
        Return on Equity: <span style="color:${returnOnEquity >= 15 ? '#22c55e' : returnOnEquity >= 10 ? '#f59e0b' : '#ef4444'}">${returnOnEquity.toFixed(1)}%</span><br>
        EBITDA Margin: <span style="color:${ebitdaMargin >= 35 ? '#22c55e' : ebitdaMargin >= 25 ? '#f59e0b' : '#ef4444'}">${ebitdaMargin.toFixed(1)}%</span><br>
        Asset Turnover: <span style="color:${assetTurnover >= 0.5 ? '#22c55e' : assetTurnover >= 0.3 ? '#f59e0b' : '#ef4444'}">${assetTurnover.toFixed(2)}√ó</span>
      </div>
      <div>
        <strong>üí∞ Liquidity & Risk:</strong><br>
        Current Ratio: <span style="color:${currentRatio >= 3 ? '#22c55e' : currentRatio >= 2 ? '#f59e0b' : '#ef4444'}">${currentRatio.toFixed(1)} months</span><br>
        Quick Ratio: <span style="color:${quickRatio >= 2 ? '#22c55e' : quickRatio >= 1.5 ? '#f59e0b' : '#ef4444'}">${quickRatio.toFixed(1)} months</span><br>
        DSCR: <span style="color:${dscr >= 1.35 ? '#22c55e' : dscr >= 1.25 ? '#f59e0b' : '#ef4444'}">${dscr.toFixed(2)}</span><br>
        Interest Coverage: <span style="color:${interestCoverageRatio >= 3 ? '#22c55e' : interestCoverageRatio >= 2 ? '#f59e0b' : '#ef4444'}">${interestCoverageRatio.toFixed(1)}√ó</span><br>
        Working Capital: <span style="color:${workingCapitalRatio >= 5 ? '#22c55e' : workingCapitalRatio >= 3 ? '#f59e0b' : '#ef4444'}">${workingCapitalRatio.toFixed(1)}% revenue</span>
      </div>
      <div>
        <strong>‚öñÔ∏è Leverage Analysis:</strong><br>
        Debt-to-Assets: <span style="color:${debtToAssetRatio <= 0.6 ? '#22c55e' : debtToAssetRatio <= 0.75 ? '#f59e0b' : '#ef4444'}">${isNaN(debtToAssetRatio) ? '0.0' : (debtToAssetRatio * 100).toFixed(1)}%</span><br>
        Equity Multiplier: <span style="color:${equityMultiplier <= 3 ? '#22c55e' : equityMultiplier <= 4 ? '#f59e0b' : '#ef4444'}">${equityMultiplier.toFixed(1)}√ó</span><br>
        Cash Flow/Debt: <span style="color:${cashFlowToDebtRatio >= 0.2 ? '#22c55e' : cashFlowToDebtRatio >= 0.1 ? '#f59e0b' : '#ef4444'}">${hasDebt ? (cashFlowToDebtRatio * 100).toFixed(1) + '%' : 'N/A (No Debt)'}</span><br>
        Payback Period: <span style="color:${paybackYears <= 5 ? '#22c55e' : paybackYears <= 7 ? '#f59e0b' : '#ef4444'}">${paybackYears > 0 ? paybackYears.toFixed(1) + ' yrs' : 'Never'}</span><br>
        Cash Conversion: <span style="color:${cashConversionCycle <= 0 ? '#22c55e' : cashConversionCycle <= 15 ? '#f59e0b' : '#ef4444'}">${cashConversionCycle} days</span>
      </div>
      <div>
        <strong>üéØ Operational Efficiency:</strong><br>
        Revenue/Machine: <span style="color:${revenuePerMachine >= 1800 ? '#22c55e' : revenuePerMachine >= 1400 ? '#f59e0b' : '#ef4444'}">${money(revenuePerMachine)}</span><br>
        Revenue/Sq Ft: <span style="color:${revenuePerSqft >= 18 ? '#22c55e' : revenuePerSqft >= 14 ? '#f59e0b' : '#ef4444'}">${money(revenuePerSqft)}</span><br>
        Labor Efficiency: <span style="color:${laborEfficiency <= 12 ? '#22c55e' : laborEfficiency <= 15 ? '#f59e0b' : '#ef4444'}">${laborEfficiency.toFixed(1)}%</span><br>
        Rent Burden: <span style="color:${rentToRevenueRatio <= 25 ? '#22c55e' : rentToRevenueRatio <= 30 ? '#f59e0b' : '#ef4444'}">${rentToRevenueRatio.toFixed(1)}%</span><br>
        Maintenance Cost: <span style="color:${maintenanceRatio <= 8 ? '#22c55e' : maintenanceRatio <= 10 ? '#f59e0b' : '#ef4444'}">${maintenanceRatio.toFixed(1)}%</span>
      </div>
    </div>
    
    <div style="margin-top:12px; border-top:1px solid #334155; padding-top:8px">
      <div style="display:grid; grid-template-columns:1fr 1fr; gap:12px; font-size:11px">
        <div>
          <strong>üìà Value Creation Analysis:</strong><br>
          Economic Value Added: <span style="color:${economicValueAdded >= 0 ? '#22c55e' : '#ef4444'}">${money(economicValueAdded)} ${economicValueAdded >= 0 ? '(Creating Value ‚úì)' : '(Destroying Value ‚ö†Ô∏è)'}</span><br>
          Free Cash Flow: <span style="color:${freeCashFlow >= snapshot.projCost * 0.1 ? '#22c55e' : freeCashFlow >= 0 ? '#f59e0b' : '#ef4444'}">${money(freeCashFlow)}/year</span><br>
          WACC vs ROA: <span style="color:${returnOnAssets > weightedAverageCostOfCapital * 100 ? '#22c55e' : '#ef4444'}">${returnOnAssets.toFixed(1)}% vs ${(weightedAverageCostOfCapital * 100).toFixed(1)}%</span><br>
          Capital Efficiency: <span style="color:#60a5fa">${((snapshot.ebitda * 12) / snapshot.projCost * 100).toFixed(1)}% EBITDA yield</span>
        </div>
        <div>
          <strong>üè™ Industry Valuation:</strong><br>
          Fair Value (60√ó NOI): <span style="color:#60a5fa">${money(snapshot.ebitda * 60)}</span><br>
          Current Price: <span style="color:#60a5fa">${money(snapshot.projCost)}</span><br>
          Value Gap: <span style="color:${snapshot.projCost <= snapshot.ebitda * 60 ? '#22c55e' : '#ef4444'}">${((snapshot.projCost / (snapshot.ebitda * 60) - 1) * 100).toFixed(1)}% ${snapshot.projCost <= snapshot.ebitda * 60 ? 'below' : 'above'} fair value</span><br>
          Cap Rate: <span style="color:#60a5fa">${((snapshot.ebitda * 12 / snapshot.projCost) * 100).toFixed(2)}%</span>
        </div>
      </div>
    </div>
    
    <div style="margin-top:8px; padding:6px; background:#0f1419; border-radius:4px; font-size:10px">
      <strong>üéì MBA-Level Analysis:</strong> This comprehensive financial assessment incorporates DuPont Analysis, Economic Value Added (EVA), Working Capital Management, and Risk-Adjusted Return metrics based on advanced corporate finance principles from leading business schools.
    </div>
  `;
  
  $("#accountantText").innerHTML = analysis;
  $("#healthMetrics").innerHTML = healthMetrics;
}

// Main compute function

/* ---------- HERO / ZERO UNDERWRITING ENGINE ---------- */
function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

function normalizeShares(shares){
  const vals = {};
  let sum = 0;
  for (const k in shares){
    const v = Math.max(0, +shares[k] || 0);
    vals[k] = v; sum += v;
  }
  if (sum <= 0) return { coin:0, app:0, wf:0, comm:0 };
  for (const k in vals) vals[k] = vals[k] / sum;
  return vals;
}

function computeAgeStats(){
  let totalUnits = 0, totalAge = 0, maxAge = 0;
  washerDefs.forEach(w=>{ const c=+w.count||0; const a=+w.age||0; totalUnits+=c; totalAge+=c*a; maxAge=Math.max(maxAge,a); });
  dryerDefs.forEach(d=>{ const c=+d.count||0; const a=+d.age||0; totalUnits+=c; totalAge+=c*a; maxAge=Math.max(maxAge,a); });
  const avgAge = totalUnits>0 ? totalAge/totalUnits : 0;

  let label = "LOW";
  if (avgAge >= 7) label = "MODERATE";
  if (avgAge >= 10) label = "HIGH";
  if (avgAge >= 13) label = "SEVERE";
  if (avgAge >= 17) label = "DISTRESSED";

  return { avgAge, maxAge, totalUnits, label };
}

function computeCompetitionIndex() {
  const comps = +document.getElementById("competitors").value || 0;
  const renters = +document.getElementById("renterHH").value || 0;
  const csi = renters > 0 ? (comps / renters) * 1000 : (comps > 0 ? 99 : 0);
  let label = "Neutral";
  if (csi < 1.0) label = "Moat";
  else if (csi > 2.0) label = "Oversupplied";
  return { csi, label, comps, renters };
}

function computeLeaseRisk() {
  const leaseYears = +$("#leaseYears").value || 0;
  const renewal = (+$("#leaseRenewal").value || 0) >= 1;
  const camControl = (+$("#camControl").value || 0) >= 1;
  const loanTerm = Math.max(+$("#aTerm").value || 0, +$("#bTerm").value || 0);

  let risk = 0; // 0..1
  const flags = [];

  if (leaseYears <= 0) { risk = 1; flags.push("üö® Lease years remaining is 0 (or missing)."); }
  if (leaseYears < loanTerm) { risk = Math.max(risk, 0.95); flags.push(`üö® Lease term (${leaseYears}y) is shorter than loan term (${loanTerm}y).`); }
  if (!renewal) { risk = Math.max(risk, 0.6); flags.push("‚ö†Ô∏è No renewal options in lease (buyer/lender risk)."); }
  if (!camControl) { risk = Math.max(risk, 0.45); flags.push("‚ö†Ô∏è CAM not controlled/limited (expense volatility)."); }
  if (leaseYears >= loanTerm && leaseYears < loanTerm + 3) risk = Math.max(risk, 0.35);

  return { risk, flags, leaseYears, loanTerm, renewal, camControl };
}

function computeLocationElasticity() {
  const loc = clamp(+document.getElementById("locElastic").value || 0, 0, 10);
  const renter = clamp(+document.getElementById("renterScore").value || 0, 0, 10);
  const pricing = clamp(+document.getElementById("pricingPower").value || 0, 0, 10);
  const score = (0.45*loc + 0.35*renter + 0.20*pricing) / 10; // 0..1 higher better
  return { score, loc, renter, pricing };
}

function computeRevenueQuality() {
  const shares = normalizeShares({
    coin: +$("#revCoinPct").value,
    app: +$("#revAppPct").value,
    wf: +$("#revWfPct").value,
    comm: +$("#revCommPct").value
  });
  const stickiness = 0.15*shares.coin + 0.45*shares.app + 0.75*shares.wf + 0.90*shares.comm; // 0..1 higher better
  return { shares, stickiness };
}

function computeOwnerDependency() {
  const dep = clamp(+$("#ownerDep").value || 0, 0, 10);
  const penalty = dep / 10; // 0..1 higher worse
  return { dep, penalty };
}

function capexShockTest(snapshot, simulation) {
  // Replace 30% of washers in Year 3 (no revenue lift)
  const washerCount = washerDefs.reduce((s,w)=>s+(+w.count||0),0);
  const replaceCount = Math.ceil(washerCount * 0.30);

  // Weighted average washer cost
  let totalCost = 0, totalUnits = 0;
  washerDefs.forEach(w=>{
    const c = +w.count||0;
    totalCost += (equipCosts[w.name] || 0) * c;
    totalUnits += c;
  });
  const avgCost = totalUnits>0 ? totalCost/totalUnits : 12000;
  const shockCapex = replaceCount * avgCost;

  // Apply shock to cumulative cash at end of Year 3
  const cum = simulation.cumulativeCash.slice(); // [0..horizon]
  const year3Index = Math.min(3, cum.length-1);
  if (year3Index >= 1) {
    for (let i=year3Index; i<cum.length; i++) cum[i] -= shockCapex;
  }
  // Fail if Year-3 cash can't absorb the replacement event (requires cash infusion)
const year3Cash = (simulation.cashFlows && simulation.cashFlows.length>=3) ? (simulation.cashFlows[2] || 0) : 0;
const broke = (year3Cash - shockCapex) < 0;

  const finalCum = cum[cum.length-1];
  return { shockCapex, replaceCount, avgCost, year3Cash, broke, finalCum, cum };
}

function computeExitFit(snapshot, lease, ageLabel, revQ, comp, loc) {
  const stressedDSCR = snapshot.stressedDSCR ?? snapshot.dscr;
  const margin = snapshot.grossRevenue>0 ? snapshot.ebitda/snapshot.grossRevenue : 0;

  const sba = (stressedDSCR >= 1.25) && (lease.leaseYears >= lease.loanTerm) && (ageLabel !== "DISTRESSED");
  const operator = (snapshot.cashOnCash >= 0.20) && (snapshot.cashFlow > 0);
  const investor = (margin >= 0.22) && (lease.risk <= 0.5) && (comp.label !== "Oversupplied");
  const aggregator = (snapshot.grossRevenue >= 45000) && (revQ.stickiness >= 0.45) && (ageLabel === "LOW" || ageLabel === "MODERATE") && (loc.score >= 0.55);

  return { sba, operator, investor, aggregator, stressedDSCR, margin };
}

function heroZeroEvaluate(snapshot, simulation) {
  const age = computeAgeStats();
  const lease = computeLeaseRisk();
  const loc = computeLocationElasticity();
  const comp = computeCompetitionIndex();
  const revQ = computeRevenueQuality();
  const owner = computeOwnerDependency();
  const shock = capexShockTest(snapshot, simulation);
  const exit = computeExitFit(snapshot, lease, age.label, revQ, comp, loc);

  const dealKillers = [];

  // Deal killers
  const stressedDSCR = snapshot.stressedDSCR ?? snapshot.dscr;
  if (lease.leaseYears < lease.loanTerm) dealKillers.push("Lease term is shorter than loan term.");
  if (stressedDSCR < 1.0) dealKillers.push(`Stressed DSCR < 1.00 (currently ${stressedDSCR.toFixed(2)}).`);
  const hasFundedRetool = (+$("#retoolBudget").value || 0) >= 50000 || (+$("#includeLiftsInProject").value||0) >= 1;
  if (age.avgAge >= 15 && !hasFundedRetool) dealKillers.push("Avg equipment age ‚â• 15 years without funded retool.");
  if (shock.broke) dealKillers.push("CapEx shock test fails (30% washer replacement causes severe negative cash).");
  if (!(exit.sba || exit.operator || exit.investor || exit.aggregator)) dealKillers.push("No clear exit buyer fit (SBA/Operator/Investor/Aggregator all fail).");

  // Scoring components (0..100)
  // Financial
  const dscrScore = clamp((stressedDSCR - 1.0) / 0.6, 0, 1);        // 1.0->0, 1.6->1
  const cocScore  = clamp((snapshot.cashOnCash - 0.10) / 0.20, 0, 1); // 10%->0, 30%->1
  const valMultiple = snapshot.effectiveMultiple ?? 60;
  const valScore = clamp((60 - (snapshot.projCost / Math.max(1,snapshot.ebitda)) )/20, 0, 1); // rough
  const fin = (0.5*dscrScore + 0.4*cocScore + 0.1*valScore);

  // Age: LOW best, DISTRESSED worst
  const ageScoreMap = { "LOW":1.0, "MODERATE":0.75, "HIGH":0.45, "SEVERE":0.20, "DISTRESSED":0.05 };
  const ageScore = ageScoreMap[age.label] ?? 0.5;

  // Lease: inverse risk
  const leaseScore = 1 - clamp(lease.risk, 0, 1);

  // Location: already 0..1
  const locScore = loc.score;

  // Competition: moat good, oversupplied bad
  const compScore = comp.label === "Moat" ? 1.0 : comp.label === "Oversupplied" ? 0.25 : 0.6;

  // Revenue quality: stickiness 0..1
  const revScore = clamp(revQ.stickiness, 0, 1);

  // Owner dependency: inverse
  const ownerScore = 1 - owner.penalty;

  // Shock: pass/fail weight
  const shockScore = shock.broke ? 0.1 : 1.0;

  // Exit: count fit
  const exitCount = [exit.sba, exit.operator, exit.investor, exit.aggregator].filter(Boolean).length;
  const exitScore = clamp(exitCount / 3, 0, 1);

  // Weighted total
  const score = Math.round(
    32*fin +
    16*ageScore +
    12*leaseScore +
    10*locScore +
    8*compScore +
    8*revScore +
    6*ownerScore +
    4*shockScore +
    4*exitScore
  );

  let label = "BORDERLINE";
  if (score >= 80) label = "HERO";
  else if (score < 55) label = "ZERO";

  // If any deal killer, force ZERO
  const forcedZero = dealKillers.length > 0;
  if (forcedZero) label = "ZERO";

  const why = [];
  why.push(`Avg equipment age: ${age.avgAge.toFixed(1)}y (max ${age.maxAge}y) ‚Üí ${age.label}`);
  why.push(`Stressed DSCR: ${stressedDSCR.toFixed(2)} | Cash-on-cash: ${snapshot.cashOnCash.toFixed(1)}%`);
  why.push(`Location elasticity: ${(loc.score*100).toFixed(0)}/100 | Competition: ${comp.label} (CSI ${comp.csi.toFixed(2)})`);
  why.push(`Revenue stickiness: ${(revQ.stickiness*100).toFixed(0)}/100 | Owner dependency: ${owner.dep}/10`);
  why.push(`CapEx shock (Yr3): ${money(shock.shockCapex)} (${shock.replaceCount} washers) ‚Üí ${shock.broke ? "FAIL" : "PASS"}`);

  return { score, label, forcedZero, dealKillers, why, exit, age, lease, loc, comp, revQ, owner, shock, stressedDSCR };
}

function renderHeroZero(snapshot, simulation) {
  const hz = heroZeroEvaluate(snapshot, simulation);

  const banner = $("#heroZeroBanner");
  $("#hzLabel").textContent = hz.label;
  $("#hzScore").textContent = hz.score.toString();

  let status = hz.label === "HERO" ? "Proceed (LOI-ready)" : hz.label === "BORDERLINE" ? "Renegotiate / Restructure" : "Walk Away";
  if (hz.forcedZero) status = "ZERO (Deal-killer triggered)";
  $("#hzStatus").textContent = status;

  // Deal killers list
  $("#hzDealKillers").innerHTML = hz.dealKillers.length
    ? ("<strong>Deal-killers:</strong><ul style='margin:6px 0 0 18px'>" + hz.dealKillers.map(x=>`<li>${x}</li>`).join("") + "</ul>")
    : "<strong>Deal-killers:</strong> None detected.";

  $("#hzWhy").innerHTML = "<strong>Why:</strong><ul style='margin:6px 0 0 18px'>" + hz.why.map(x=>`<li>${x}</li>`).join("") + "</ul>";

  const exitRows = [
    ["SBA buyer fit", hz.exit.sba],
    ["Operator fit", hz.exit.operator],
    ["Investor fit", hz.exit.investor],
    ["Aggregator fit", hz.exit.aggregator],
  ].map(([k,v]) => `<tr><td style="text-align:left">${k}</td><td style="text-align:right">${v ? "‚úÖ" : "‚ùå"}</td></tr>`).join("");

  $("#hzExitFit").innerHTML = `
    <table style="width:100%; border-collapse:collapse; font-size:12px">
      <thead><tr><th style="text-align:left;border-bottom:1px solid #223353;padding:6px">Buyer Type</th><th style="text-align:right;border-bottom:1px solid #223353;padding:6px">Fit</th></tr></thead>
      <tbody>${exitRows}</tbody>
    </table>
    <div class="hint" style="margin-top:6px">Stressed DSCR is used for SBA fit. Lease term alignment is enforced.</div>
  `;

  // Color banner
  const colors = {
    HERO: {border:"#22c55e", bg:"#0a2a1a", text:"#90d690"},
    BORDERLINE: {border:"#f59e0b", bg:"#2a1f0a", text:"#ffd37a"},
    ZERO: {border:"#ef4444", bg:"#2a0f0f", text:"#ff9b9b"}
  };
  const c = colors[hz.label] || colors.BORDERLINE;
  banner.style.borderColor = c.border;
  banner.style.background = c.bg;
  banner.style.color = c.text;
  // Committee synthesis (Mr. Accountant + Advisors)
  try { renderCommitteeVerdict(hz, snapshot, simulation); } catch(e) { console.warn('Committee render failed', e); }

}

function compute() {
  updateProjectCost();
  const snapshot = calculateSnapshot();
  const simulation = simulateYears();
  
  // Update dynamic year text elements
  const horizon = +$("#horizon").value;
  const projectionTextEl = $("#projectionYearsText");
  const chartTextEl = $("#chartYearsText");
  const accuracyTextEl = $("#accuracyYearsText");
  
  if (projectionTextEl) projectionTextEl.textContent = horizon;
  if (chartTextEl) chartTextEl.textContent = horizon;
  if (accuracyTextEl) accuracyTextEl.textContent = horizon;
  
  renderKPIs(snapshot);
  renderTables(snapshot, simulation);
  renderCharts(snapshot, simulation);
  renderAccountantAnalysis(snapshot, simulation);
  
  // Run advanced analytics automatically with small delay for DOM
  setTimeout(() => {
    try {
      analyzeBenchmarks();
      analyzeExitScenarios();
    } catch (error) {
      console.error("Analytics error:", error);
    }
  }, 100);
  checkConstraintsEnhanced();
  renderHeroZero(snapshot, simulation); // Enhanced constraint warnings with suggestions
}

// Data export/import
function exportJSON() {
  const data = {
    washerDefs, dryerDefs, equipCosts,
    locale: $("#locale").value,
    horizon: +$("#horizon").value,
    days: +$("#days").value,
    rates: {
      elec: +document.getElementById("rateElec").value,
      gas: +$("#rateGas").value,
      water: +$("#rateWater").value
    },
    projCost: +$("#projCost").value,
    cashInv: +$("#cashInv").value
  };
  
  const blob = new Blob([JSON.stringify(data, null, 2)], {type: 'application/json'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'laundromat-investment-analysis.json';
  a.click();
  URL.revokeObjectURL(url);
}

function importJSON() {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  input.onchange = function(e) {
    const file = e.target.files[0];
    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const data = JSON.parse(e.target.result);

          // Prefer shared helper if present (also makes this testable in Node)
          if (typeof applyImportedData === 'function') {
            applyImportedData(data, { confirmFn: (msg) => confirm(msg) });

            // sync simple fields into current DOM inputs
            $("#locale").value = data.locale || 'national_city';
            $("#horizon").value = data.horizon || 10;
            $("#days").value = data.days || 30;
            if (data.rates) {
              document.getElementById("rateElec").value = data.rates.elec || 0.32;
              $("#rateGas").value = data.rates.gas || 1.80;
              $("#rateWater").value = data.rates.water || 0.008;
            }
            $("#projCost").value = data.projCost || 850000;
            $("#cashInv").value = data.cashInv || 200000;

          } else {
            // Fallback inline guarded assignment
            function assignWithEmptyGuard(fieldName, currentVarName) {
              if (data[fieldName] !== undefined) {
                if (Array.isArray(data[fieldName]) && data[fieldName].length === 0) {
                  const proceed = confirm(`Imported JSON has an empty ${fieldName}. Importing will clear the current ${fieldName}. Proceed?`);
                  if (proceed) {
                    window[currentVarName] = data[fieldName];
                  } else {
                    console.warn(`Skipped importing empty ${fieldName}`);
                  }
                } else {
                  window[currentVarName] = data[fieldName];
                }
              }
            }

            assignWithEmptyGuard('washerDefs', 'washerDefs');
            assignWithEmptyGuard('dryerDefs', 'dryerDefs');
            assignWithEmptyGuard('equipCosts', 'equipCosts');
            $("#locale").value = data.locale || 'national_city';
            $("#horizon").value = data.horizon || 10;
            $("#days").value = data.days || 30;
            if (data.rates) {
              document.getElementById("rateElec").value = data.rates.elec || 0.32;
              $("#rateGas").value = data.rates.gas || 1.80;
              $("#rateWater").value = data.rates.water || 0.008;
            }
            $("#projCost").value = data.projCost || 850000;
            $("#cashInv").value = data.cashInv || 200000;
          }

          populateEquipmentTables();
          populateEquipmentCostTable();
          compute();

          alert('Data imported successfully!');
        } catch (err) {
          alert('Error importing file: ' + err.message);
        }
      };
      reader.readAsText(file);
    }
  };
  input.click();
}

// Print Report Generator
function generatePrintReport() {
  // Simplified print report to avoid template-literal parsing bugs that can break the whole app.
  // For full detail, use Export JSON.
  let snapshot;
  try {
    snapshot = calculateSnapshot();
  } catch (e) {
    alert('Cannot print yet: please click ‚ÄúCompute All‚Äù first.');
    return;
  }
  if (!snapshot) {
    alert('Cannot print yet: please click ‚ÄúCompute All‚Äù first.');
    return;
  }
  const safe = (v) => (v === undefined || v === null) ? '' : String(v);
  const rows = [
    ['City/Locale', safe($('#locale').value)],
    ['Total Project Cost', money(+$('#projCost').value||0)],
    ['Cash Down', money(+$('#cashInv').value||0)],
    ['Monthly Gross Revenue', money(snapshot.grossRevenue||0)],
    ['Monthly EBITDA/NOI', money(snapshot.ebitda||0)],
    ['EBITDA Margin', ((snapshot.ebitdaMargin||0)*100).toFixed(1) + '%'],
    ['Monthly Debt Service', money(snapshot.totalDebtService||0)],
    ['DSCR (Base)', (snapshot.dscr||0).toFixed(2)],
    ['Cash-on-Cash (Year 1)', (snapshot.cashOnCash||0).toFixed(1) + '%'],
    ['Industry Valuation (60√ó monthly NOI)', money(snapshot.industryValuation||0)],
    ['Equipment Avg Age', (snapshot.ageRisk?.avgAge ?? 0).toFixed(1) + ' yrs'],
    ['Equipment Oldest', (snapshot.ageRisk?.oldest ?? 0).toFixed(0) + ' yrs'],
  ];

  const now = new Date();
  const reportHtml = `<!doctype html><html><head><meta charset="utf-8" />
    <title>Laundromat Investment Summary</title>
    <style>
      body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;margin:24px;color:#111;}
      h1{margin:0 0 6px 0;font-size:18px;}
      .meta{color:#555;margin-bottom:16px;font-size:12px;}
      table{border-collapse:collapse;width:100%;font-size:12px;}
      td{border:1px solid #ddd;padding:8px;vertical-align:top;}
      td:first-child{width:42%;color:#333;background:#fafafa;font-weight:600;}
      .note{margin-top:14px;font-size:11px;color:#555;}
      @media print { .no-print{display:none;} }
    </style>
  </head><body>
    <h1>Laundromat Investment Summary</h1>
    <div class="meta">Generated ${now.toLocaleString()} ‚Ä¢ Market Mode: ${safe($('#marketMode').value || '')}</div>
    <table>
      ${rows.map(r=>`<tr><td>${r[0]}</td><td>${r[1]}</td></tr>`).join('')}
    </table>
    <div class="note">This summary is intentionally concise to keep printing reliable. Use Export JSON for full inputs.</div>
    <div class="no-print" style="margin-top:16px;"><button onclick="window.print()">Print</button></div>
  </body></html>`;

  const w = window.open('', '_blank', 'noopener,noreferrer,width=920,height=780,scrollbars=yes');
  if (!w) {
    alert('Popup blocked. Please allow popups for this site, then try again.');
    return;
  }
  w.document.open();
  w.document.write(reportHtml);
  w.document.close();
  setTimeout(() => { try { w.focus(); } catch(e){} }, 300);
}

// ================================
// STRESS TEST FUNCTIONS
// ================================

let originalValues = {};

function runStressTest() {
  const snapshot = calculateSnapshot();
  const revenueStress = (+$("#revenueStress").value || 0) / 100;
  const rentStress = (+$("#rentStress").value || 0) / 100;
  const utilityStress = (+$("#utilityStress").value || 0) / 100;
  
  // Calculate stressed values
  const stressedRevenue = snapshot.grossRevenue * (1 + revenueStress);
  const stressedRent = snapshot.rent * (1 + rentStress);
  const stressedUtilities = snapshot.utilities.total * (1 + utilityStress);
  const stressedOpex = stressedRent + snapshot.laborCost + stressedUtilities + snapshot.maintenance + snapshot.vendCogs;
  const stressedEbitda = stressedRevenue - stressedOpex;
  const stressedDscr = stressedEbitda / snapshot.totalDebtService;
  
  // Resilience assessment
  let resilience = "";
  let resilienceClass = "";
  if (stressedDscr >= 1.5) {
    resilience = "üü¢ HIGHLY RESILIENT - Strong buffer against stress";
    resilienceClass = "good";
  } else if (stressedDscr >= 1.25) {
    resilience = "üü° MODERATELY RESILIENT - Adequate stress tolerance";
    resilienceClass = "warn";
  } else if (stressedDscr >= 1.0) {
    resilience = "üü† MARGINAL RESILIENCE - Vulnerable to stress";
    resilienceClass = "warn";
  } else {
    resilience = "üî¥ POOR RESILIENCE - Cannot handle stress scenarios";
    resilienceClass = "bad";
  }
  
  // Display results
  $("#stressResults").innerHTML = `
    <h4>Stress Test Results</h4>
    <div class="kpis">
      <div class="kpi">
        <h4>Stressed Revenue</h4>
        <div class="v">${money(stressedRevenue)}</div>
        <div class="hint">${revenueStress >= 0 ? "+" : ""}${(revenueStress * 100).toFixed(1)}%</div>
      </div>
      <div class="kpi">
        <h4>Stressed OpEx</h4>
        <div class="v">${money(stressedOpex)}</div>
        <div class="hint">+${((stressedOpex / snapshot.totalOpex - 1) * 100).toFixed(1)}%</div>
      </div>
      <div class="kpi ${resilienceClass}">
        <h4>Stressed DSCR</h4>
        <div class="v">${stressedDscr.toFixed(2)}</div>
        <div class="hint">${stressedDscr >= snapshot.dscr ? "+" : ""}${((stressedDscr - snapshot.dscr)).toFixed(2)}</div>
      </div>
    </div>
    <div class="${resilienceClass === "good" ? "insightbox" : "warnbox"}" style="margin-top:8px">
      <strong>${resilience}</strong><br>
      ${stressedDscr < 1.0 ? "WARNING: Stressed DSCR below 1.0 indicates potential loan default risk." : 
        stressedDscr < 1.25 ? "CAUTION: Stressed DSCR below lender comfort zone (1.25+)." :
        "GOOD: Business maintains adequate debt coverage under stress."}
    </div>
  `;
  
  // Update Mr. Accountant analysis with resilience info
  updateAccountantAnalysisWithStress(resilience, stressedDscr);
}

function runCommonStressTests() {
  $("#revenueStress").value = -10;
  $("#rentStress").value = 10;
  $("#utilityStress").value = 15;
  runStressTest();
}

function resetStressTest() {
  $("#revenueStress").value = 0;
  $("#rentStress").value = 0;
  $("#utilityStress").value = 0;
  $("#stressResults").innerHTML = "";
  updateAccountantAnalysisWithStress("", 0);
}

function updateAccountantAnalysisWithStress(resilience, stressedDscr) {
  const accountantDiv = document.getElementById("accountantText");
  if (!accountantDiv) return;
  
  const currentText = accountantDiv.textContent;
  const cleanText = currentText.replace(/\n\nüîß STRESS TEST.*$/s, "");
  
  if (resilience) {
    accountantDiv.textContent = cleanText + `\n\nüîß STRESS TEST ANALYSIS: ${resilience}\nUnder stress scenario, DSCR becomes ${stressedDscr.toFixed(2)}. ${
  stressedDscr >= 1.5 ? "This business shows excellent resilience to market downturns." :
  stressedDscr >= 1.25 ? "Adequate stress tolerance, but monitor cash flow closely." :
  stressedDscr >= 1.0 ? "Marginal resilience - consider larger down payment or better terms." :
  "High risk investment - stress scenario creates potential default risk."
}`;
  } else {
    accountantDiv.textContent = cleanText;
  }
}

// ================================
// MONTE CARLO RISK ANALYSIS
// ================================

// Global variable to store Monte Carlo results
let monteCarloResults = null;

// Normal distribution random number generator (Box-Muller transform)
function normalRandom(mean = 0, stdDev = 1) {
  let u = 0, v = 0;
  while(u === 0) u = Math.random(); // Converting [0,1) to (0,1)
  while(v === 0) v = Math.random();
  return mean + stdDev * Math.sqrt(-2.0 * Math.log(u)) * Math.cos(2.0 * Math.PI * v);
}

// Monte Carlo simulation for investment analysis
function runMonteCarloSim() {
  try {
    const baseSnapshot = calculateSnapshot();
    if (!baseSnapshot) {
      alert('Calculator not initialized. Please fill out basic inputs and click "Compute All" first.');
      return;
    }
    
    const iterations = Math.min(+$("#monteCarloIterations").value || 1000, 5000); // Limit to 5000 to prevent browser freeze
    const revenueVol = (+$("#revenueVolatility").value || 15) / 100;
    const expenseVol = (+$("#expenseVolatility").value || 10) / 100;
    
    if (!baseSnapshot.grossRevenue || baseSnapshot.grossRevenue <= 0) {
      alert('Please configure equipment and ensure revenue is calculated before running Monte Carlo analysis');
      return;
    }
    
    if (!baseSnapshot.cashInv || baseSnapshot.cashInv <= 0) {
      alert('Please set cash investment amount before running Monte Carlo analysis');
      return;
    }
  
  const results = {
    rois: [],
    npvs: [],
    paybacks: [],
    dscrMins: [],
    scenarios: { excellent: 0, good: 0, fair: 0, poor: 0, terrible: 0 }
  };
  
  // Track key statistics
  let positiveNPVs = 0;
  let targetROIs = 0; // ROI >= 20%
  let excellentROIs = 0; // ROI >= 25%
  
  // Add debugging console output
  const totalExpensesBase = (baseSnapshot.utilities?.total || 0) + (baseSnapshot.laborCost || 0) + (baseSnapshot.rent || 0) + (baseSnapshot.insurance || 0) + (baseSnapshot.maintenance || 0);
  console.log('Starting Monte Carlo simulation with base values:', {
    revenue: baseSnapshot.grossRevenue,
    expenses: totalExpensesBase,
    cashInv: baseSnapshot.cashInv,
    debtService: baseSnapshot.totalDebtService,
    baseROI: baseSnapshot.cashOnCash,
    utilities: baseSnapshot.utilities,
    laborCost: baseSnapshot.laborCost,
    rent: baseSnapshot.rent,
    insurance: baseSnapshot.insurance,
    maintenance: baseSnapshot.maintenance
  });

  for (let i = 0; i < iterations; i++) {
    // Generate random variations for key variables
    const revenueMultiplier = Math.max(0.3, normalRandom(1.0, revenueVol));
    const expenseMultiplier = Math.max(0.5, normalRandom(1.0, expenseVol));
    const utilityMultiplier = Math.max(0.7, normalRandom(1.0, expenseVol * 0.8));
    const maintMultiplier = Math.max(0.5, normalRandom(1.0, expenseVol * 1.2));
    
    // Calculate scenario metrics with safe defaults
    const simRevenue = (baseSnapshot.grossRevenue || 0) * revenueMultiplier;
    const totalExpenses = (baseSnapshot.utilities?.total || 0) + (baseSnapshot.laborCost || 0) + (baseSnapshot.rent || 0) + (baseSnapshot.insurance || 0) + (baseSnapshot.maintenance || 0);
    const simExpenses = totalExpenses * expenseMultiplier;
    const simEBITDA = simRevenue - simExpenses;
    const simCashFlow = simEBITDA - (baseSnapshot.totalDebtService || 0);
    const simROI = (baseSnapshot.cashInv > 0) ? (simCashFlow * 12 / baseSnapshot.cashInv) * 100 : 0;
    const simDSCR = (baseSnapshot.totalDebtService > 0) ? simEBITDA / baseSnapshot.totalDebtService : 99;
    
    // Debug first few iterations
    if (i < 3) {
      console.log(`Iteration ${i}:`, {
        revenueMultiplier: revenueMultiplier.toFixed(3),
        expenseMultiplier: expenseMultiplier.toFixed(3),
        simRevenue: simRevenue.toFixed(0),
        simExpenses: simExpenses.toFixed(0),
        simEBITDA: simEBITDA.toFixed(0),
        simCashFlow: simCashFlow.toFixed(0),
        simROI: simROI.toFixed(1),
        simDSCR: simDSCR.toFixed(2)
      });
    }
    
    // Simple NPV calculation (using 8% discount rate)
    let simNPV = -(baseSnapshot.cashInv || 0);
    for (let year = 1; year <= 10; year++) {
      const yearCashFlow = simCashFlow * 12 * Math.pow(1.02, year - 1); // 2% growth
      simNPV += yearCashFlow / Math.pow(1.08, year);
    }
    
    // Payback period calculation
    let cumulativeCash = -(baseSnapshot.cashInv || 0);
    let paybackYears = 999;
    for (let year = 1; year <= 15; year++) {
      cumulativeCash += simCashFlow * 12;
      if (cumulativeCash >= 0 && paybackYears === 999) {
        paybackYears = year + (cumulativeCash - simCashFlow * 12) / (simCashFlow * 12);
        break;
      }
    }
    
    // Validate and store results
    if (isNaN(simROI) || isNaN(simNPV) || isNaN(simDSCR)) {
      if (i < 3) console.log('NaN detected in iteration', i, { simROI, simNPV, simDSCR });
      continue; // Skip this iteration
    }
    
    // Store results
    results.rois.push(simROI);
    results.npvs.push(simNPV);
    results.paybacks.push(paybackYears);
    results.dscrMins.push(simDSCR);
    
    // Count favorable scenarios
    if (simNPV > 0) positiveNPVs++;
    if (simROI >= 20) targetROIs++;
    if (simROI >= 25) excellentROIs++;
    
    // Categorize scenarios
    if (simROI >= 25 && simDSCR >= 1.5) results.scenarios.excellent++;
    else if (simROI >= 20 && simDSCR >= 1.25) results.scenarios.good++;
    else if (simROI >= 15 && simDSCR >= 1.1) results.scenarios.fair++;
    else if (simROI >= 10) results.scenarios.poor++;
    else results.scenarios.terrible++;
  }
  
  console.log(`Monte Carlo completed: ${results.rois.length} valid results out of ${iterations} iterations`);
  
  // Calculate statistics - check for empty arrays first
  if (results.rois.length === 0 || results.npvs.length === 0) {
    console.error('Monte Carlo simulation failed - no valid results generated');
    console.error('All iterations produced NaN values. Check base case calculations.');
    alert('Monte Carlo simulation failed - all iterations produced invalid results. Check that the basic calculator is working first.');
    return;
  }
  
  const sortedROIs = [...results.rois].sort((a, b) => a - b);
  const sortedNPVs = [...results.npvs].sort((a, b) => a - b);
  
  // Calculate mean ROI safely
  const meanROI = results.rois.reduce((a, b) => a + b, 0) / iterations;
  const meanNPV = results.npvs.reduce((a, b) => a + b, 0) / iterations;
  
  const stats = {
    roi: {
      mean: meanROI,
      median: sortedROIs[Math.floor(iterations / 2)],
      p5: sortedROIs[Math.floor(iterations * 0.05)],
      p95: sortedROIs[Math.floor(iterations * 0.95)],
      stdDev: Math.sqrt(results.rois.reduce((sum, roi) => sum + Math.pow(roi - meanROI, 2), 0) / iterations)
    },
    npv: {
      mean: meanNPV,
      median: sortedNPVs[Math.floor(iterations / 2)],
      p5: sortedNPVs[Math.floor(iterations * 0.05)],
      p95: sortedNPVs[Math.floor(iterations * 0.95)]
    },
    probabilities: {
      positiveNPV: (positiveNPVs / iterations) * 100,
      targetROI: (targetROIs / iterations) * 100,
      excellentROI: (excellentROIs / iterations) * 100
    }
  };
  
  // Store results globally
  monteCarloResults = { results, stats, iterations: results.rois.length };
  
  // Display results
  displayMonteCarloResults(stats, results);
  renderMonteCarloCharts(results, stats);
  
  } catch (error) {
    console.error('Monte Carlo simulation error:', error);
    alert('Monte Carlo simulation failed. Error: ' + error.message);
    
    // Reset any potentially corrupted state
    monteCarloResults = null;
    
    // Clear any partial results
    const resultsDiv = $("#monteCarloResults");
    if (resultsDiv) resultsDiv.innerHTML = '';
    
    // Destroy any partial charts
    if (chartInstances.roiDistribution) {
      chartInstances.roiDistribution.destroy();
      delete chartInstances.roiDistribution;
    }
    if (chartInstances.riskScenario) {
      chartInstances.riskScenario.destroy();
      delete chartInstances.riskScenario;
    }
  }
}

// Display Monte Carlo results
function displayMonteCarloResults(stats, results) {
  const resultsDiv = $("#monteCarloResults");
  if (!resultsDiv) return;
  
  // Risk interpretation
  let riskLevel = "HIGH RISK";
  let riskColor = "#ef4444";
  if (stats.probabilities.targetROI >= 70) {
    riskLevel = "LOW RISK";
    riskColor = "#22c55e";
  } else if (stats.probabilities.targetROI >= 50) {
    riskLevel = "MODERATE RISK";
    riskColor = "#f59e0b";
  }
  
  resultsDiv.innerHTML = `
    <div style="background:#1a1a2e; padding:15px; border-radius:8px; margin-top:10px">
      <div style="text-align:center; margin-bottom:15px">
        <h4 style="color:#60a5fa; margin-bottom:5px">Monte Carlo Risk Assessment</h4>
        <div style="color:${riskColor}; font-size:18px; font-weight:bold">${riskLevel}</div>
      </div>
      
      <div style="display:grid; grid-template-columns:1fr 1fr 1fr; gap:15px; font-size:12px">
        <div>
          <strong style="color:#60a5fa">üìä ROI Statistics:</strong><br>
          Mean ROI: <span style="color:#22c55e">${stats.roi.mean.toFixed(1)}%</span><br>
          Median ROI: <span style="color:#22c55e">${stats.roi.median.toFixed(1)}%</span><br>
          5th Percentile: <span style="color:#ef4444">${stats.roi.p5.toFixed(1)}%</span><br>
          95th Percentile: <span style="color:#22c55e">${stats.roi.p95.toFixed(1)}%</span><br>
          Std Deviation: <span style="color:#f59e0b">${stats.roi.stdDev.toFixed(1)}%</span>
        </div>
        
        <div>
          <strong style="color:#60a5fa">üí∞ Value Creation:</strong><br>
          Mean NPV: <span style="color:${stats.npv.mean >= 0 ? '#22c55e' : '#ef4444'}">${money(stats.npv.mean)}</span><br>
          Median NPV: <span style="color:${stats.npv.median >= 0 ? '#22c55e' : '#ef4444'}">${money(stats.npv.median)}</span><br>
          NPV Range: ${money(stats.npv.p5)} to ${money(stats.npv.p95)}<br>
          Positive NPV: <span style="color:#22c55e">${stats.probabilities.positiveNPV.toFixed(1)}%</span>
        </div>
        
        <div>
          <strong style="color:#60a5fa">üéØ Success Probabilities:</strong><br>
          ROI ‚â• 20%: <span style="color:${stats.probabilities.targetROI >= 70 ? '#22c55e' : stats.probabilities.targetROI >= 50 ? '#f59e0b' : '#ef4444'}">${stats.probabilities.targetROI.toFixed(1)}%</span><br>
          ROI ‚â• 25%: <span style="color:${stats.probabilities.excellentROI >= 50 ? '#22c55e' : stats.probabilities.excellentROI >= 30 ? '#f59e0b' : '#ef4444'}">${stats.probabilities.excellentROI.toFixed(1)}%</span><br>
          Excellent: <span style="color:#22c55e">${((results.scenarios.excellent / monteCarloResults.iterations) * 100).toFixed(1)}%</span><br>
          Good+: <span style="color:#f59e0b">${(((results.scenarios.excellent + results.scenarios.good) / monteCarloResults.iterations) * 100).toFixed(1)}%</span><br>
          Poor/Terrible: <span style="color:#ef4444">${(((results.scenarios.poor + results.scenarios.terrible) / monteCarloResults.iterations) * 100).toFixed(1)}%</span>
        </div>
      </div>
      
      <div style="margin-top:15px; padding:10px; background:#0f1a2e; border-radius:6px">
        <strong style="color:#60a5fa">üîç Investment Interpretation:</strong><br>
        ${stats.probabilities.targetROI >= 70 ? 
          '<span style="color:#22c55e">HIGH CONFIDENCE: This investment shows strong probability of meeting target returns with limited downside risk.</span>' :
          stats.probabilities.targetROI >= 50 ?
          '<span style="color:#f59e0b">MODERATE CONFIDENCE: Mixed probability of success. Consider risk mitigation strategies or improved deal terms.</span>' :
          '<span style="color:#ef4444">LOW CONFIDENCE: High risk of underperformance. Significant improvements needed or consider walking away.</span>'
        }
        <br><br>
        <strong>Risk Factors:</strong> Revenue volatility (${($("#revenueVolatility").value)}%), Expense volatility (${($("#expenseVolatility").value)}%)
        <br><strong>Confidence Level:</strong> ${monteCarloResults.iterations.toLocaleString()} simulations provide ${monteCarloResults.iterations >= 10000 ? 'high' : 'moderate'} statistical confidence.
      </div>
    </div>
  `;
}

// Monte Carlo chart rendering
function renderMonteCarloCharts(results, stats) {
  try {
    // ROI Distribution Chart
    const roiCtx = $("#roiDistributionChart");
    if (!roiCtx) return;
  
  // Create histogram bins for ROI distribution
  const bins = [];
  const binSize = 2; // 2% bins
  const minROI = Math.floor(Math.min(...results.rois) / binSize) * binSize;
  const maxROI = Math.ceil(Math.max(...results.rois) / binSize) * binSize;
  
  for (let i = minROI; i <= maxROI; i += binSize) {
    bins.push({ range: `${i}%-${i + binSize}%`, count: 0, midpoint: i + binSize/2 });
  }
  
  // Count occurrences in each bin
  results.rois.forEach(roi => {
    const binIndex = Math.floor((roi - minROI) / binSize);
    if (bins[binIndex]) bins[binIndex].count++;
  });
  
  // Destroy existing chart
  if (chartInstances.roiDistribution) {
    chartInstances.roiDistribution.destroy();
  }
  
  // Create ROI distribution chart
  chartInstances.roiDistribution = new Chart(roiCtx.getContext('2d'), {
    type: 'bar',
    data: {
      labels: bins.map(bin => bin.range),
      datasets: [{
        label: 'Frequency',
        data: bins.map(bin => bin.count),
        backgroundColor: bins.map(bin => 
          bin.midpoint >= 25 ? '#22c55e' : 
          bin.midpoint >= 20 ? '#f59e0b' : 
          bin.midpoint >= 15 ? '#60a5fa' : '#ef4444'
        )
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        title: { display: true, text: 'ROI Distribution' },
        legend: { display: false }
      },
      scales: { 
        y: { beginAtZero: true, title: { display: true, text: 'Frequency' }},
        x: { title: { display: true, text: 'ROI Range' }}
      }
    }
  });
  
  // Risk Scenario Chart
  const riskCtx = $("#riskScenarioChart");
  if (!riskCtx) return;
  
  // Destroy existing chart
  if (chartInstances.riskScenario) {
    chartInstances.riskScenario.destroy();
  }
  
  const scenarioData = [
    results.scenarios.excellent,
    results.scenarios.good,
    results.scenarios.fair,
    results.scenarios.poor,
    results.scenarios.terrible
  ];
  
  chartInstances.riskScenario = new Chart(riskCtx.getContext('2d'), {
    type: 'doughnut',
    data: {
      labels: ['Excellent (ROI‚â•25%)', 'Good (ROI‚â•20%)', 'Fair (ROI‚â•15%)', 'Poor (ROI‚â•10%)', 'Terrible (<10%)'],
      datasets: [{
        data: scenarioData,
        backgroundColor: ['#22c55e', '#60a5fa', '#f59e0b', '#f97316', '#ef4444']
      }]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { 
        title: { display: true, text: 'Scenario Distribution' },
        legend: { position: 'bottom', labels: { fontSize: 10 }}
      }
    }
  });
  
  } catch (error) {
    console.error('Monte Carlo chart rendering error:', error);
    // Don't throw error to prevent breaking the calculator
  }
}

// Helper function for NPV calculation
function calculateNPV(snapshot) {
  const discountRate = 0.08; // 8% discount rate
  let npv = -snapshot.cashInv;
  
  for (let year = 1; year <= 10; year++) {
    const yearCashFlow = snapshot.cashFlow * 12 * Math.pow(1.02, year - 1); // 2% growth
    npv += yearCashFlow / Math.pow(1 + discountRate, year);
  }
  
  return npv;
}

// Export Monte Carlo results
function exportMonteCarloResults() {
  if (!monteCarloResults) {
    alert('Please run Monte Carlo analysis first');
    return;
  }
  
  const { results, stats, iterations } = monteCarloResults;
  const baseSnapshot = calculateSnapshot();
  
  const report = {
    timestamp: new Date().toISOString(),
    analysis: {
      baseCase: {
        roi: baseSnapshot.cashOnCash,
        npv: calculateNPV(baseSnapshot),
        cashFlow: baseSnapshot.cashFlow * 12,
        dscr: baseSnapshot.dscr
      },
      monteCarloResults: {
        iterations: iterations,
        roiStatistics: stats.roi,
        npvStatistics: stats.npv,
        successProbabilities: stats.probabilities,
        scenarioBreakdown: results.scenarios
      },
      riskAssessment: {
        revenueVolatility: +$("#revenueVolatility").value + '%',
        expenseVolatility: +$("#expenseVolatility").value + '%',
        riskLevel: stats.probabilities.targetROI >= 70 ? 'Low' : stats.probabilities.targetROI >= 50 ? 'Moderate' : 'High'
      }
    }
  };
  
  // Download as JSON
  const blob = new Blob([JSON.stringify(report, null, 2)], { type: 'application/json' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = 'monte-carlo-risk-analysis.json';
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  URL.revokeObjectURL(url);
}

// ================================
// ADVANCED INVESTMENT ANALYSIS
// ================================

// Market benchmarking and intelligence
function analyzeBenchmarks() {
  try {
    const snapshot = calculateSnapshot();
    const simulation = simulateYears();
  
  // Market position scoring based on key metrics
  let marketScore = 0;
  let competitive = 0;
  let riskScore = 0;
  
  // Revenue per sq ft benchmark (industry: $140-180/sq ft/yr)
  const revenuePerSqFt = (snapshot.grossRevenue * 12) / (+$("#totalSqft").value);
  if (revenuePerSqFt >= 180) marketScore += 25;
  else if (revenuePerSqFt >= 160) marketScore += 20;
  else if (revenuePerSqFt >= 140) marketScore += 15;
  else marketScore += 5;
  
  // EBITDA margin benchmark (industry: 35-50%)
  const ebitdaMargin = (snapshot.ebitda / snapshot.grossRevenue) * 100;
  if (ebitdaMargin >= 45) marketScore += 25;
  else if (ebitdaMargin >= 40) marketScore += 20;
  else if (ebitdaMargin >= 35) marketScore += 15;
  else marketScore += 5;
  
  // ROI benchmark (Industry standard: 20%+)
  if (snapshot.cashOnCash >= 25) marketScore += 25;
  else if (snapshot.cashOnCash >= 20) marketScore += 20;
  else if (snapshot.cashOnCash >= 15) marketScore += 10;
  else marketScore += 0;
  
  // Equipment efficiency (turns per day)
  const avgTurns = washerDefs.reduce((sum, w) => sum + w.turns * w.count, 0) / washerDefs.reduce((sum, w) => sum + w.count, 0);
  if (avgTurns >= 2.5) marketScore += 15;
  else if (avgTurns >= 2.2) marketScore += 10;
  else if (avgTurns >= 2.0) marketScore += 5;
  
  // Equipment age factor
  const avgAge = [...washerDefs, ...dryerDefs].reduce((sum, eq) => sum + eq.age * eq.count, 0) / 
                 [...washerDefs, ...dryerDefs].reduce((sum, eq) => sum + eq.count, 0);
  if (avgAge <= 3) marketScore += 10;
  else if (avgAge <= 5) marketScore += 5;
  
  // Competitive scoring
  competitive = Math.min(100, marketScore + (snapshot.dscr >= 1.5 ? 15 : 0) + (revenuePerSqFt > 160 ? 10 : 0));
  
  // Risk assessment
  let riskFactors = 0;
  if (snapshot.dscr < 1.25) riskFactors += 30;
  // Age risk (nonlinear): older than ~7 years quickly increases operational risk.
if (avgAge > 7) {
  // 10 points at age 7, +6 per year thereafter, capped at 70 points.
  riskFactors += Math.min(70, 10 + (avgAge - 7) * 6);
}
// Oldest-unit kicker: one very old bank can dominate downtime risk.
const oldestUnit = Math.max(
  ...washerDefs.filter(w=>w.count>0).map(w=>+w.age||0),
  ...dryerDefs.filter(d=>d.count>0).map(d=>+d.age||0),
  0
);
if (oldestUnit >= 18) riskFactors += 15;
if (oldestUnit >= 25) riskFactors += 15;
if (ebitdaMargin < 35) riskFactors += 20;
  if (snapshot.cashOnCash < 15) riskFactors += 20;
  if ((snapshot.rent / snapshot.grossRevenue) > 0.25) riskFactors += 10;
  
  // Monte Carlo + volatility-aware risk (probability-weighted, not variance-punitive)
  // Volatility alone is NOT "risk" unless it increases the probability of failing return hurdles or destroying value.
  const revenueVol = +($("#revenueVolatility").value || 15);
  const expenseVol = +($("#expenseVolatility").value || 10);

  // Mild volatility penalty (bounded). Use Monte Carlo downside for the real signal.
  // Baseline assumptions: ~10% revenue vol, ~7% expense vol are normal in ops-heavy small businesses.
  const volPenalty =
    Math.max(0, Math.min(8, (revenueVol - 10) * 0.6)) +
    Math.max(0, Math.min(6, (expenseVol - 7) * 0.6));
  riskFactors += volPenalty;

  // If Monte Carlo has run, weight risk by downside probabilities
  let mcPositiveNPV = null;
  let mcTargetROI = null;
  let mcExcellentROI = null;

  if (window.monteCarloResults && window.monteCarloResults.results && window.monteCarloResults.results.probabilities) {
    const mcStats = window.monteCarloResults.results;
    mcPositiveNPV = +mcStats.probabilities.positiveNPV;
    mcTargetROI = +mcStats.probabilities.targetROI;      // ROI ‚â• 20%
    mcExcellentROI = +mcStats.probabilities.excellentROI; // ROI ‚â• 25%

    const pNegNPV = 100 - mcPositiveNPV;
    const pBelowHurdle = 100 - mcTargetROI;

    // Penalize true downside probability (capital impairment / failure to clear hurdle)
    if (pNegNPV > 20) riskFactors += 25;
    else if (pNegNPV > 10) riskFactors += 15;
    else if (pNegNPV > 5) riskFactors += 8;
    else if (pNegNPV > 2) riskFactors += 4;

    if (pBelowHurdle > 35) riskFactors += 25;
    else if (pBelowHurdle > 20) riskFactors += 15;
    else if (pBelowHurdle > 10) riskFactors += 8;
    else if (pBelowHurdle > 5) riskFactors += 4;
  } else {
    // Without Monte Carlo, don't over-penalize volatility.
    // Keep the deterministic model as the primary driver until probabilities exist.
    // (No additional penalty here.)
  }

  // Pre-lease-adjustment score (will be recomputed again after lease controls below)
  riskScore = Math.max(0, 100 - riskFactors);
  
  // Display results
  // Extract consistent grade from Mr. Accountant analysis to ensure all sections match
  let consistentGrade = "C"; // fallback
  
  try {
    const accountantText = $("#accountantText").innerHTML || "";
    const gradeMatch = accountantText.match(/Grade:\s*([A-F][+]?)/);
    if (gradeMatch) {
      consistentGrade = gradeMatch[1];
    } else {
      // If no grade found yet, fall back to basic ROI-based grading
      const roi = snapshot.cashFlow > 0 ? (snapshot.cashFlow * 12) / snapshot.cashInv * 100 : 0;
      if (roi >= 25) consistentGrade = 'A+';
      else if (roi >= 20) consistentGrade = 'A';
      else if (roi >= 15) consistentGrade = 'B+';
      else if (roi >= 12) consistentGrade = 'B';
      else if (roi >= 8) consistentGrade = 'C+';
      else consistentGrade = 'C';
    }
  } catch (e) {
    const roi = snapshot.cashFlow > 0 ? (snapshot.cashFlow * 12) / snapshot.cashInv * 100 : 0;
    if (roi >= 25) consistentGrade = 'A+';
    else if (roi >= 20) consistentGrade = 'A';
    else if (roi >= 15) consistentGrade = 'B+';
    else if (roi >= 12) consistentGrade = 'B';
    else if (roi >= 8) consistentGrade = 'C+';
    else consistentGrade = 'C';
  }
  
  const marketRating = consistentGrade;
  const marketClass = ["A+", "A"].includes(consistentGrade) ? "good" : 
                     ["B+", "B", "C+"].includes(consistentGrade) ? "warn" : "bad";
  
  $("#marketBenchmark").className = `kpi ${marketClass}`;
  $("#marketRating").textContent = marketRating;
  $("#marketHint").textContent = `${marketScore}/100 points`;
  
  $("#competitiveBenchmark").className = `kpi ${competitive >= 70 ? "good" : competitive >= 50 ? "warn" : "bad"}`;
  $("#compScore").textContent = `${competitive}/100`;
  $("#compHint").textContent = competitive >= 70 ? "Above avg" : competitive >= 50 ? "Average" : "Below avg";
  
  // ---- Risk Assessment Display (aligned with Committee expectations) ----
  // Add lease / structure risk so Risk Assessment matches lender + exit reality
  const leaseYears = +($("#leaseYears").value || 0);
  const leaseRenewal = +($("#leaseRenewal").value || 0);
  const rentEscPct = +($("#rentEscPct").value || 0);
  const camControl = +($("#camControl").value || 0);

  // Loan horizon risk: if lease doesn't cover the debt term, that's a financeability red flag
  const aTerm = +($("#aTerm").value || 0);
  const bTerm = +($("#bTerm").value || 0);
  const maxDebtTerm = Math.max(aTerm, bTerm);

  if (leaseYears > 0 && maxDebtTerm > 0) {
    if (leaseYears < maxDebtTerm) riskFactors += 35;          // typically unfinanceable
    else if (leaseYears < (maxDebtTerm + 5)) riskFactors += 15; // refinance/exit risk
  }
  if (!leaseRenewal) riskFactors += 10;
  if (rentEscPct >= 5) riskFactors += 6;
  if (!camControl) riskFactors += 6;

  // Recompute score after lease adjustments (bounded 0..100)
  riskScore = Math.max(0, Math.min(100, 100 - riskFactors));

  // Reconcile market dominance + probability-weighted outcomes to prevent contradictory grades
  const marketScoreCapped = Math.max(0, Math.min(100, marketScore));
  const competitiveCapped = Math.max(0, Math.min(100, competitive));
  const dominanceScore = (marketScoreCapped + competitiveCapped) / 2;

  // Floor: a market-leading asset should not simultaneously show "F" risk unless downside probability is truly severe
  if (dominanceScore >= 90) riskScore = Math.max(riskScore, 70);      // at least B
  else if (dominanceScore >= 85) riskScore = Math.max(riskScore, 65); // at least C+

  // Floor: if Monte Carlo indicates strong downside protection, keep risk score aligned with reality
  if (mcPositiveNPV !== null && mcTargetROI !== null) {
    if (mcPositiveNPV >= 90 && mcTargetROI >= 90) riskScore = Math.max(riskScore, 75);      // at least B+
    else if (mcPositiveNPV >= 85 && mcTargetROI >= 85) riskScore = Math.max(riskScore, 70); // at least B
  }

  riskScore = Math.max(0, Math.min(100, riskScore));

  // Risk label
  // Risk label + letter grade (kept consistent with deal narrative)
  let riskLabel = (riskScore >= 80) ? "Low" : (riskScore >= 65) ? "Moderate" : (riskScore >= 50) ? "Elevated" : "High";
  let riskGrade = (riskScore >= 90) ? "A" : (riskScore >= 80) ? "B+" : (riskScore >= 70) ? "B" :
                  (riskScore >= 60) ? "C+" : (riskScore >= 50) ? "C" : (riskScore >= 40) ? "D" : "F";

  // Override label for extreme equipment age scenarios
  try {
    const ar = (snapshot && snapshot.ageRisk) ? snapshot.ageRisk : null;
    const a = ar ? ar.avgAge : avgAge;
    const o = ar ? ar.oldest : 0;
    if (a >= 17 || o >= 18) { riskLabel = "Distressed"; riskGrade = "F"; }
    else if (a >= 13) { riskLabel = "Severe"; if (["A","B+","B","C+","C"].includes(riskGrade)) riskGrade = "D"; }
  } catch(e) {}

  // Update label based on Monte Carlo results if available
  if (window.monteCarloResults && window.monteCarloResults.results) {
    const mcStats = window.monteCarloResults.results;
    if (mcStats.probabilities && mcStats.probabilities.targetROI < 50) {
      riskLabel = "High (Monte Carlo confirms)";
      riskGrade = "D";
    } else if (mcStats.probabilities && mcStats.probabilities.targetROI < 70) {
      riskLabel = "Elevated (Monte Carlo)";
      if (["A","B+","B"].includes(riskGrade)) riskGrade = "C+";
    }
  
} else {
  // If Monte Carlo has NOT run yet, volatility should only soften the label (not contradict the numeric score).
  // Use "Moderate" unless the deterministic riskScore is already weak.
  if (revenueVol >= 18 || expenseVol >= 12) {
    if (riskScore < 70) riskLabel = "Elevated (inputs volatile)";
    else if (riskScore < 85) riskLabel = "Moderate (inputs volatile)";
  } else if (revenueVol >= 15 || expenseVol >= 10) {
    if (riskScore < 70) riskLabel = "Moderate (inputs volatile)";
  }
}
const riskClass = (riskScore >= 75) ? "good" : (riskScore >= 55) ? "warn" : "bad";
  $("#riskBenchmark").className = `kpi ${riskClass}`;
  $("#riskScore").textContent = `${riskGrade} ‚Ä¢ ${riskScore}/100`;
  $("#riskHint").textContent = `${riskLabel} risk`;
  
  // Auto-run Monte Carlo for consistent risk assessment
  setTimeout(() => {
    runMonteCarloSim();
  }, 200);
  
  // Detailed benchmark analysis
  $("#benchmarkDetails").innerHTML = `
    <h4>Detailed Market Analysis</h4>
    <div style="font-size:12px; color:#a8c5e9;">
      <strong>Revenue Efficiency:</strong> $${revenuePerSqFt.toFixed(0)}/sq ft/yr ${revenuePerSqFt >= 160 ? "(Excellent)" : revenuePerSqFt >= 140 ? "(Good)" : "(Below Market)"}<br>
      <strong>EBITDA Margin:</strong> ${ebitdaMargin.toFixed(1)}% ${ebitdaMargin >= 40 ? "(Strong)" : ebitdaMargin >= 35 ? "(Adequate)" : "(Weak)"}<br>
      <strong>Equipment Turns:</strong> ${avgTurns.toFixed(1)}/day avg ${avgTurns >= 2.3 ? "(High utilization)" : avgTurns >= 2.0 ? "(Normal)" : "(Low utilization)"}<br>
      <strong>Equipment Age:</strong> ${avgAge.toFixed(1)} years avg ${avgAge <= 4 ? "(Modern)" : avgAge <= 7 ? "(Mature)" : "(Aging)"}<br>
      <strong>Rent Burden:</strong> ${((snapshot.rent/snapshot.grossRevenue)*100).toFixed(1)}% of revenue ${(snapshot.rent/snapshot.grossRevenue) <= 0.2 ? "(Low)" : (snapshot.rent/snapshot.grossRevenue) <= 0.25 ? "(Normal)" : "(High)"}
    </div>
  `;
  
  } catch (error) {
    console.error('Analytics error:', error);
    $("#marketRating").textContent = "Error";
    $("#marketHint").textContent = "Check console";
    $("#compScore").textContent = "Error";
    $("#riskScore").textContent = "Error";
  }
}

// Deal structure optimization
function optimizeDownPayment() {
  const snapshot = calculateSnapshot();
  const projCost = +$("#projCost").value;
  
  let results = "<h4>Down Payment Optimization Analysis</h4>";
  
  // Test different down payment scenarios
  const scenarios = [0.1, 0.15, 0.2, 0.25, 0.3, 0.4, 0.5];
  let bestROI = 0;
  let bestDown = 0;
  
  scenarios.forEach(downPct => {
    const downAmount = projCost * downPct;
    const originalDown = $("#cashInv").value;
    $("#cashInv").value = downAmount;
    
    const testSnapshot = calculateSnapshot();
    if (testSnapshot.cashOnCash > bestROI && testSnapshot.dscr >= 1.25) {
      bestROI = testSnapshot.cashOnCash;
      bestDown = downAmount;
    }
    
    $("#cashInv").value = originalDown; // Restore
  });
  
  results += `
    <div style="font-size:12px; color:#a8c5e9;">
      <strong>Optimal Down Payment:</strong> ${money(bestDown)} (${((bestDown/projCost)*100).toFixed(1)}%)<br>
      <strong>Optimal ROI:</strong> ${bestROI.toFixed(1)}% cash-on-cash<br>
      <strong>Current Down:</strong> ${money(+$("#cashInv").value)} (${((+$("#cashInv").value/projCost)*100).toFixed(1)}%)<br>
      <strong>Current ROI:</strong> ${snapshot.cashOnCash.toFixed(1)}%<br><br>
      ${bestDown !== +$("#cashInv").value ? 
        `<div class="insightbox">üí° Consider adjusting down payment to ${money(bestDown)} for optimal ROI while maintaining DSCR ‚â•1.25</div>` : 
        `<div class="insightbox">‚úÖ Your current down payment is already optimized</div>`}
    </div>
  `;
  
  $("#optimizationResults").innerHTML = results;
}

// Negotiation points analysis
function analyzeNegotiationPoints() {
  const snapshot = calculateSnapshot();
  const projCost = +$("#projCost").value;
  
  let points = [];
  
  // Price negotiation based on industry valuation
  const chuckPostValue = snapshot.ebitda * 12 * 5; // 60x monthly NOI
  if (projCost > chuckPostValue * 1.1) {
    points.push(`üí∞ <strong>Price too high:</strong> Asking ${money(projCost)} vs industry value ${money(chuckPostValue)} (${(((projCost/chuckPostValue-1)*100)).toFixed(1)}% premium)`);
  }
  
  // Seller financing opportunity
  if (snapshot.dscr < 1.5 && (+$("#bPct").value) < 40) {
    points.push(`üè¶ <strong>Seller financing:</strong> Increase seller note to 40-50% to improve DSCR and reduce cash needed`);
  }
  
  // Equipment condition leverage
  const avgAge = [...washerDefs, ...dryerDefs].reduce((sum, eq) => sum + eq.age * eq.count, 0) / 
                 [...washerDefs, ...dryerDefs].reduce((sum, eq) => sum + eq.count, 0);
  if (avgAge > 6) {
    points.push(`üîß <strong>Equipment depreciation:</strong> Average age ${avgAge.toFixed(1)} years - negotiate $${((avgAge - 5) * 5000).toFixed(0)} credit for equipment replacement`);
  }
  
  // Lease terms
  const rentBurden = snapshot.rent / snapshot.grossRevenue;
  if (rentBurden > 0.25) {
    points.push(`üè¢ <strong>High rent burden:</strong> ${(rentBurden*100).toFixed(1)}% of revenue - negotiate rent reduction or longer lease terms`);
  }
  
  // Due diligence findings
  if (snapshot.cashOnCash < 20) {
    points.push(`üìä <strong>Below target ROI:</strong> ${snapshot.cashOnCash.toFixed(1)}% vs 20% target - justify lower price or better terms`);
  }
  
  const results = `
    <h4>Negotiation Leverage Points</h4>
    <div style="font-size:12px; color:#a8c5e9;">
      ${points.length > 0 ? points.map(point => `‚Ä¢ ${point}`).join("<br>") : "‚úÖ Deal appears fairly priced with standard terms"}
    </div>
  `;
  
  $("#optimizationResults").innerHTML = results;
}

// Financing comparison
function compareFinancingOptions() {
  const projCost = +$("#projCost").value;
  const cashInv = +$("#cashInv").value;
  
  // Current structure
  const currentSnapshot = calculateSnapshot();
  
  // Alternative structures
  const structures = [
    { name: "SBA 90/10", aPct: 90, bPct: 0, aRate: 8.5, bRate: 0 },
    { name: "SBA 70/20 + Seller 10", aPct: 70, bPct: 20, aRate: 8.5, bRate: 6.0 },
    { name: "Conventional 80/20", aPct: 80, bPct: 0, aRate: 7.5, bRate: 0 },
    { name: "Owner Finance 50/40", aPct: 50, bPct: 40, aRate: 8.0, bRate: 5.5 }
  ];
  
  let comparison = "<h4>Financing Structure Comparison</h4><table style=`font-size:11px;`><tr><th>Structure</th><th>Cash Down</th><th>Payment</th><th>DSCR</th><th>ROI</th></tr>";
  
  const origA = $("#aPct").value, origB = $("#bPct").value, origAR = $("#aRate").value, origBR = $("#bRate").value;
  
  structures.forEach(struct => {
    $("#aPct").value = struct.aPct;
    $("#bPct").value = struct.bPct;
    $("#aRate").value = struct.aRate;
    $("#bRate").value = struct.bRate;
    
    const newCashDown = Math.max(cashInv, projCost * (1 - (struct.aPct + struct.bPct) / 100));
    $("#cashInv").value = newCashDown;
    
    const testSnapshot = calculateSnapshot();
    const dscrClass = testSnapshot.dscr >= 1.5 ? "good" : testSnapshot.dscr >= 1.25 ? "warn" : "bad";
    const roiClass = testSnapshot.cashOnCash >= 20 ? "good" : testSnapshot.cashOnCash >= 15 ? "warn" : "bad";
    
    comparison += `<tr><td>${struct.name}</td><td>${money(newCashDown)}</td><td>${money(testSnapshot.totalDebtService)}</td><td class="${dscrClass}">${testSnapshot.dscr.toFixed(2)}</td><td class="${roiClass}">${testSnapshot.cashOnCash.toFixed(1)}%</td></tr>`;
  });
  
  // Restore original values
  $("#aPct").value = origA; $("#bPct").value = origB; $("#aRate").value = origAR; $("#bRate").value = origBR; $("#cashInv").value = cashInv;
  
  comparison += "</table>";
  $("#optimizationResults").innerHTML = comparison;
}

// Exit strategy analysis
function analyzeExitScenarios() {
  const snapshot = calculateSnapshot();
  const simulation = runSimulation();
  const exitYear = +$("#exitYear").value;
  const exitCapRate = +$("#exitCapRate").value / 100;
  
  // Project NOI at exit year
  const growthRate = (+$("#revGrowPct").value || 2.5) / 100;
  const inflationRate = (+$("#opexInflPct").value || 3.0) / 100;
  
  const futureRevenue = snapshot.grossRevenue * Math.pow(1 + growthRate, exitYear);
  const futureOpex = (snapshot.totalOpex - snapshot.vendCogs) * Math.pow(1 + inflationRate, exitYear) + snapshot.vendCogs;
  const futureNOI = futureRevenue - futureOpex;
  
  // Exit valuation
  const exitValue = (futureNOI * 12) / exitCapRate;
  const currentValue = snapshot.industryValuation;
  const appreciation = exitValue - currentValue;
  
  // Total return calculation
  const cumulativeCashFlow = simulation.cumulativeCash[exitYear] || simulation.cumulativeCash[simulation.cumulativeCash.length - 1];
  const totalReturn = appreciation + cumulativeCashFlow;
  const annualizedReturn = Math.pow(totalReturn / (+$("#cashInv").value), 1/exitYear) - 1;
  
  // Different exit scenarios
  const scenarios = [
    { name: "Conservative", capRate: exitCapRate + 0.01, desc: "Market cap rates increase" },
    { name: "Base Case", capRate: exitCapRate, desc: "Current market conditions" },
    { name: "Optimistic", capRate: Math.max(0.05, exitCapRate - 0.01), desc: "Market cap rates compress" }
  ];
  
  let analysis = `<h4>Exit Strategy Analysis (Year ${exitYear})</h4>`;
  
  scenarios.forEach(scenario => {
    const scenarioValue = (futureNOI * 12) / scenario.capRate;
    const scenarioGain = scenarioValue - currentValue;
    const scenarioTotal = scenarioGain + cumulativeCashFlow;
    const scenarioReturn = Math.pow(scenarioTotal / (+$("#cashInv").value), 1/exitYear) - 1;
    
    const returnClass = scenarioReturn >= 0.15 ? "good" : scenarioReturn >= 0.10 ? "warn" : "bad";
    
    analysis += `
      <div class="kpi ${returnClass}" style="margin:8px 0;">
        <h4>${scenario.name}</h4>
        <div class="v">${(scenarioReturn * 100).toFixed(1)}%</div>
        <div class="hint">${money(scenarioValue)} exit value</div>
      </div>
    `;
  });
  
  analysis += `
    <div style="font-size:12px; color:#a8c5e9; margin-top:12px;">
      <strong>Projected Year ${exitYear} NOI:</strong> ${money(futureNOI * 12)}/year<br>
      <strong>Current Valuation:</strong> ${money(currentValue)}<br>
      <strong>Required IRR for Success:</strong> >12% annualized<br>
      <strong>Cash Flow Through Year ${exitYear}:</strong> ${money(cumulativeCashFlow)}<br><br>
      ${annualizedReturn >= 0.12 ? 
        `<div class="insightbox">‚úÖ Projected returns exceed 12% IRR threshold</div>` : 
        `<div class="warnbox">‚ö†Ô∏è Projected returns below 12% IRR - consider hold vs. sell strategy</div>`}
    </div>
  `;
  
  $("#exitAnalysis").innerHTML = analysis;
}



/* ====================================
   USER GUIDE + CONTEXT HELP ("?") + COMMITTEE VERDICT
   ==================================== */

const HELP_TEXT = {
  "accountant-final": `Mr. Accountant is the final authority. He considers operating profitability PLUS Mr. Lender (financeability) and Mr. Institutional Buyer (exit & capital risk) before recommending Proceed/Renegotiate/Reject.`,
  "lender-opinion": `Mr. Lender focuses on: DSCR (including stress), lease term vs loan term, and survivability under shocks. A deal can cash flow and still be unfinanceable.`,
  "institutional-opinion": `Mr. Institutional Buyer focuses on exit reality: equipment relevance, market durability, buyer pool depth, and whether capital will be trapped.`,
  "why-what-to-fix": `If the deal is borderline or rejected, this panel lists the specific reasons and the most direct fixes (price, lease, funded retool, reserves, or structure).`,
  // Inputs (a representative but broad set; icons are attached automatically where possible)
  "equipment-age": `Equipment age drives downtime, emergency CAPEX, lender caution, and exit value. Rule of thumb: <7y low risk, 10‚Äì12y high, ‚â•15y distressed unless retooled.`,
  "lease-term": `Lease term must support the loan and your exit horizon. If lease term < loan term, financing is typically rejected.`,
  "monte-carlo": `Monte Carlo shows probability outcomes assuming inputs are correct. It does NOT evaluate lease/exit constraints; use it as informational only.`
};

function showCtxTooltip(text, x, y) {
  const tip = document.getElementById("ctxTooltip");
  if (!tip) return;
  tip.textContent = "";
  // allow simple line breaks
  tip.innerHTML = String(text).replace(/\n/g, "<br>");
  tip.style.display = "block";
  const pad = 12;
  const w = tip.offsetWidth || 320;
  const h = tip.offsetHeight || 120;
  const left = Math.min(window.innerWidth - w - pad, Math.max(pad, x));
  const top  = Math.min(window.innerHeight - h - pad, Math.max(pad, y));
  tip.style.left = left + "px";
  tip.style.top  = top + "px";
}

function hideCtxTooltip() {
  const tip = document.getElementById("ctxTooltip");
  if (tip) tip.style.display = "none";
}

function wireHelpIcons() {
  document.querySelectorAll(".help-icon").forEach(icon => {
    icon.style.display = "inline-flex";
    icon.style.alignItems = "center";
    icon.style.justifyContent = "center";
    icon.style.width = "18px";
    icon.style.height = "18px";
    icon.style.borderRadius = "999px";
    icon.style.border = "1px solid rgba(255,255,255,.25)";
    icon.style.color = "#cfe3ff";
    icon.style.fontWeight = "800";
    icon.style.fontSize = "12px";
    icon.style.cursor = "pointer";
    icon.addEventListener("mouseenter", (e) => {
      const key = icon.dataset.help;
      const text = HELP_TEXT[key] || "No help text configured yet.";
      const r = icon.getBoundingClientRect();
      showCtxTooltip(text, r.left, r.bottom + 8);
    });
    icon.addEventListener("mouseleave", hideCtxTooltip);
    icon.addEventListener("click", (e) => {
      e.preventDefault();
      const key = icon.dataset.help;
      const text = HELP_TEXT[key] || "No help text configured yet.";
      const r = icon.getBoundingClientRect();
      showCtxTooltip(text, r.left, r.bottom + 8);
      setTimeout(hideCtxTooltip, 4200);
    });
  });
}

function wireUserGuide() {
  const openBtn = document.getElementById("openUserGuide");
  const closeBtn = document.getElementById("closeUserGuide");
  const modal = document.getElementById("userGuideModal");
  const back = document.getElementById("userGuideBackdrop");
  const close = () => { if(modal) modal.style.display="none"; if(back) back.style.display="none"; };
  const open = () => { if(modal) modal.style.display="block"; if(back) back.style.display="block"; };

  if (openBtn) openBtn.addEventListener("click", open);
  if (closeBtn) closeBtn.addEventListener("click", close);
  if (back) back.addEventListener("click", close);
}

function attachInputHelpHints() {
  // Best-effort: attach help icons next to labels in .row where input has a known mapping.
  const inputHelpMap = {
    "retoolBudget": "equipment-age",
    "horizon": "monte-carlo",
    "leaseYears": "lease-term",
    "loanTerm": "lease-term"
  };
  Object.entries(inputHelpMap).forEach(([id, helpKey]) => {
    const el = document.getElementById(id);
    if (!el) return;
    const row = el.closest(".row");
    if (!row) return;
    const label = row.querySelector("label");
    if (!label) return;
    if (label.querySelector(".help-icon")) return;
    const span = document.createElement("span");
    span.className = "help-icon";
    span.dataset.help = helpKey;
    span.textContent = "?";
    span.style.marginLeft = "8px";
    label.appendChild(span);
  });
}

function money0(n){ try{return money(n);}catch(e){ return "$" + (Number(n)||0).toFixed(0);} }

function buildLenderOpinion(hz, snapshot) {
  const lease = hz.lease;
  const dscr = hz.stressedDSCR ?? snapshot.dscr ?? 0;
  const shockFail = hz.shock?.broke;
  const lines = [];
  let verdict = "FINANCEABLE";
  if (lease.leaseYears < lease.loanTerm) {
    verdict = "REJECT";
    lines.push(`‚ùå Lease term (${lease.leaseYears}y) is shorter than loan term (${lease.loanTerm}y). Bankable structure fails.`);
  } else {
    lines.push(`‚úÖ Lease term supports debt horizon (${lease.leaseYears}y vs ${lease.loanTerm}y).`);
  }

  if (dscr < 1.0) {
    verdict = "REJECT";
    lines.push(`‚ùå Stressed DSCR ${dscr.toFixed(2)} < 1.00. Under reasonable stress, debt service fails.`);
  } else if (dscr < 1.25) {
    verdict = (verdict==="REJECT") ? "REJECT" : "CAUTION";
    lines.push(`‚ö†Ô∏è Stressed DSCR ${dscr.toFixed(2)} is below typical comfort (~1.25). Expect higher equity/reserves.`);
  } else {
    lines.push(`‚úÖ Stressed DSCR ${dscr.toFixed(2)} is within bankable range.`);
  }

  if (shockFail) {
    verdict = "REJECT";
    lines.push(`‚ùå CapEx shock test FAIL: a realistic replacement event breaks survivability. Lender likely declines or escrows retool.`);
  } else {
    lines.push(`‚úÖ CapEx shock test PASS: survivability under replacement shock is acceptable.`);
  }

  if (hz.age?.label === "SEVERE" || hz.age?.label === "DISTRESSED") {
    verdict = (verdict==="REJECT") ? "REJECT" : "CAUTION";
    lines.push(`‚ö†Ô∏è Equipment condition (${hz.age.label}) increases collateral risk. Expect holdbacks, escrow, or pricing adjustment.`);
  }

  lines.unshift(`üè¶ Verdict: ${verdict}`);
  return lines.join("\n");
}

function buildInstitutionalOpinion(hz) {
  const lines = [];
  let verdict = hz.label === "HERO" ? "BUYABLE" : hz.label === "BORDERLINE" ? "CONDITIONAL" : "NO-GO";
  const exit = hz.exit || {};
  const exitCount = [exit.sba, exit.operator, exit.investor, exit.aggregator].filter(Boolean).length;

  lines.push(`üèõÔ∏è Verdict: ${verdict}`);
  if (hz.label === "HERO") {
    lines.push(`‚úÖ Meets acquisition standards: durable demand + reasonable condition + viable exit paths.`);
  } else if (hz.label === "BORDERLINE") {
    lines.push(`‚ö†Ô∏è Mixed asset quality: buyable only at the right basis (price) and/or with funded modernization.`);
  } else {
    lines.push(`‚ùå Capital-trap risk: at current terms this does not meet institutional standards.`);
  }

  lines.push(`Exit buyer fit: ${exitCount}/4 (SBA:${exit.sba?"‚úì":"‚úó"}, Operator:${exit.operator?"‚úì":"‚úó"}, Investor:${exit.investor?"‚úì":"‚úó"}, Aggregator:${exit.aggregator?"‚úì":"‚úó"})`);
  lines.push(`Equipment: Avg ${hz.age.avgAge.toFixed(1)}y (max ${hz.age.maxAge}y) ‚Üí ${hz.age.label}`);
  lines.push(`Market: Competition ${hz.comp.label} (CSI ${hz.comp.csi.toFixed(2)}), Location elasticity ${(hz.loc.score*100).toFixed(0)}/100`);

  if (hz.comp.label === "Oversupplied") lines.push(`‚ö†Ô∏è Oversupplied trade area compresses long-run revenue durability and exit multiple.`);
  if (hz.loc.score < 0.45) lines.push(`‚ö†Ô∏è Low pricing power/location elasticity reduces resilience in downturns.`);
  if (hz.revQ.stickiness < 0.45) lines.push(`‚ö†Ô∏è Low revenue stickiness increases churn and compresses exit valuation.`);
  if (hz.owner.dep >= 6) lines.push(`‚ö†Ô∏è Owner dependency is high; institutional buyers discount operations that require an owner-operator.`);

  return lines.join("\n");
}

function buildAccountantSynthesis(hz, snapshot, simulation) {
  const lines = [];
  // Operating view
  const margin = snapshot.ebitdaMargin ?? (snapshot.ebitda / Math.max(1, snapshot.grossRevenue));
  const coc = snapshot.cashOnCash ?? 0;
  const baseDSCR = snapshot.dscr ?? 0;

  // snapshot.cashOnCash is already a percentage (e.g., 66.65), so format directly without multiplying by 100
  lines.push(`Operating view: EBITDA ${money0(snapshot.ebitda)} (${(margin*100).toFixed(1)}% margin), Cash-on-cash ${coc.toFixed(1)}%, Base DSCR ${baseDSCR.toFixed(2)}.`);

  // Consider Lender + Institutional
  const lenderReject = hz.dealKillers?.some(x => x.toLowerCase().includes("lease term") || x.toLowerCase().includes("dscr") || x.toLowerCase().includes("capex shock"));
  const instReject = hz.label === "ZERO";
  const dealKillers = hz.dealKillers || [];

  // Final recommendation logic
  let rec = "PROCEED";
  if ((snapshot.ebitda ?? 0) <= 0 || margin < 0.12) rec = "REJECT";
  if (lenderReject) rec = "REJECT OR RESTRUCTURE";
  if (!lenderReject && instReject) rec = "REJECT AT CURRENT PRICE";
  if (!lenderReject && hz.label === "BORDERLINE") rec = "RENEGOTIATE / RESTRUCTURE";

  // Narrative that explicitly references advisors
  lines.push(`Considering Mr. Lender: ${lenderReject ? "financeability is constrained." : "financing appears feasible under standard terms."}`);
  lines.push(`Considering Mr. Institutional Buyer: ${hz.label === "HERO" ? "exit viability is strong." : hz.label === "BORDERLINE" ? "exit is conditional at the right basis." : "exit viability fails at current terms."}`);

  // Call out old machines / lease mismatch explicitly
  if (hz.age.label === "SEVERE" || hz.age.label === "DISTRESSED") {
    lines.push(`‚ö†Ô∏è Machines are old (${hz.age.label}). Treat this as a modernization deal, not a stable cash cow.`);
  } else if (hz.age.label === "LOW") {
    lines.push(`‚úÖ Equipment condition is favorable; returns are more durable and lender/exit risk is reduced.`);
  }

  if (hz.lease.leaseYears < hz.lease.loanTerm) {
    lines.push(`‚ùå Lease does not make sense: ${hz.lease.leaseYears}y remaining vs ${hz.lease.loanTerm}y loan term.`);
  }

  lines.push(`FINAL RECOMMENDATION: ${rec}`);
  return { rec, text: lines.join("\n") };
}

function buildWhyFix(hz, snapshot) {
  const lines = [];
  const killers = hz.dealKillers || [];
  if (killers.length) {
    lines.push("Why the deal is failing:");
    killers.forEach(k => lines.push("‚Ä¢ " + k));
  } else {
    lines.push("No hard deal-killers detected.");
  }

  lines.push("\nWhat to fix (highest leverage):");
  // Fix suggestions
  if (hz.lease.leaseYears < hz.lease.loanTerm) lines.push("‚Ä¢ Secure a longer lease (or more guaranteed options) so lease term ‚â• loan term.");
  if ((hz.stressedDSCR ?? 0) < 1.25) lines.push("‚Ä¢ Improve DSCR: lower price, increase equity, reduce debt, or increase verified NOI.");
  if (hz.age.avgAge >= 15) lines.push("‚Ä¢ Fund modernization/retool at closing (escrow/reserve) to reduce downtime + exit discount.");
  if (hz.shock?.broke) lines.push("‚Ä¢ Add a replacement reserve or reduce leverage so a 30% washer replacement event doesn‚Äôt break cash survivability.");
  if (!(hz.exit?.sba || hz.exit?.operator || hz.exit?.investor || hz.exit?.aggregator)) lines.push("‚Ä¢ Fix exit: improve equipment/tech, market positioning, or price basis to appeal to at least one buyer class.");
  if (hz.comp?.label === "Oversupplied") lines.push("‚Ä¢ Re-check trade area: oversupply requires a lower basis or differentiated revenue (W&F/commercial/app).");
  if (hz.revQ?.stickiness < 0.5) lines.push("‚Ä¢ Increase sticky revenue: card/app, W&F, commercial accounts, subscriptions.");

  // Price-to-fix (simple guidance)
  if (killers.length) {
    lines.push("\nNegotiation anchor:");
    lines.push("‚Ä¢ If seller won‚Äôt fix structure (lease/retool), price must drop enough to fund fixes with a margin of safety.");
  }
  return lines.join("\n");
}

function renderCommitteeVerdict(hz, snapshot, simulation) {
  const lender = buildLenderOpinion(hz, snapshot);
  const inst = buildInstitutionalOpinion(hz);
  const acct = buildAccountantSynthesis(hz, snapshot, simulation);
  const whyFix = buildWhyFix(hz, snapshot);

  const lenderEl = document.getElementById("lenderOpinion");
  const instEl = document.getElementById("instOpinion");
  const acctEl = document.getElementById("acctFinal");
  const whyEl = document.getElementById("whyFix");

  if (lenderEl) lenderEl.textContent = lender;
  if (instEl) instEl.textContent = inst;
  if (acctEl) acctEl.textContent = acct.text;
  if (whyEl) whyEl.textContent = whyFix;
}

// Wire UI helpers
document.addEventListener("DOMContentLoaded", () => {
  wireUserGuide();
  attachInputHelpHints();
  wireHelpIcons();

  // hide tooltip on scroll/tap outside
  document.addEventListener("scroll", hideCtxTooltip, {passive:true});
  document.addEventListener("click", (e) => {
    const t = e.target;
    if (!(t && t.classList && t.classList.contains("help-icon"))) hideCtxTooltip();
  });
});

</script>
<!-- ===== San Diego Market Intelligence (Drop-in) ===== -->
<div id="mi_container"></div>

<script>
(function(){
  // ---------- tiny loader helpers ----------
  function loadScriptOnce(src, testFn){
    return new Promise((resolve, reject)=>{
      if (testFn && testFn()) return resolve();
      const s = document.createElement('script');
      s.src = src; s.async = true;
      s.onload = resolve; s.onerror = reject;
      document.head.appendChild(s);
    });
  }
  function loadCSSOnce(href){
    if ([...document.styleSheets].some(ss => ss.href && ss.href.includes(href))) return;
    const l = document.createElement('link'); l.rel='stylesheet'; l.href=href;
    document.head.appendChild(l);
  }

  // ---------- inject required CDNs (Papa Parse + Leaflet) ----------
  loadCSSOnce('https://unpkg.com/leaflet@1.9.4/dist/leaflet.css');

  const libs = Promise.all([
    loadScriptOnce('https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js', ()=>window.Papa),
    loadScriptOnce('https://unpkg.com/leaflet@1.9.4/dist/leaflet.js', ()=>window.L)
  ]);

  // ---------- build the UI markup ----------
  const html = `
  <section class="card" id="mi_section" style="margin-top:14px">
    <h2>San Diego Market Intelligence</h2>

    <div class="group">
      <h3>Upload Business Data</h3>
      <div class="sub">Upload San Diego active business CSV files (e.g., <em>tr_active1.csv</em> & <em>tr_active2.csv</em>).</div>
      <input id="mi_csv" type="file" accept=".csv" multiple />
      <div class="market-stats" id="mi_stats" style="display:none">
        <div class="stat-box"><div class="stat-value" id="mi_total">0</div><div class="stat-label">Total Businesses</div></div>
        <div class="stat-box"><div class="stat-value" id="mi_lm">0</div><div class="stat-label">Laundromats</div></div>
        <div class="stat-box"><div class="stat-value" id="mi_avg">0</div><div class="stat-label">Avg per ZIP</div></div>
      </div>
    </div>

    <div class="group" id="mi_analysis" style="display:none">
      <h3>Competitor Analysis</h3>
      <div class="sub">Filter by ZIP code to see local market density</div>
      <div class="row">
        <label for="mi_zip">Focus ZIP Code</label>
        <select id="mi_zip"><option value="">All San Diego</option></select>
      </div>
      <div id="mi_insight" class="warnbox">Select a ZIP code to see competitor density and market insights.</div>
    </div>

    <div class="group">
      <h3>Market Map</h3>
      <div class="sub">Markers show laundromat/dry cleaning locations. Click for details.</div>
      <div id="mi_map" style="height:400px; border:1px solid #22345a; border-radius:14px"></div>
      <div class="btns">
        <button onclick="MI_center()">Center on San Diego</button>
        <button onclick="MI_clear()">Clear Markers</button>
      </div>
    </div>

    <div class="group" id="mi_results" style="display:none">
      <h3>Market Intelligence Summary</h3>
      <div id="mi_summary"></div>
    </div>
  </section>
  `;
  document.getElementById('mi_container').innerHTML = html;

  // ---------- scoped state & helpers ----------
  let MI_business = [];
  let MI_laundry = [];
  let MI_map, MI_markers = [];

  const mi$ = id => document.getElementById(id);
  const money = n => '$' + (Number(n)||0).toLocaleString();

  // ZIP -> centroid
  const MI_ZIP = {
    '92101':[32.7157,-117.1611],'92102':[32.7081,-117.1370],'92103':[32.7344,-117.1661],
    '92104':[32.7081,-117.1370],'92105':[32.6722,-117.1197],'92106':[32.7344,-117.1925],
    '92107':[32.7556,-117.2506],'92108':[32.7678,-117.1344],'92109':[32.7814,-117.2089],
    '92110':[32.7564,-117.1978],'92111':[32.8031,-117.1564],'92113':[32.6822,-117.1156],
    '92114':[32.6700,-117.0864],'92115':[32.7372,-117.0931],'92116':[32.7331,-117.1431],
    '92117':[32.8203,-117.1531],'92120':[32.7839,-117.0742],'92121':[32.8853,-117.2092],
    '92122':[32.8497,-117.2072],'92123':[32.8186,-117.1342],'92124':[32.7772,-117.0406],
    '92126':[32.8889,-117.1547],'92127':[32.9589,-117.0889],'92128':[32.9289,-117.0544],
    '92129':[32.9253,-117.1369],'92130':[32.9394,-117.1906],'92131':[32.8853,-117.1481],
    '92154':[32.5689,-117.1331],'92173':[32.5589,-117.1031]
  };

  // ---------- main logic (runs after libs load) ----------
  libs.then(()=>{
    // init map
    MI_map = L.map('mi_map').setView([32.72, -117.16], 11);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
      attribution:'¬© OpenStreetMap contributors'
    }).addTo(MI_map);

    // handlers
    mi$('mi_csv').addEventListener('change', MI_handleUpload);
    mi$('mi_zip').addEventListener('change', MI_filterZip);
  });

  // ---------- functions (namespaced global for button onclicks) ----------
  window.MI_center = function(){ if (MI_map) MI_map.setView([32.72,-117.16],11); };
  window.MI_clear  = function(){ MI_markers.forEach(m=>MI_map.removeLayer(m)); MI_markers=[]; };

  function MI_handleUpload(e){
    const files = Array.from(e.target.files||[]);
    if (!files.length) return;
    MI_business = [];
    let done = 0;

    files.forEach(file=>{
      Papa.parse(file,{
        header:true,
        complete: res=>{
          MI_business = MI_business.concat(res.data||[]);
          if (++done === files.length) MI_process();
        },
        error: err=>console.error('CSV error:', err)
      });
    });
  }

  function MI_process(){
    const NAICS = ['812310','812320','812331','812332'];
    const KEY = ['LAUNDR','DRY CLEAN','COIN OP','WASH'];

    MI_laundry = MI_business.filter(b=>{
      const naics = (b.NAICS||'').toString().trim();
      const activity = (b['ACTIVITY DESC']||'').toUpperCase();
      const name = (b['DBA NAME']||'').toUpperCase();
      if (NAICS.includes(naics)) return true;
      return KEY.some(k=>activity.includes(k) || name.includes(k));
    });

    // stats
    mi$('mi_stats').style.display = 'grid';
    mi$('mi_total').textContent = (MI_business.length).toLocaleString();
    mi$('mi_lm').textContent = MI_laundry.length;

    const zipCounts = {};
    MI_laundry.forEach(b=>{
      const z = (b.ZIP||'').toString().substring(0,5);
      if (z) zipCounts[z] = (zipCounts[z]||0)+1;
    });
    const zips = Object.keys(zipCounts).sort();
    const avg = zips.length ? (MI_laundry.length / zips.length).toFixed(1) : 0;
    mi$('mi_avg').textContent = avg;

    // zip dropdown
    const sel = mi$('mi_zip');
    sel.innerHTML = '<option value="">All San Diego</option>' + 
      zips.map(z=>`<option value="${z}">${z} (${zipCounts[z]} laundromats)</option>`).join('');

    mi$('mi_analysis').style.display = 'block';
    mi$('mi_results').style.display = 'block';

    // map markers + summary
    MI_addMarkers();
    MI_summary();
  }

  function MI_addMarkers(){
    MI_clear();
    MI_laundry.forEach(b=>{
      const zip = (b.ZIP||'').toString().substring(0,5);
      const c = MI_ZIP[zip];
      if (!c) return;
      const lat = c[0] + (Math.random()-0.5)*0.01;
      const lng = c[1] + (Math.random()-0.5)*0.01;
      const m = L.marker([lat,lng]).addTo(MI_map);
      m.bindPopup(`
        <div style="font-size:12px;max-width:220px">
          <strong>${b['DBA NAME'] || 'N/A'}</strong><br>
          <em>${b['ACTIVITY DESC'] || 'N/A'}</em><br>
          ${b.ADDRESS || 'N/A'}<br>
          ${b.CITY || 'N/A'}, ${b.ZIP || 'N/A'}<br>
          NAICS: ${b.NAICS || 'N/A'}
        </div>
      `);
      MI_markers.push(m);
    });
  }

  function MI_summary(){
    const total = MI_laundry.length;
    const zipSet = new Set(MI_laundry.map(b => (b.ZIP||'').toString().substring(0,5)).filter(Boolean));
    const avg = zipSet.size ? (total/zipSet.size).toFixed(1) : 0;
    let html = `
      <div class="accuracy-note">
        <strong>San Diego Laundromat Market Analysis</strong><br>
        ‚Ä¢ Total Laundromats: ${total}<br>
        ‚Ä¢ ZIP Codes Covered: ${zipSet.size}<br>
        ‚Ä¢ Average Density: ${avg} laundromats per ZIP<br>
        ‚Ä¢ Market Saturation: ${total>200?'High': total>100?'Moderate':'Low'}
      </div>`;
    if (total>0){
      html += `
        <div class="insightbox" style="margin-top:8px">
          Use the map to identify underserved areas.
          ZIP codes with fewer than 2 laundromats may present opportunities.
          Consider a 0.5‚Äì1 mile radius for true competition assessment.
        </div>`;
    }
    mi$('mi_summary').innerHTML = html;
  }

  function MI_filterZip(){
    const z = mi$('mi_zip').value;
    if (!z) return;
    const list = MI_laundry.filter(b => (b.ZIP||'').toString().startsWith(z));
    const d = list.length;
    let msg = '';
    if (d===0) msg = `üü¢ OPPORTUNITY: No laundromats found in ${z}.`;
    else if (d<=2) msg = `üü° LOW COMPETITION: ${d} laundromat(s) in ${z}.`;
    else if (d<=5) msg = `üü† MODERATE COMPETITION: ${d} in ${z}.`;
    else msg = `üî¥ HIGH COMPETITION: ${d} in ${z}.`;
    const box = mi$('mi_insight');
    box.innerHTML = msg;
    box.className = d<=2 ? 'insightbox' : 'warnbox';
  }
})();
</script>
<!-- ===== End Market Intelligence (Drop-in) ===== -->



<script>
// ===== Auto Market (US) ‚Äî ZIP/City/State via Census API (NO Geocoder needed) =====
// Fixes:
// - Do NOT claim "CORS blocked/file://" unless we are actually on file://
// - Show the failing URL + HTTP status + browser error for debugging
// - Graceful fallback if CBP (competition proxy) is suppressed/unavailable
(function(){
  const STATE_FIPS = {
    AL:"01", AK:"02", AZ:"04", AR:"05", CA:"06", CO:"08", CT:"09", DE:"10", DC:"11",
    FL:"12", GA:"13", HI:"15", ID:"16", IL:"17", IN:"18", IA:"19", KS:"20", KY:"21",
    LA:"22", ME:"23", MD:"24", MA:"25", MI:"26", MN:"27", MS:"28", MO:"29", MT:"30",
    NE:"31", NV:"32", NH:"33", NJ:"34", NM:"35", NY:"36", NC:"37", ND:"38", OH:"39",
    OK:"40", OR:"41", PA:"42", RI:"44", SC:"45", SD:"46", TN:"47", TX:"48", UT:"49",
    VT:"50", VA:"51", WA:"53", WV:"54", WI:"55", WY:"56", PR:"72"
  };

  const $ = (id) => document.getElementById(id);

  function setAutoStatus(msg, ok=true){
    const el = $("autoMarketStatus");
    if (!el) return;
    el.textContent = msg;
    el.style.color = ok ? "#93c5fd" : "#fca5a5";
  }
  function setAutoProgress(pct, step){
    const bar = $("autoMarketBar");
    const stepEl = $("autoMarketStep");
    if (bar) bar.style.width = `${Math.max(0, Math.min(100, pct))}%`;
    if (stepEl) stepEl.textContent = step || "";
  }
  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function isLikelyCanadaPostal(code){
    return /^[A-Za-z]\d[A-Za-z]\s?\d[A-Za-z]\d$/.test((code||"").trim());
  }
  function normalizeName(s){
    return (s||"")
      .toLowerCase()
      .replace(/\b(city|town|village|cdp|borough|municipality)\b/g, "")
      .replace(/[^a-z0-9]+/g, " ")
      .trim();
  }

  async function fetchJson(url){
    // Important: if your environment blocks these domains, this will throw TypeError: Failed to fetch
    let r;
    try{
      r = await fetch(url, { cache: "no-store" });
    } catch(err){
      // Network-level failure (CORS, blocked, offline, DNS, etc.)
      const proto = (location && location.protocol) ? location.protocol : "";
      const hint = (proto === "file:") ? "Open via Live Server / http://localhost (not file://)." :
                   "This is usually blocked by VPN/firewall/adblock or a browser privacy setting. Try turning off VPN/adblock or use another network.";
      const msg = `Network error while fetching: ${url}\n${(err && err.message) ? err.message : String(err)}\nHint: ${hint}`;
      const e2 = new Error(msg);
      e2.__url = url;
      e2.__net = true;
      throw e2;
    }
    if (!r.ok){
      const txt = await r.text().catch(()=> "");
      const msg = `HTTP ${r.status} ${r.statusText} for ${url}${txt ? `\nBody: ${txt.slice(0,200)}‚Ä¶` : ""}`;
      const e2 = new Error(msg);
      e2.__url = url;
      e2.__http = r.status;
      throw e2;
    }
    return await r.json();
  }

  async function resolvePlaceFips(city, stateFips, acsYear){
    const url = `https://api.census.gov/data/${acsYear}/acs/acs5/profile?get=NAME&for=place:*&in=state:${stateFips}`;
    const data = await fetchJson(url);
    const hdr = data[0];
    const nameIdx = hdr.indexOf("NAME");
    const placeIdx = hdr.indexOf("place");
    const normTarget = normalizeName(city);

    let best = null;
    for (let i=1;i<data.length;i++){
      const row = data[i];
      const nm = row[nameIdx] || "";
      const place = row[placeIdx];
      const norm = normalizeName(nm);
      if (!place) continue;

      if (norm === normTarget){
        best = { place, name: nm, score: 100 };
        break;
      }
      if (norm.includes(normTarget) || normTarget.includes(norm)){
        const score = 60 - Math.min(25, Math.abs(norm.length - normTarget.length));
        if (!best || score > best.score) best = { place, name: nm, score };
      }
    }
    return best; // may be null
  }

  async function autoFillUSMarket(){
    try{
      setAutoProgress(0,"Idle");
      setAutoStatus("Starting‚Ä¶", true);
      setAutoProgress(5,"Validating inputs");

      const city = (($("autoCity")?.value)||"").trim();
      const state = (($("autoState")?.value)||"").trim().toUpperCase();
      const zip = (($("autoZip")?.value)||"").trim();

      if (isLikelyCanadaPostal(zip)){
        setAutoProgress(0,"Idle");
        setAutoStatus("Canada postal code detected. Auto-fill supports U.S. Census only (for now).", false);
        return;
      }
      if (!zip || zip.length < 5){
        setAutoProgress(0,"Idle");
        setAutoStatus("Enter a valid 5-digit U.S. ZIP Code.", false);
        return;
      }
      if (!state || state.length !== 2 || !STATE_FIPS[state]){
        setAutoProgress(0,"Idle");
        setAutoStatus("Enter a valid 2-letter U.S. state (e.g., CA).", false);
        return;
      }

      // If user is still on file://, be explicit early.
      if (location && location.protocol === "file:"){
        setAutoProgress(0,"Failed");
        setAutoStatus("Auto-fill blocked: you opened this file directly (file://). Use Live Server so the URL starts with http://127.0.0.1 or http://localhost.", false);
        return;
      }

      const acsYear = 2022;
      const cbpYear = 2022;
      const stateFips = STATE_FIPS[state];

      // 1) ACS ZIP profile (ZCTA)
      setAutoProgress(20,"Fetching ACS ZIP profile");
      const zcta = zip.substring(0,5);
      const acsZipUrl = `https://api.census.gov/data/${acsYear}/acs/acs5/profile?get=DP04_0047PE,DP04_0001E,DP04_0134E&for=zip%20code%20tabulation%20area:${zcta}`;
      const acsZip = await fetchJson(acsZipUrl);
      const hz = acsZip[0], rz = acsZip[1];
      const z = (k)=>rz[hz.indexOf(k)];
      const renterPct = parseFloat(z("DP04_0047PE"));
      const occUnits = parseFloat(z("DP04_0001E"));
      const medGrossRent = parseFloat(z("DP04_0134E"));
      if (!isFinite(renterPct) || !isFinite(occUnits)) throw new Error("ACS ZIP response missing renter% or occupied units.");
      const renterHH = Math.round(occUnits * (renterPct/100));

      // 2) Resolve PLACE FIPS (optional)
      let placeInfo = null;
      if (city){
        setAutoProgress(40,"Resolving city to Census PLACE code");
        placeInfo = await resolvePlaceFips(city, stateFips, acsYear);
      }

      // 3) Pull population (PLACE if found)
      let pop = NaN;
      let placeName = "";
      let placeFips = "";
      if (placeInfo && placeInfo.place){
        placeFips = placeInfo.place;
        placeName = placeInfo.name;
        setAutoProgress(60,"Fetching ACS city population");
        const acsPlaceUrl = `https://api.census.gov/data/${acsYear}/acs/acs5/profile?get=DP05_0001E&for=place:${placeFips}&in=state:${stateFips}`;
        const ap = await fetchJson(acsPlaceUrl);
        const hp = ap[0], rp = ap[1];
        pop = parseFloat(rp[hp.indexOf("DP05_0001E")]);
      }

      // 4) CBP laundromat establishments (optional; often suppressed at small geos)
      setAutoProgress(80,"Fetching CBP laundromat establishments (optional)");
      let estab = NaN;
      let cbpSuppressed = false;
      try{
        if (placeFips){
          const cbpPlaceUrl = `https://api.census.gov/data/${cbpYear}/cbp?get=ESTAB&for=place:${placeFips}&in=state:${stateFips}&NAICS2017=812310`;
          const cbp = await fetchJson(cbpPlaceUrl);
          const hb = cbp[0], rb = cbp[1];
          const v = rb[hb.indexOf("ESTAB")];
          estab = parseFloat(v);
          if (!isFinite(estab)) cbpSuppressed = true;
        } else {
          const cbpStateUrl = `https://api.census.gov/data/${cbpYear}/cbp?get=ESTAB&for=state:${stateFips}&NAICS2017=812310`;
          const cbp = await fetchJson(cbpStateUrl);
          const hb = cbp[0], rb = cbp[1];
          estab = parseFloat(rb[hb.indexOf("ESTAB")]);
          if (!isFinite(estab)) cbpSuppressed = true;
        }
      } catch(e){
        cbpSuppressed = true;
        console.warn("CBP fetch failed (non-fatal):", e);
      }

      setAutoProgress(90,"Applying results");

      const renterScore = clamp(Math.round(renterPct/10), 0, 10);
      const pricingPower = isFinite(medGrossRent) ? clamp(Math.round((medGrossRent - 800)/200) + 5, 0, 10) : 5;
      const scale = isFinite(pop) ? clamp((Math.log10(pop+1)-3.5)*2.5, 0, 5) : 2.5;
      const locElastic = clamp(Math.round((renterScore*0.6) + (pricingPower*0.25) + (scale*1.2)), 0, 10);

      let competitors = parseFloat(($("competitors")?.value)||"0") || 0;
      if (isFinite(estab) && isFinite(pop) && pop > 0){
        const per10k = estab / (pop/10000);
        const tradePop = renterHH * 2.5;
        competitors = clamp(Math.round(per10k * (tradePop/10000)), 0, 50);
      } else if (isFinite(estab) && !isFinite(pop)) {
        competitors = clamp(Math.round(estab * 0.02), 0, 50);
      } // else keep existing input

      if ($("renterScore")) $("renterScore").value = renterScore;
      if ($("renterHH")) $("renterHH").value = renterHH;
      if ($("pricingPower")) $("pricingPower").value = pricingPower;
      if ($("locElastic")) $("locElastic").value = locElastic;
      if ($("competitors")) $("competitors").value = competitors;

      const cn = $("constraintNote");
      if (cn){
        const where = placeName ? `${placeName}` : `${state} (place not resolved)`;
        const estabTxt = (isFinite(estab) ? estab.toFixed(0) : (cbpSuppressed ? "suppressed/unavailable" : "?"));
        cn.innerHTML =
          `Auto Market (US): ZIP ${zcta} + ${city?city+", ":""}${state} ‚Üí ${where}. `
          + `Renter% ${renterPct.toFixed(1)} (score ${renterScore}/10), `
          + `Renter HH ~${renterHH.toLocaleString()}, `
          + `Median gross rent ~$${isFinite(medGrossRent)?medGrossRent.toFixed(0):"?"} (pricing ${pricingPower}/10), `
          + `CBP estab ${estabTxt} ‚Üí competitors ~${competitors}.`;
      }

      setAutoProgress(100,"Completed");
      setAutoStatus(`Completed: ${city?city+", ":""}${state} ${zcta}.`, true);

      if (typeof window.deferredCompute === "function") window.deferredCompute();
      else if (typeof deferredCompute === "function") deferredCompute();
    } catch(e){
      const msg = (e && (e.message || e.toString())) || String(e);
      setAutoProgress(0,"Failed");

      // Only show the "file://" hint if that's actually the protocol.
      if (location && location.protocol === "file:"){
        setAutoStatus("Auto-fill blocked: open via Live Server so the URL starts with http://127.0.0.1 or http://localhost.", false);
      } else {
        setAutoStatus(`Auto-fill failed:\n${msg}`, false);
      }
      console.error(e);
    }
  }

  window.autoFillUSMarket = autoFillUSMarket;
})();
</script>


</body>
</html>